<properties linkid="develop-mobile-tutorials-upload-blob-data-dotnet" urlDisplayName="Upload images by using Mobile Services" pageTitle="Upload images to Windows Azure Storage by using Mobile Services" metaKeywords="" metaDescription="Learn how to use Mobile Services to upload images to Windows Azure Storage." metaCanonical="" disqusComments="0" umbracoNaviHide="1" />

<div class="umbMacroHolder" title="This is rendered content from macro" onresizestart="return false;" umbpageid="14799" ismacro="true" umb_chunkname="article-left-menu-windows-store" umb_chunkpath="devcenter/mobile" umb_macroalias="AzureChunkDisplayer" umb_hide="0" umb_modaltrigger="" umb_chunkurl="" umb_modalpopup="0"><!-- startUmbMacro --><span><strong>Azure Chunk Displayer</strong><br />No macro content available for WYSIWYG editing</span><!-- endUmbMacro --></div>

# Upload images to Windows Azure Storage by using Mobile Services
<div class="dev-center-tutorial-selector"> 
	<a href="/en-us/develop/mobile/tutorials/upload-blob-data-dotnet" title="Windows Store C#" class="current">Windows Store C#</a>
<!--    <a href="/en-us/develop/mobile/tutorials/upload-blob-data-js" title="Windows Store JavaScript">Windows Store JavaScript</a>
	<a href="/en-us/develop/mobile/tutorials/upload-blob-data-wp8" title="Windows Phone 8">Windows Phone 8</a>
	<a href="/en-us/develop/mobile/tutorials/upload-blob-data-ios" title="iOS">iOS</a> 
-->
</div>	


This topic shows you how to use Windows Azure Mobile Services to enable your app to upload and store user-generated images in Windows Azure Storage. Mobile Services uses a SQL Database to store data. However, binary large object (BLOB) data is more efficiently stored in Windows Azure Blob storage service. In this tutorial you add functionality to the Mobile Services quickstart app to take pictures and upload the images to Windows Azure by using a Shared Access Signature (SAS) generated by Mobile Services. 

This tutorial walks you through the following basic steps to update the Mobile Services quickstart to upload images to the Blob Storage service:

1. [Install the Storage Client library]
2. [Update the insert script to generate an SAS]
3. [Update the client app to capture images]
4. [Upload images to test the app]

This tutorial requires the following:

+ Microsoft Visual Studio 2012 Express for Windows 8 RC, or a later version
+ [Windows Azure Storage account][How To Create a Storage Account]
+ [Windows Azure Storage Client library for Windows Store apps] (CTP)
+ A camera or other image capture device attached to your computer.

This tutorial is based on the Mobile Services quickstart. Before you start this tutorial, you must first complete [Get started with Mobile Services]. 

<h2><a name="install-storage-client"></a><span class="short-header">Install Storage client</span>Install the Storage client for Windows Store apps</h2>

To be able to use an SAS to upload images to Blob storage, you must first install the Storage client library for Windows Store apps and add a reference to your project.

1. Download the [Storage client library for Windows Store apps][Windows Azure Storage Client library for Windows Store apps] and extract the files to your local computer.

2. In the **Project** menu in Visual Studio, click **Add Reference**, and then click **Browse**. 

  ![][1]

3. Browse to the location of the extracted library files, click the `Microsoft.WindowsAzure.Storage.winmd` file, click **Add**, then click **OK**. 

  This adds a reference to the Storage client library to the project.

Next, you will update the quickstart app to capture and upload images.

<h2><a name="update-scripts"></a><span class="short-header">Update the insert script</span>Update the registered insert script in the Management Portal</h2>

A new insert script is registered that generates an SAS when a new Todo item is inserted.

1. In the Management Portal, click the **Data** tab and then click the **TodoItem** table. 

   ![][2]

2. In **todoitem**, click the **Script** tab and select **Insert**.
   
  ![][3]

   This displays the function that is invoked when an insert occurs in the **TodoItem** table.

3. Replace the insert function with the following code, and then click **Save**:

		var azure = require('azure');
		var qs = require('querystring');

		function insert(item, user, request) {
			var accountName = '<storage-account-name>';
			var accountKey = '<storage-account-key>';
			var host = accountName + '.blob.core.windows.net';
			var canonicalizedResource = '/' + item.containerName + '/' + item.resourceName;

			if (item.containerName !== undefined) {
				// Set the BLOB store container name on the item, which must be lowercase.
				item.containerName = item.containerName.toLowerCase();

				// If it does not already exist, create the container 
				// with public read access for blobs.        
				var blobService = azure.createBlobService(accountName, accountKey, host);
				blobService.createContainerIfNotExists(item.containerName, {
					publicAccessLevel: 'blob'
				}, function(error) {
					if (!error) {

						console.log("Container create succeeded.");
						// Provide write access to the container for the next 5 mins.        
						var sharedAccessPolicy = {
							AccessPolicy: {
								Permissions: azure.Constants.BlobConstants.SharedAccessPermissions.WRITE,
								Expiry: formatDate(new Date(new Date().getTime() + 5 * 60 * 1000))
							}
						};

						// Generate an SAS to upload the image.
						var sasQueryString = 
							qs.encode(new azure.SharedAccessSignature(accountName, accountKey)
							.generateSignedQueryString(canonicalizedResource, {}, azure.Constants
							.BlobConstants.ResourceTypes.BLOB, sharedAccessPolicy));

						console.log(sasQueryString);

						// Set the full resource path, including the SAS, on the new item. 
						item.sharedAccessPath = 'https://' + host + canonicalizedResource + 
							'?' + sasQueryString;
						// Set text field to the full resource path so that it will be displayed in the app.
						item.text = 'https://' + host + canonicalizedResource;
					} else {
						console.error(error);
					}
					request.execute();
				});
			} else {
				request.execute();
			}
		}

		function formatDate(date) {
			var raw = date.toJSON();
			// Remove milliseconds from  the end of the time value to prevent errors.
			return raw.substr(0, raw.lastIndexOf('.')) + 'Z';
		}

   This script generates a new SAS for the insert, which is valid for 5 minutes, and assigns the URI value of the generated SAS to the `sas` property of the returned item. The `TodoItem.text` property is also set to the resource path of the new BLOB, so that the URL is displayed in the quickstart app.

4. In the above script, replace the values of `<storage-account-name>` and `<storage-account-key>` with the values from your Storage account.

Next, you need to update the quickstart app to add image upload functionality using the SAS generated by the mobile service.

<h2><a name="add-select-images"></a><span class="short-header">Update the app</span>Update the quickstart client app to capture and upload images</h2>

1. In Visual Studio 2012, open the Package.appxmanifest file and in the **Capabilities** tab enable the **Webcam** and **Microphone** capabilities.

   	![][4]

   This makes sure that your app can use a camera attached to the computer. Users will be requested to allow camera access the first time that the app is run.

1. Open the MainPage.xaml file and add the following **BottomAppBar** element as a child of the **Page** element:

        <Page.BottomAppBar>
	        <AppBar>
	            <Button Name="btnTakePhoto" Style="{StaticResource PhotoAppBarButtonStyle}"
                    Click="OnTakePhotoClick" />
	        </AppBar>
	    </Page.BottomAppBar>

2. Open the MainPage.xaml.cs project file and add the following **using** statements:
	
		using Windows.Media.Capture;
		using Windows.Storage;
		using Windows.UI.Popups;
		using Microsoft.WindowsAzure.Storage.Auth;
		using Microsoft.WindowsAzure.Storage.Blob;
    
3. In the TodoItem class, add the following properties:

		[DataMember(Name = "containerName")]
		public string ContainerName { get; set; }

		[DataMember(Name = "resourceName")]
		public string ResourceName { get; set; }

		public string SAS { get; set; }    

   	<div class="dev-callout"><b>Note</b>
   		<p>To add new properties to the TodoItem object, you must have Dynamic Schema enabled in your mobile service. When Dynamic Schema is enabled, new columns are automatically added to the TodoItem table that map to these new properties.</p>
   	</div>

4. In the MainPage class, add the following method that handles the **OnTakePhotoClick** event:
 
		private async void OnTakePhotoClick(object sender, RoutedEventArgs e)
		{
			// Capture a new photo or video from the device.
			CameraCaptureUI cameraCapture = new CameraCaptureUI();
			StorageFile media = await cameraCapture
				.CaptureFileAsync(CameraCaptureUIMode.PhotoOrVideo);

			string errorString = string.Empty;

			if (media != null)
			{
				// Create a new item to upload to the mobile service. 
				var todoItem = new TodoItem()
				{
					ContainerName = "todoitemimages",
					ResourceName = media.Name,
					Text = TextInput.Text
				};

				// Send the item to be inserted, which generates an SAS in the response.
				await todoTable.InsertAsync(todoItem);
				items.Add(todoItem);

				// Get the new image as a stream.
				using (var fileStream = await media.OpenStreamForReadAsync())
				{
					// Get the URI generated that contains the SAS 
					// and extract the storage credentials.
					var sasUri = new Uri(todoItem.SharedAccessSignature);
					StorageCredentials cred = new StorageCredentials(sasUri.Query.Substring(1));

					// Create a Blob store container based on the info in the returned item.
					CloudBlobContainer container = new CloudBlobContainer(
						new Uri(string.Format("https://{0}/{1}",
							sasUri.Host, todoItem.ContainerName)), cred);

					// Create and upload the new image as a BLOB from the stream.
					CloudBlockBlob blobFromSASCredential =
						container.GetBlockBlobReference(todoItem.ResourceName);
					await blobFromSASCredential.UploadFromStreamAsync(fileStream.AsInputStream());
				}
			}
		}

	When you click the photo button, the app sends a request to the mobile service to insert a new TodoItem. The response contains a URI that contains the SAS, which is then used to insert the image in the Blob store. 

The final step is to test the app and validate that uploads succeed.
		
<h2><a name="test"></a><span class="short-header">Test the app</span>Test push notifications in your app</h2>

1. In Visual Studio, press the F5 key to run the app.

2. Right-click or swipe up, and click **Photo**.

   ![][5]

3. Click the image to take a picture and click **OK**.
  
   ![][6]

	The URL to the new uploaded image is displayed in the app.

	![][7]

4. Type this URL in your web browser to view or download the uploaded image.

	![][8]

## <a name="next-steps"> </a>Next steps

Now that you have been able to securely upload images by integrating your mobile service with the Blob service, check out some of the other backend service and integration topics:

+ [Send email from Mobile Services with SendGrid]
 
  Learn how to add email functionality to your Mobile Service using the SendGrid email service. This topic demonstrates how to add server side scripts to send email using SendGrid.

+ [Schedule backend jobs in Mobile Services]

  Learn how to use the Mobile Services job scheduler functionality to define server script code that is executed on a schedule that you define.

+ [Mobile Services server script reference]

  Reference topics for using server scripts to perform server-side tasks and integration with other Windows Azure components and external resources.
 

<!-- Anchors. -->
[Install the Storage Client library]: #install-storage-client
[Update the client app to capture images]: #add-select-images
[Update the insert script to generate an SAS]: #update-scripts
[Upload images to test the app]: #test
[Next Steps]:#next-steps

<!-- Images. -->
[1]: ../Media/mobile-add-storage-reference-dotnet.png
[2]: ../Media/mobile-portal-data-tables.png
[3]: ../Media/mobile-insert-script-push2.png
[4]: ../Media/mobile-app-manifest-camera.png
[5]: ../Media/mobile-quickstart-blob-appbar.png
[6]: ../Media/mobile-quickstart-blob-camera.png
[7]: ../Media/mobile-quickstart-blob-url.png
[8]: ../Media/mobile-quickstart-blob-ie.png

<!-- URLs. -->
[Send email from Mobile Services with SendGrid]: /en-us/develop/mobile/tutorials/send-email-with-sendgrid/
[Schedule backend jobs in Mobile Services]: /en-us/develop/mobile/tutorials/schedule-backend-tasks/
[Send push notifications to Windows Store apps using Service Bus from a .NET back-end]: http://go.microsoft.com/fwlink/?LinkId=277073&clcid=0x409
[Mobile Services server script reference]: http://go.microsoft.com/fwlink/p/?LinkId=262293
[Get started with Mobile Services]: /en-us/develop/mobile/tutorials/get-started/#create-new-service
[WindowsAzure.com]: http://www.windowsazure.com/
[Windows Azure Management Portal]: https://manage.windowsazure.com/
[Windows Developer Preview registration steps for Mobile Services]: ../HowTo/mobile-services-windows-developer-preview-registration.md
[How To Create a Storage Account]: /en-us/manage/services/storage/how-to-create-a-storage-account
[Windows Azure Storage Client library for Windows Store apps]: http://go.microsoft.com/fwlink/p/?LinkId=276866 