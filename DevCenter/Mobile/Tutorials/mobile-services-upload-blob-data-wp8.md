<properties linkid="develop-mobile-tutorials-upload-blob-data-dotnet" writer="glenga" urlDisplayName="Upload images by using Mobile Services" pageTitle="Upload images to Windows Azure Storage by using Mobile Services" metaKeywords="" metaDescription="Learn how to use Mobile Services to upload images to Windows Azure Storage." metaCanonical="" disqusComments="0" umbracoNaviHide="1" />

<div class="umbMacroHolder" title="This is rendered content from macro" onresizestart="return false;" umbpageid="14799" ismacro="true" umb_chunkname="article-left-menu-windows-store" umb_chunkpath="devcenter/mobile" umb_macroalias="AzureChunkDisplayer" umb_hide="0" umb_modaltrigger="" umb_chunkurl="" umb_modalpopup="0"><!-- startUmbMacro --><span><strong>Azure Chunk Displayer</strong><br />No macro content available for WYSIWYG editing</span><!-- endUmbMacro --></div>

# Upload images to Windows Azure Storage by using Mobile Services
<div class="dev-center-tutorial-selector sublanding"> 
	<a href="/en-us/develop/mobile/tutorials/upload-images-to-storage-dotnet" title="Windows Store C#">Windows Store C#</a>
	<a href="/en-us/develop/mobile/tutorials/upload-images-to-storage-wp8" title="Windows Phone 8"  class="current">Windows Phone 8</a>
<!--    <a href="/en-us/develop/mobile/tutorials/upload-images-to-storage-js" title="Windows Store JavaScript">Windows Store JavaScript</a>
	<a href="/en-us/develop/mobile/tutorials/upload-images-to-storage-ios" title="iOS">iOS</a> 
-->
</div>	

This topic shows you how to use Windows Azure Mobile Services to enable your app to upload and store user-generated images in Windows Azure Storage. Mobile Services uses a SQL Database to store data. However, binary large object (BLOB) data is more efficiently stored in Windows Azure Blob storage service. 

You cannot securely distribute with the client app the credentials required to securely upload data to the Blob Storage service. Instead, you must store these credentials in server scripts and use them to generate a Shared Access Signature (SAS) that is used to upload a new image. The SAS, a credential with a short expiration--in this case 5 minutes, is returned securely by Mobile Services to the client app. The app then uses this temporary credential to upload the image. In this example, downloads from the Blob service are public.

In this tutorial you add functionality to the Mobile Services quickstart app to take pictures and upload the images to Windows Azure by using an SAS generated by Mobile Services. This tutorial walks you through the following basic steps to update the Mobile Services quickstart to upload images to the Blob Storage service:

1. [Install the Storage Client library]
2. [Update the insert script to generate an SAS]
3. [Update the client app to capture images]
4. [Upload images to test the app]

This tutorial requires the following:

+ Microsoft Visual Studio 2012 Express for Windows 8, or a later version
+ [Windows Phone SDK 8.0] or higher
+ Nuget Package Manager installed for Microsoft Visual Studio.
+ [Windows Azure Storage account][How To Create a Storage Account]


This tutorial is based on the Mobile Services quickstart. Before you start this tutorial, you must first complete [Get started with Mobile Services]. 

<h2><a name="install-storage-client"></a><span class="short-header">Install Storage client</span>Install the Storage client for Windows Store apps</h2>

To be able to use an SAS to upload images to Blob storage, you must first add the NuGet package that installs Storage client library for Windows Store apps.

1. In **Solution Explorer** in Visual Studio, right-click the project name, and then select **Manage NuGet Packages**.

2. In the left pane, select the **Online** category, select **Include Prerelease**, search for **WindowsAzure.Storage-Preview**, click **Install** on the **Windows Azure Storage** package, then accept the license agreements. 

  ![][2]

  This adds the client library for Windows Azure storage services to the project.

Next, you will update the quickstart app to capture and upload images.

<h2><a name="update-scripts"></a><span class="short-header">Update the insert script</span>Update the registered insert script in the Management Portal</h2>

A new insert script is registered that generates an SAS when a new Todo item is inserted.

0. If you haven't yet created your storage account, see [How To Create a Storage Account].

1. In the Management Portal, click **Storage**, click the storage account, then click **Manage Keys**. 

  ![][0]

2. Make a note of the **Storage Account Name** and **Access Key**.

   ![][1]

3. In your mobile service, click the **Data** tab and then click the **TodoItem** table. 

   ![][3]

4. In **todoitem**, click the **Script** tab and select **Insert**.
   
  ![][4]

   This displays the function that is invoked when an insert occurs in the TodoItem table.

5. Replace the insert function with the following code:

		var azure = require('azure');
		var qs = require('querystring');

		function insert(item, user, request) {
			var accountName = '<storage-account-name>';
			var accountKey = '<storage-account-key>';
			var host = accountName + '.blob.core.windows.net';
			var canonicalizedResource = '/' + item.containerName + '/' + item.resourceName;

	    if ((typeof item.containerName !== "undefined") && (
	    item.containerName !== null)) {
	        // Set the BLOB store container name on the item, which must be lowercase.
	        item.containerName = item.containerName.toLowerCase();
	
	        // If it does not already exist, create the container 
	        // with public read access for blobs.        
	        var blobService = azure.createBlobService(accountName, accountKey, host);
	        blobService.createContainerIfNotExists(item.containerName, {
	            publicAccessLevel: 'blob'
	        }, function(error) {
	            if (!error) {
	
	                // Provide write access to the container for the next 5 mins.        
	                var sharedAccessPolicy = {
	                    AccessPolicy: {
	                        Permissions: azure.Constants.BlobConstants.SharedAccessPermissions.WRITE,
	                        Expiry: new Date(new Date().getTime() + 5 * 60 * 1000)
	                    }
	                };
	
	                // Generate the upload URL with SAS for the new image.
	                var sasQueryUrl = 
	                    blobService.generateSharedAccessSignature(item.containerName, 
	                    item.resourceName, sharedAccessPolicy);
	                             
	               // Set the query string.
	               item.sasQueryString = qs.stringify(sasQueryUrl.queryString);
	               
	                // Set the full path on the new new item, 
	                // which is used for data binding on the client. 
	                item.imageUri = sasQueryUrl.baseUrl + sasQueryUrl.path;
	
	            } else {
	                console.error(error);
	            }
	            request.execute();
	        });
	    } else {
	        request.execute();
	    }
	}

   This script generates a new SAS for the insert, which is valid for 5 minutes, and assigns the value of the generated SAS to the `sasQueryString` property of the returned item. The `imageUri` property is also set to the resource path of the new BLOB to enable image display during binding in the client UI.

6. In the above script, replace the values of `<storage-account-name>` and `<storage-account-key>` with the values from your Storage account from Step 2, then click **Save**.

   ![][10]

Next, you will update the quickstart app to add image upload functionality by using the SAS generated on insert.

<h2><a name="add-select-images"></a><span class="short-header">Update the app</span>Update the quickstart client app to capture and upload images</h2>

In this section you will update the project from the [Get started with Mobile Services] tutorial to take photos and upload them to Windows Azure Blob Storage. To capture the image, this tutorial uses the [CameraCaptureTask] from the `Microsoft.Phone.Tasks` namespace. This class launches the camera UI on the Windows Phone device to capture the photo and automatically saves the image to the Camera Roll on the Windows Phone device. If you do not want the images saved to the Camera Roll, use the [PhotoCamera] class in the `Microsoft.Devices` namespace instead.

1. Open the MainPage.xaml file and replace the **Grid** element named **ContentPanel** with the following code:

        <!--ContentPanel - place additional content here-->
        <Grid x:Name="ContentPanel" Grid.Row="1" Margin="12,0,12,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="2*" />
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Row="0" Grid.ColumnSpan="2" Text="Enter some text below, click Capture Image to add a captured image. Then click Save to insert a new TodoItem item into your database" TextWrapping="Wrap" Margin="12"/>
            <TextBox Grid.Row="1" Grid.ColumnSpan="2" Name="TodoInput" Text="" />
            <Button Name="ButtonCaptureImage" Grid.Row="2" Click="ButtonCaptureImage_Click">Capture Image</Button>
            <Button Grid.Row ="2" Grid.Column="1" Name="ButtonSave" Click="ButtonSave_Click">Save</Button>
            <TextBlock Grid.Row="3" Grid.ColumnSpan="2" Text="Click refresh below to load the unfinished TodoItems from your database. Use the checkbox to complete and update your TodoItems" TextWrapping="Wrap" Margin="12" />
            <Button Grid.Row="4" Grid.ColumnSpan="2" Name="ButtonRefresh" Click="ButtonRefresh_Click">Refresh</Button>
            <phone:LongListSelector Grid.Row="5" Grid.ColumnSpan="2" Name="ListItems">
                <phone:LongListSelector.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Vertical">
                            <CheckBox Name="CheckBoxComplete" IsChecked="{Binding Complete, Mode=TwoWay}" Checked="CheckBoxComplete_Checked" Content="{Binding Text}" Margin="10,5" VerticalAlignment="Center"/>
                            <Image Name="ImageUpload" Source="{Binding ImageUri, Mode=OneWay}" MaxHeight="150"/>
                        </StackPanel>
                    </DataTemplate>
                </phone:LongListSelector.ItemTemplate>
            </phone:LongListSelector>
        </Grid>


   This adds a new button to launch the [CameraCaptureTask] and adds an image to the **ItemTemplate** and sets its binding source as the URI of the uploaded image in the Blob Storage service.

2. Open the MainPage.xaml.cs project file and add the following **using** statements:
	
		using Microsoft.Phone.Tasks;
		using System.IO;
		using Microsoft.WindowsAzure.Storage.Auth;
		using Microsoft.WindowsAzure.Storage.Blob;
    
3. In the MainPage.xaml.cs project file, update the TodoItem class by adding the following properties:

        [JsonProperty(PropertyName = "containerName")]
        public string ContainerName { get; set; }

        [JsonProperty(PropertyName = "resourceName")]
        public string ResourceName { get; set; }

        [JsonProperty(PropertyName = "sasQueryString")]
        public string SasQueryString { get; set; }

        [JsonProperty(PropertyName = "imageUri")]
        public string ImageUri { get; set; } 

   	<div class="dev-callout"><b>Note</b>
   		<p>To add new properties to the TodoItem object, you must have Dynamic Schema enabled in your mobile service. When Dynamic Schema is enabled, new columns are automatically added to the TodoItem table that map to these new properties.</p>
   	</div>

4. In the MainPage.xaml.cs project file, update the MainPage class. Add the following code to declare the [CameraCaptureTask] and a stream object that will reference the captured image:

        // Using the CameraCaptureTask to allow the user to capture a todo item image //
        CameraCaptureTask cameraCaptureTask;

        // Using a stream reference to upload the image to blob storage.
        Stream imageStream = null;

5. In the MainPage.xaml.cs project file, update the MainPage class. Add the following code to update the constructor to create the CameraCaptureTask and add an event handler for the Completed event:

        // Constructor
        public MainPage()
        {
            InitializeComponent();

            cameraCaptureTask = new CameraCaptureTask();
            cameraCaptureTask.Completed += cameraCaptureTask_Completed;
        }

        void cameraCaptureTask_Completed(object sender, PhotoResult e)
        {
            imageStream = e.ChosenPhoto;
        }

6. In the MainPage.xaml.cs project file, update the MainPage class. Add the following code that displays the camera UI to allow the user to capture an image when the **Capture Image** button is clicked:

        private void ButtonCaptureImage_Click(object sender, RoutedEventArgs e)
        {
            cameraCaptureTask.Show();
        }


7. In the MainPage.xaml.cs project file, update the MainPage class. Replace the existing `InsertTodoItem` method with the following code:
 
        private async void InsertTodoItem(TodoItem todoItem)
        {
            string errorString = string.Empty;            

            if (imageStream != null)
            {
                // Set blob properties of TodoItem.
                todoItem.ContainerName = "todoitemimages";
                todoItem.ResourceName = Guid.NewGuid().ToString() + ".jpg";
            }                       

            // Send the item to be inserted. When blob properties are set this
            // generates an SAS in the response.
            await todoTable.InsertAsync(todoItem);  

            // If we have a returned SAS, then upload the blob.
            if (!string.IsNullOrEmpty(todoItem.SasQueryString))
            {
                // Get the URI generated that contains the SAS 
                // and extract the storage credentials.
                StorageCredentials cred = new StorageCredentials(todoItem.SasQueryString);
                var imageUri = new Uri(todoItem.ImageUri);


                // Instantiate a Blob store container based on the info in the returned item.
                CloudBlobContainer container = new CloudBlobContainer(
                    new Uri(string.Format("https://{0}/{1}",
                        imageUri.Host, todoItem.ContainerName)), cred);


                // Upload the new image as a BLOB from the stream.
                CloudBlockBlob blobFromSASCredential =
                    container.GetBlockBlobReference(todoItem.ResourceName);
                await blobFromSASCredential.UploadFromStreamAsync(imageStream);

                imageStream = null;
            }              

            // Add the new item to the collection.
            items.Add(todoItem);
            TodoInput.Text = "";
        }


	This code sends a request to the mobile service to insert a new TodoItem, including the image file name. The response contains the SAS, which is then used to insert the image in the Blob store, and the URI of the image for data binding.

The final step is to test the app and validate that uploads succeed.
		
<h2><a name="test"></a><span class="short-header">Test the app</span>Test push notifications in your app</h2>

1. In Visual Studio, you can press the F5 key to test the app in the emulator or with an actual device targeted.

2. Enter some text in the textbox, then click **Capture Image**.

   ![][6]

  This displays the camera capture UI. 

3. Click the image or the snapshot button on the phone to take a picture.
  
   ![][7]

4. Click **accept** to accept the image and exit the camera UI.

    ![][11]

5. Click **Save** to insert the new item and upload the image.

	![][8]

6. The new item, along with the uploaded image, is displayed in the list view.

	![][9]

   	<div class="dev-callout"><b>Note</b>
   		<p>The image is downloaded automatically from the Blob Storage service when the <code>imageUri</code> property of the new item is bound to the <strong>Image</strong> control.</p>
   	</div>

## <a name="next-steps"> </a>Next steps

Now that you have been able to securely upload images by integrating your mobile service with the Blob service, check out some of the other backend service and integration topics:

+ [Send email from Mobile Services with SendGrid]
 
  Learn how to add email functionality to your Mobile Service using the SendGrid email service. This topic demonstrates how to add server side scripts to send email using SendGrid.

+ [Schedule backend jobs in Mobile Services]

  Learn how to use the Mobile Services job scheduler functionality to define server script code that is executed on a schedule that you define.

+ [Mobile Services server script reference]

  Reference topics for using server scripts to perform server-side tasks and integration with other Windows Azure components and external resources.
 
+ [Mobile Services .NET How-to Conceptual Reference]

  Learn more about how to use Mobile Services with .NET
  
 
<!-- Anchors. -->
[Install the Storage Client library]: #install-storage-client
[Update the client app to capture images]: #add-select-images
[Update the insert script to generate an SAS]: #update-scripts
[Upload images to test the app]: #test
[Next Steps]:#next-steps

<!-- Images. -->
[0]: ../Media/mobile-blob-storage-account.png
[1]: ../Media/mobile-blob-storage-account-keys.png
[2]: ../Media/mobile-add-storage-nuget-package-dotnet.png
[3]: ../Media/mobile-portal-data-tables.png
[4]: ../Media/mobile-insert-script-blob.png
[5]: ../Media/mobile-wm-app-manifest-camera.png
[6]: ../Media/mobile-upload-blob-app-view-wp8.png
[7]: ../Media/mobile-upload-blob-app-view-camera-wp8.png
[8]: ../Media/mobile-upload-blob-app-view-save-wp8.png
[9]: ../Media/mobile-upload-blob-app-view-final-wp8.png
[10]: ../Media/mobile-insert-script-blob2.png
[11]: ../Media/mobile-upload-blob-app-view-camera-accept-wp8.png

<!-- URLs. -->
[Send email from Mobile Services with SendGrid]: /en-us/develop/mobile/tutorials/send-email-with-sendgrid/
[Schedule backend jobs in Mobile Services]: /en-us/develop/mobile/tutorials/schedule-backend-tasks/
[Send push notifications to Windows Store apps using Service Bus from a .NET back-end]: http://go.microsoft.com/fwlink/?LinkId=277073&clcid=0x409
[Mobile Services server script reference]: http://go.microsoft.com/fwlink/p/?LinkId=262293
[Get started with Mobile Services]: /en-us/develop/mobile/tutorials/get-started/#create-new-service
[WindowsAzure.com]: http://www.windowsazure.com/
[Windows Azure Management Portal]: https://manage.windowsazure.com/
[Windows Developer Preview registration steps for Mobile Services]: ../HowTo/mobile-services-windows-developer-preview-registration.md
[How To Create a Storage Account]: /en-us/manage/services/storage/how-to-create-a-storage-account
[Windows Azure Storage Client library for Windows Store apps]: http://go.microsoft.com/fwlink/p/?LinkId=276866 
[Mobile Services .NET How-to Conceptual Reference]: ../HowTo/mobile-services-client-dotnet.md
[Windows Phone SDK 8.0]: http://www.microsoft.com/en-us/download/details.aspx?id=35471
[CameraCaptureTask]: http://msdn.microsoft.com/en-us/library/windowsphone/develop/microsoft.phone.tasks.cameracapturetask(v=vs.105).aspx
[PhotoCamera]: http://msdn.microsoft.com/en-us/library/windowsphone/develop/microsoft.devices.photocamera(v=vs.105).aspx

