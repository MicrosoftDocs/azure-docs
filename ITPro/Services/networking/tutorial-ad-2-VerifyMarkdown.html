<html>
    <head>
        <title></title>
    </head>
    <body>
<p><div chunk="../chunks/networking-left-nav.md" /></p>

<h1>Install a new Active Directory forest in Windows Azure</h1>

<p>This tutorial walks you through the steps to create a new Active Directory forest on a virtual machine (VM) on <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156007.aspx">Windows Azure Virtual Network</a>. In this tutorial, the virtual network for the VM is not connected to the network at your company. For conceptual guidance about installing Active Directory Domain Services (AD DS) on Windows Azure Virtual Network, see <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156090.aspx">Guidelines for Deploying Windows Server Active Directory on Windows Azure Virtual Machines</a>.</p>

<h2>Table of Contents</h2>

<ul>
<li><a href="#Prerequisites">Prerequisites</a></li>
<li><a href="#Step1">Step 1: Create the first Virtual Machine (VM)</a></li>
<li><a href="#Step2">Step 2: Attach additional disks to the VM</a></li>
<li><a href="#Step3">Step 3: Install Active Directory Domain Services</a></li>
<li><a href="#Step4">Step 4: Validate the installation</a></li>
<li><a href="#Step5">Step 5: Backup the domain controller</a></li>
<li><a href="#Step6">Step 6: Provisioning a Virtual Machine that is Domain Joined on Boot</a></li>
</ul>

<h2><a id="Prerequisites"></a>Prerequisites</h2>

<p>Before you install Active Directory Domain Services (AD DS) on a Windows Azure virtual machine, you need to create a virtual network using one of the following options:</p>

<ul>
<li><p><strong>Create a virtual network <em>without</em> connectivity to another network</strong> by doing the following in the order listed: </p>

<ol>
<li>First, <a href="http://www.windowsazure.com/en-us/manage/services/networking/create-a-virtual-network/">Create a virtual network in Windows Azure</a>. </li>
<li>Then install AD DS using the steps in the tutorial below. </li>
</ol></li>
<li><p><strong>Create a virtual network <em>with</em> connectivity to another network</strong>, such as an Active Directory environment on premises by doing the following in the order listed: </p>

<ol>
<li>First, <a href="../cross-premises-connectivity/">Create a Virtual Network for Cross-Premises Connectivity</a>. </li>
<li>Next, <a href="../add-a-vm-to-a-virtual-network/">Add a Virtual Machine to a Virtual Network</a>. </li>
<li>Finally, install AD DS by following the steps in <a href="../replica-domain-controller/">Install a Replica Active Directory Domain Controller in Windows Azure Virtual Networks</a>.</li>
</ol></li>
</ul>

<h2><a id="Step1"></a>Step 1: Create the first Virtual Machine (VM)</h2>

<p>You can create the first VM either by using the Windows Azure management portal or by using Windows Azure PowerShell.</p>

<h3>To create a VM by using Windows Azure management portal</h3>

<ol>
<li><p>Click <strong>New</strong>, click <strong>Compute</strong>, click <strong>Virtual Machine</strong>, and click <strong>From Gallery</strong>. </p>

<p><img src="../media/ADDS_VNetCreateVMFromGallery.png" alt="Create VM From Gallery" /></p></li>
<li><p>Select the image.</p>

<p><img src="../media/ADDS_VNetCreateVMImageSelection.png" alt="VM Image" /></p></li>
<li><p>Type the name of the new VM, a user name and password, and select a version release date and size.</p>

<p><img src="../media/ADDS_VNetCreateVMConfig.png" alt="VM Configuration" /></p></li>
<li><p>Select the virtual network and subnet and accept other default values.</p>

<p><img src="../media/ADDS_VNetCreateVMConfigSubnet.png" alt="VM Subnet" /></p></li>
<li><p>Accept default endpoints and click the check mark to complete the wizard.</p>

<p><img src="../media/ADDS_VNetCreateVMConfigPorts.png" alt="VM Ports" /></p></li>
</ol>

<h3>To create a VM by using Windows Azure PowerShell</h3>

<ol>
<li><p>Create a storage account that is in the same region as the affinity group. To check the region of the affinity group, click <strong>Networks</strong>, and click <strong>Affinity Groups</strong>. To create a storage account: </p>

<p>a.  Click <strong>Data Services <em>*, click *</em>Storage</strong>, and then click <strong>Quick Create</strong>. </p>

<p>b.  Under URL: type the name of the storage account, and for <strong>Region/Affinity Group</strong>, select the region of the affinity group, such as West US. By selecting a region for the storage account, it can be used with any affinity group in the virtual network.</p></li>
<li><p>Install <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156055.aspx">Windows Azure PowerShell</a>. The VM where you plan to install AD DS must be created using Windows Azure PowerShell in order for the DNS client settings of the domain controller to persist after service healing. The installation of Windows Azure PowerShell requires the installation of Microsoft .NET Framework 4.5 and Windows Management Framework 3.0. If they are not already installed, your computer will need to restart to complete their installation. </p>

<p>a.  Go to <a href="https://www.windowsazure.com/en-us/">https://www.windowsazure.com/en-us/</a>.</p>

<p>b.  Click <strong>Downloads</strong>, click <strong>Command-line tools</strong>, then click <strong>Windows Azure PowerShell</strong>.</p>

<p>c.  Click <strong>Run</strong>. Click <strong>Yes</strong> if prompted by the <strong>User Account Control</strong> dialog. </p>

<p>d.  Click <strong>Install</strong> to go through installation wizard, click <strong>I accept</strong>, and when the wizard is done, click <strong>Finish</strong>. </p>

<p>e.  Click <strong>Exit</strong> to close the Web Platform Installer 4.0.</p></li>
<li><p>If you are running Windows 7, click <strong>Start</strong>, click <strong>All Programs</strong>, click <strong>Windows Azure</strong>, right-click <strong>Windows Azure PowerShell</strong>, and click <strong>Run as Administrator</strong>. Click <strong>Yes</strong> if prompted by the <strong>User Account Control</strong> dialog. If you are running Windows 8, click <strong>Start</strong>, and in the <strong>Search</strong> field, type Windows Azure PowerShell and press ENTER. </p></li>
<li><p>In Windows Azure PowerShell, run the following cmdlet, and then type <strong>Y</strong> to finish the command:</p>

<pre><code>Set-ExecutionPolicy RemoteSigned
</code></pre></li>
<li><p>Run the following cmdlet:</p>

<pre><code>Import-Module 'C:\Program Files (x86)\Microsoft SDKs\Windows Azure\PowerShell\Azure\Azure.psd1'
</code></pre></li>
<li><p>Run the following cmdlet:</p>

<pre><code>Get-AzurePublishSettingsFile
</code></pre>

<p>You will be prompted to sign on to the Windows Azure portal and then prompted to save a .publishsettings file. Save the file in a directory, for example, E:\PowerShell\MyAccount.publishsettings. To subsequently run any other Windows Azure PowerShell cmdlets, steps 4 through 6 do not need to be repeated because they only need to be completed once. </p></li>
<li><p>Run the following cmdlet to open Windows Azure PowerShell ISE:</p>

<pre><code>powershell ise
</code></pre></li>
<li><p>Paste the following script into Windows Azure PowerShell ISE, replacing the placeholders (such as <em>subscriptionname</em>) with your own values, and the run the script. If necessary, click <strong>Networks</strong> in the Management Portal to obtain the subscription name. The storage account name is the name you specified in step 1. The image name used in following script installs Windows Server 2012, but the image names are updated periodically. To get a list of currently available images, run <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj152878.aspx">Get-AzureVMImage</a>. Windows Azure Virtual Networks support the virtualized domain controller safeguards that are present beginning with Windows Server 2012. For more information about virtualized domain controller safeguards, see <a href="http://technet.microsoft.com/en-us/library/hh831734.aspx">Introduction to Active Directory Domain Services (AD DS) Virtualization (Level 100)</a>. </p>

<pre><code>cls


Import-Module "C:\Program Files (x86)\Microsoft SDKs\Windows Azure\PowerShell\Azure\Azure.psd1"
Import-AzurePublishSettingsFile 'C:\PowerShell\Justinha001.publishsettings'
Set-AzureSubscription -SubscriptionName 'Networking Demo Subscription' -CurrentStorageAccount 'yourstorageaccount'
Select-AzureSubscription -SubscriptionName 'Networking Demo Subscription'


#Deploy the Domain Controller in a virtual network
#-------------------------------------------------


#Specify my DC's DNS IP (127.0.0.1)
$myDNS = New-AzureDNS -Name 'myDNS' -IPAddress '127.0.0.1'
$vmname = 'ContosoDC1'
# OS Image to Use
$image = 'a699494373c04fc0bc8f2bb1389d6106__Windows-Server-2012-Datacenter-201306.01-en.us-127GB.vhd'
$service = 'ConDC1demosvc'
$AG = 'YourAffinityGroup'
$vnet = 'YourVirtualNetwork'


#VM Configuration
$MyDC = New-AzureVMConfig -name $vmname -InstanceSize 'Small' -ImageName $image |
    Add-AzureProvisioningConfig -Windows -Password P@$$w0rd |
        Set-AzureSubnet -SubnetNames 'BackEndSubnet'


New-AzureVM -ServiceName $service -VMs $MyDC -AffinityGroup $AG -DnsSettings $myDNS -VNetName $vnet
</code></pre>

<p>If you rerun the script, you need to supply a unique value for $service. You can run Test-AzureName –Service <i>service name</i>, which returns if the name is already taken. After the Windows Azure PowerShell cmdlet successfully completes, the VM will initially appear in the UI in the management portal in a stopped state, followed by a provisioning process. After the VM is provisioned, continue with the next steps.</p></li>
</ol>

<h2><a id="Step2"></a>Step 2: Attach additional disks to the VM</h2>

<ol>
<li><p>In the management portal, click the name of the VM you created, and on the bottom of the screen, click <strong>Attach</strong>, and click <strong>Attach Empty Disk</strong>.</p></li>
<li><p>Type the size of hard disk (in GB) you want, such as 30. </p>

<p><img src="../media/ADDS_VNetCreateVMAttachDisk.png" alt="Specify disk size" /></p></li>
<li><p>Repeat steps 9 and 10 to attach a second disk.</p></li>
<li><p>Click the name of the VM and click <strong>Connect</strong>.</p>

<p><img src="../media/ADDS_VNetCreateVMConnect.png" alt="Connect" /></p></li>
<li><p>Click <strong>Open</strong>.</p>

<p><img src="../media/ADDS_VNetCreateVMOpenRDP.png" alt="Open" /></p></li>
<li><p>In RDP connection dialog, click <strong>Don’t ask me again for connections to this computer</strong>, and click <strong>Connect</strong>.</p>

<p><img src="../media/ADDS_VNetCreateVMConnectRDP.png" alt="Connect with RDP" /></p></li>
<li><p>Type your credentials using the format <i>VM Name</i>\<i>AdminUserName</i>. If you provisioned the VM by using Windows Azure PowerShell, type <i>VM Name</i>\Administrator.</p>

<p><img src="../media/ADDS_VNetCreateVMCreds.png" alt="Credentials" /></p></li>
<li><p>In Remote Desktop Connection, click <strong>Yes</strong>.</p>

<p><img src="../media/ADDS_VNetCreateVMRDPCert.png" alt="Remote Desktop" /></p></li>
</ol>

<h2><a id="Step3"></a>Step 3: Install Active Directory Domain Services</h2>

<ol>
<li><p>Initialize the disk you attached to the VM and create a new volume to store Active Directory files. </p>

<p>a.  In Server Manager, click <strong>File and Storage Services</strong>. </p>

<p>b.  Click <strong>Disks</strong>, right-click the disk you attached, click <strong>Initialize</strong>, and click <strong>Yes</strong> to confirm the operation.</p>

<p>c.  After initialization is complete, right-click the disk, click <strong>New Volume</strong>. Accept the default values in the New Volume Wizard and finish creating the volume, and then create a new folder named <strong>NTDS</strong> in order to store the Active Directory database and log files.</p></li>
<li><p>In Server Manager, click <strong>Manage</strong> and click <strong>Add Roles and Features</strong> to start the Add Roles Wizard. For more information about installing AD DS on Windows Server 2012, see <a href="http://technet.microsoft.com/en-us/library/hh472162.aspx">Install Active Directory Domain Services (Level 100)</a>.</p>

<p><img src="../media/ADDS_VNetDCAddRole.png" alt="Add Role" /></p></li>
<li><p>On the Before you begin page, click <strong>Next</strong>.</p></li>
<li><p>On the Select installation type page, click <strong>Role-based or feature-based installation</strong> and then click <strong>Next</strong>.</p>

<p><img src="../media/ADDS_VNetDCSelectInstallationType.png" alt="Select Installation type" /></p></li>
<li><p>On the Select destination server page, click <strong>Select a server from the server pool</strong>, click the name of the server and then click <strong>Next</strong>.</p>

<p><img src="../media/ADDS_VNetDCSelectDestinationServer.png" alt="Select server" /></p></li>
<li><p>On the Select server roles page, click <strong>Active Directory Domain Services</strong>, then on the Add Roles and Features Wizard dialog box, click <strong>Add Features</strong>, and then click <strong>Next</strong>.  </p>

<p><img src="../media/ADDS_VNetDCSelectServerRole.png" alt="Select Server Role" /></p>

<p><img src="../media/ADDS_VNetDCAddTools.png" alt="Add tools" /></p></li>
<li><p>On the Select features page, select any additional features you want to install and click <strong>Next</strong>. </p>

<p><img src="../media/ADDS_VNetDCSelectFeatures.png" alt="Select features" /></p></li>
<li><p>On the Active Directory Domain Services page, review the information and then click <strong>Next</strong>.</p></li>
<li><p>On the Confirm installation selections page, click <strong>Install</strong>.</p>

<p><img src="../media/ADDS_VNetDCConfirmRole.png" alt="Confirm Server Role" /></p></li>
<li><p>On the Results page, verify that the installation succeeded, and click <strong>Promote this server to a domain controller</strong> to start the Active Directory Domain Services Configuration Wizard.</p>

<p><img src="../media/ADDS_VNetDCPromote.png" alt="Promote" /></p>

<p>Note: If you close Add Roles Wizard at this point without starting the Active Directory Domain Services Configuration Wizard, you can restart it by clicking Tasks in Server Manager.</p></li>
<li><p>On the Deployment Configuration page, click <strong>Add a new forest</strong> and then type the name of the root domain (for example, fabrikam.com) and click <strong>Next</strong>.</p>

<p><img src="../media/ADDS_VNetDCNewForest.png" alt="New forest" /></p></li>
<li><p>On the Domain Controller Options page, type and confirm the Directory Services Restore Mode password, accept other default values and click <strong>Next</strong>.</p>

<p><img src="../media/ADDS_VNetDCOptions.png" alt="DC Options" /></p></li>
<li><p>On the DNS Options page (which appears only if you install a DNS server), click <strong>Create DNS delegation</strong> as needed and then click <strong>Next</strong>. If you do, provide credentials that have permission to create DNS delegation records in the parent DNS zone. If a DNS server that hosts the parent zone cannot be contacted, the <strong>Create DNS delegation</strong> option is not available.</p></li>
<li><p>On the Additional Options page, type a new NetBIOS name or verify the default NetBIOS name of the domain, and then click <strong>Next</strong>.</p>

<p><img src="../media/ADDS_VNetDCAdditionalOptions.png" alt="Additional Options" /></p></li>
<li><p>On the Paths page, type or browse to the locations for the Active Directory database, log files, and SYSVOL folder, and click <strong>Next</strong>.     </p>

<p><img src="../media/ADDS_VNetDCPaths.png" alt="Paths" /></p></li>
<li><p>On the Review Options page, confirm your selections, review the selections, and then click <strong>Next</strong>. </p>

<p><img src="../media/ADDS_VNetDCReviewOptions.png" alt="Review options" /></p></li>
<li><p>On the Prerequisites Check page, confirm that prerequisite validation completed and then click <strong>Install</strong>. </p>

<p><img src="../media/ADDS_VNetDCPrereqCheck.png" alt="Prerequisite check" /></p></li>
<li><p>On the Results page, verify that the server was successfully configured as a domain controller. The server will be restarted automatically to complete the AD DS installation. </p></li>
</ol>

<h2><a id="Step4"></a>Step 4: Validate the installation</h2>

<ol>
<li><p>Reconnect to the VM.</p></li>
<li><p>Click <strong>Start</strong>, type <strong>Command Prompt</strong>, click the Command Prompt icon, and click <strong>Run as Administrator</strong>. </p></li>
<li><p>Type the following command and press ENTER:</p>

<pre><code>Dcdiag /c /v
</code></pre></li>
<li><p>Verify that the tests ran successfully. Some tests related to validating IP addresses may not pass. To prevent validation errors related to Time server, <a href="http://technet.microsoft.com/en-us/library/cc731191(WS.10).aspx">configure the Windows Time Service</a> on the new DC.</p></li>
</ol>

<h2><a id="Step5"></a>Step 5: Backup the domain controller</h2>

<ol>
<li><p>Connect to the VM.</p></li>
<li><p>In Server Manager, click <strong>Add Roles and Features</strong>, and on the Select Features page, select <strong>Windows Server Backup</strong>. Follow the instructions to install Windows Server Backup.</p></li>
<li><p>Click <strong>Start</strong>, click <strong>Administrative Tools</strong>, click <strong>Windows Server Backup</strong>, then click <strong>Backup once</strong>.</p></li>
<li><p>Click <strong>Different options</strong>, then click <strong>Next</strong>.</p></li>
<li><p>Click <strong>Full Server</strong>, then click <strong>Next</strong>.</p></li>
<li><p>Click <strong>Local drives</strong>, then click <strong>Next</strong>.</p></li>
<li><p>Select the destination drive that does not host the operating system files or the Active Directory database, then click <strong>Next</strong>.
<img src="../media/BackupDC.png" alt="Backup the DC" /></p></li>
<li><p>Confirm the settings you selected and then click <strong>Backup</strong>. </p></li>
</ol>

<h2><a id="Step6"></a>Step 6: Provisioning a Virtual Machine that is Domain Joined on Boot</h2>

<p>After the DC is configured, you can either create VMs using the management portal or you can run the following Windows PowerShell script to provision additional virtual machines and have them automatically join the domain when they are provisioned. The DNS client resolver settings for the VMs can be configured when the VMs are provisioned.  </p>

<p>If you create VMs using the management portal, specify the Internal IP address of the domain controller as the Preferred DNS server in the the DNS client resolver settings. To determine the Internal IP address of the domain controller, click the name of virtual machine where it is running.</p>

<p>For more information about using Windows PowerShell, see <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156055.aspx">Getting Started with Windows Azure PowerShell</a> and <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj152841">Windows Azure Management Cmdlets</a>.</p>

<ol>
<li><p>To use Windows Azure PowerShell to create an additional virtual machine that is domain-joined when it first boots, open Windows Azure PowerShell ISE, paste the following script, replace the placeholders (such as <em>ContosoDC13</em>) with your own values and run it. Specify the name of the domain controller for the -Name parameter for the New-AzureDNS cmdlet. </p>

<p>In the following example, the Internal IP address of the domain controller is 10.4.3.1. The Add-AzureProvisioningConfig also takes a -MachineObjectOU parameter which if specified (requires the full distinguished name in Active Directory) allows for setting Group Policy settings on all of the virtual machines in that container.</p>

<p>After the virtual machines are provisioned, log on by specifying a domain account using User Principal Name (UPN) format, such as administrator@corp.contoso.com. </p>

<pre><code>cls


Import-Module "C:\Program Files (x86)\Microsoft SDKs\Windows Azure\PowerShell\Azure\Azure.psd1"
Import-AzurePublishSettingsFile '*E:\PowerShell\MyAccount.publishsettings*'
Set-AzureSubscription -SubscriptionName *subscriptionname* -CurrentStorageAccount *storageaccountname*
Select-AzureSubscription -SubscriptionName *subscriptionname*


#Deploy a new VM and join it to the domain
#-------------------------------------------
#Specify my DC's DNS IP (10.4.3.1)
$myDNS = New-AzureDNS -Name '*ContosoDC13*' -IPAddress '*10.4.3.1*'


# OS Image to Use
$image = 'fb83b3509582419d99629ce476bcb5c8__SQL-Server-2012SP1-CU5-11.0.3373.0-Enterprise-ENU-Win2012'
$service = '*myazuresvcindomainM1*'
$AG = '*YourAffinityGroup*'
$vnet = '*YourVirtualNetwork*'
$pwd = '*p@$$w0rd*'
$size = 'Small'


#VM Configuration
$vmname = 'MyTestVM1'
$MyVM1 = New-AzureVMConfig -name $vmname -InstanceSize $size -ImageName $image |
    Add-AzureProvisioningConfig -WindowsDomain -Password $pwd -Domain '*corp*' -DomainPassword '*p@$$w0rd*' -DomainUserName 'Administrator' -JoinDomain '*corp.contoso.com*'|
    Set-AzureSubnet -SubnetNames '*BackEnd*'


New-AzureVM -ServiceName $service -AffinityGroup $AG -VMs $MyVM1 -DnsSettings $myDNS -VNetName $vnet
</code></pre></li>
</ol>

<p>If you rerun the script, you need to supply a unique value for $service. You can run Test-AzureName –Service <service name>, which returns if the name is already taken. After the Windows Azure PowerShell cmdlet successfully completes, the VMs will initially appear in the UI in the management portal in a stopped state, followed by a provisioning process. After the VMs are provisioned, you can log on to them.      </p>

<h2>See Also</h2>

<ul>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156007.aspx">Windows Azure Virtual Network</a></p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156055.aspx">Windows Azure PowerShell</a></p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj152841">Windows Azure Management Cmdlets</a></p></li>
<li><p><a href="http://technet.microsoft.com/en-us/library/hh831734.aspx">Introduction to Active Directory Domain Services (AD DS) Virtualization (Level 100)</a></p></li>
</ul>
    </body>
</html>
