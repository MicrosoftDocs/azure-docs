---
title: Monitoring with Azure Managed Prometheus and Grafana
description: Learn how to use monitor With Azure Managed Prometheus and Grafana
ms.service: hdinsight-aks
ms.topic: how-to
ms.date: 11/07/2023
---

# Monitoring with Azure Managed Prometheus and Grafana

[!INCLUDE [feature-in-preview](includes/feature-in-preview.md)]

Cluster and service Monitoring is integral part of any organization. Azure HDInsight on AKS comes with integrated monitoring experience with Azure services. In this article, we use managed Prometheus service with Azure Grafana dashboards for monitoring.

[Azure Managed Prometheus](../azure-monitor/essentials/prometheus-metrics-overview.md) is a service that monitors your cloud environments. The monitoring is to maintain their availability and performance and workload metrics. It collects data generated by resources in your Azure instances and from other monitoring tools. The data is used to provide analysis across multiple sources. 

[Azure Managed Grafana](../managed-grafana/quickstart-managed-grafana-portal.md) is a data visualization platform built on top of the Grafana software by Grafana Labs. It's built as a fully managed Azure service operated and supported by Microsoft. Grafana helps you bring together metrics, logs, and traces into a single user interface. With its extensive support for data sources and graphing capabilities, you can view and analyze your application and infrastructure telemetry data in real-time.

This article covers the details of enabling the monitoring feature in HDInsight on AKS.

## Prerequisites

* An Azure Managed Prometheus workspace. You can think of this workspace as a unique Azure Monitor logs environment with its own data repository, data sources, and solutions. For the instructions, see [Create an Azure Managed Prometheus workspace](../azure-monitor/essentials/azure-monitor-workspace-manage.md).
* Azure Managed Grafana workspace. For the instructions, see [Create an Azure Managed Grafana workspace](../managed-grafana/quickstart-managed-grafana-portal.md).
* An [HDInsight on AKS cluster](./quickstart-create-cluster.md). Currently, you can use Azure Managed Prometheus with the following HDInsight on AKS cluster types:
    * Apache Spark™
    * Apache Flink®
    * Trino

For the instructions on how to create an HDInsight on AKS cluster, see [Get started with Azure HDInsight on AKS](./overview.md).

## Enabling Azure Managed Prometheus and Grafana 

The Azure Managed Prometheus and Grafana Monitoring must be configured at cluster pool level to enable it at cluster level. You need to consider various stages while enabling the Monitoring Solution.


|#|	Scenario			|Enable 	|Disable |
|-|-|-|-|
|1|	Cluster Pool -During Creation	| `Not Supported` 	|`Default` |
|2|	Cluster Pool – Post Creation	| `Supported` 	| `Not Supported` |
|3|	Cluster – During Creation 	| `Supported` 	| `Default` |
|4|	Cluster – Post Creation		 |`Supported` |`Supported` |

## During cluster pool creation

Currently, Managed Prometheus **CANNOT** be enabled during Cluster Pool creation time. You can configure it post cluster pool creation.

## Post cluster pool creation

Monitoring can be enabled from the **Integrations** tab on an existing Cluster Pool View available in Azure portal. 
You can use pre created workspaces or create a new one while your'e configuring the monitoring for the cluster pool.

### Use precreated workspace

1. Click on **configure** to enable Azure Prometheus monitoring.

    :::image type="content" source="./media/monitor-with-prometheus-grafana/integration-configure-tab.png" alt-text="Screenshot showing integration configure tab." border="true" lightbox="./media/monitor-with-prometheus-grafana/integration-configure-tab.png":::

1. Click on **Advanced Settings** to attach your pre created workspaces.

    :::image type="content" source="./media/monitor-with-prometheus-grafana/advanced-settings.png" alt-text="Screenshot showing advanced settings." border="true" lightbox="./media/monitor-with-prometheus-grafana/advanced-settings.png":::

    :::image type="content" source="./media/monitor-with-prometheus-grafana/configure-prometheus-step-1.png" alt-text="Screenshot showing configure Prometheus step 1." border="true" lightbox="./media/monitor-with-prometheus-grafana/configure-prometheus-step-1.png":::

### Create Azure Prometheus and Grafana Workspace while enabling Monitoring in Cluster Pool

You can create the workspaces from the HDI on AKS cluster pool page.

1. Click on **Configure** next to the Azure Prometheus option.

    :::image type="content" source="./media/monitor-with-prometheus-grafana/configure-prometheus-step-2.png" alt-text="Screenshot showing configure Prometheus step 2." border="true" lightbox="./media/monitor-with-prometheus-grafana/configure-prometheus-step-2.png":::

1. Click on **Create New** workspace for Azure Managed Prometheus.

    :::image type="content" source="./media/monitor-with-prometheus-grafana/configure-prometheus-step-3.png" alt-text="Screenshot showing configure Prometheus step 3." border="true" lightbox="./media/monitor-with-prometheus-grafana/configure-prometheus-step-3.png":::

1. Fill in the name, region and click on **Create** for Prometheus.

      :::image type="content" source="./media/monitor-with-prometheus-grafana/configure-prometheus-step-4.png" alt-text="Screenshot showing configure Prometheus step 4." border="true" lightbox="./media/monitor-with-prometheus-grafana/configure-prometheus-step-4.png":::

1. Click on **Create New** workspace for Azure Managed Grafana.
1. Fill in Name, Region and click on **Create** for Grafana. 

    :::image type="content" source="./media/monitor-with-prometheus-grafana/configure-prometheus-step-5.png" alt-text="Screenshot showing configure Prometheus step 5." border="true" lightbox="./media/monitor-with-prometheus-grafana/configure-prometheus-step-5.png":::


   > [!NOTE]
   > 1. Managed Grafana can be enabled only if Managed Prometheus is enabled.
   > 1. Once Azure Managed Prometheus workspace and Azure Managed Grafana workspace is enabled from the HDInsight on AKS cluster pool, it cannot be disabled from the cluster pool again. It must be disabled from the cluster level.

## During cluster creation

### Enable Azure Managed Prometheus during cluster creation

1. Once the cluster pool is created and the Azure Managed Prometheus enabled, user must [create a HDI on AKS cluster in the same cluster pool](./trino/trino-create-cluster.md).

1. During the cluster creation process, navigate to the **Integration** page and enable **Azure Prometheus.**

    :::image type="content" source="./media/monitor-with-prometheus-grafana/enable-prometheus-monitoring.png" alt-text="Screenshot showing enable prometheus monitoring." border="true" lightbox="./media/monitor-with-prometheus-grafana/enable-prometheus-monitoring.png":::

## Post cluster creation

You can also enable Azure Managed Prometheus post HDI on AKS cluster creation

1. Navigate to the Integrations tab in the cluster page.

1. Enable Azure Prometheus Monitoring with the toggle button and click on **Save**.

    :::image type="content" source="./media/monitor-with-prometheus-grafana/save-configuration.png" alt-text="Screenshot showing how to save configuration." border="true" lightbox="./media/monitor-with-prometheus-grafana/save-configuration.png":::

   > [!NOTE]
   > Similarly, if you need to disable Azure Prometheus monitoring can be done by disabling the toggle button and click on **Save.**

### Enabling required permissions

For viewing Azure Managed Prometheus and Azure Managed Grafana from the HDInsight on AKS portal, you need to have certain permissions as follows.

User permission: For viewing Azure Managed Grafana, “Grafana Viewer” role is required for the user in the Azure Managed Grafana workspace, Access control (IAM).  View how to grant user access, [here](../role-based-access-control/quickstart-assign-role-user-portal.md).

1. Open the Grafana workspace configured in the cluster pool.
1. Select the Role as **Grafana Viewer**
1. Select the username who is accessing the Grafana dashboard.
1. Select the user and click on **Review+ Assign**

   > [!NOTE]
   > If user is pre-creating Azure Managed Prometheus the  Grafana Identity requires additional permission of **Monitoring Reader.**
    
1. In the Grafana workspace page (the one linked to the cluster) provides **Monitoring reader** permission in Identity tab.

    :::image type="content" source="./media/monitor-with-prometheus-grafana/role-assignment.png" alt-text="Screenshot showing how to assign role." border="true" lightbox="./media/monitor-with-prometheus-grafana/role-assignment.png":::

1. Click on **Add role assignment.**
1. Select the following parameters
    1. Scope as **Subscription**
    1. The subscription name.
    1. Role as **Monitoring Reader**
    

    :::image type="content" source="./media/monitor-with-prometheus-grafana/role-assignment.png" alt-text="Screenshot showing how to assign role." border="true" lightbox="./media/monitor-with-prometheus-grafana/role-assignment.png":::

   > [!NOTE]
   > For viewing other roles for Grafana users see  [here](../managed-grafana/how-to-share-grafana-workspace.md).
       
## View metrics

We are using an Apache Spark™ cluster as an example in this case, assuming few jobs are executed in the cluster, in order to have the metrics.  

Review the following steps to use the Grafana sample templates:

1. Download the sample template from [here](https://github.com/Azure-Samples/hdinsight-aks/tree/main/sample-grafana-template) for the respective workloads (download the Apache Spark template in this case). 

1. Login to the Grafana Dashboard from your cluster.

   :::image type="content" source="./media/monitor-with-prometheus-grafana/login-to-grafana-dashboard.png" alt-text="Screenshot showing how to set time frame." border="true" lightbox="./media/monitor-with-prometheus-grafana/login-to-grafana-dashboard.png":::

1.  Once the Grafana Dashboard page is opened, click on New > Import

    :::image type="content" source="./media/monitor-with-prometheus-grafana/grafana-dashboard.png" alt-text="Screenshot showing how to metric type." border="true" lightbox="./media/monitor-with-prometheus-grafana/grafana-dashboard.png":::

1. Click on the Upload Dashboard JSON file and upload the Apache Spark Grafana template that you have downloaded and click on **Import**. 

    :::image type="content" source="./media/monitor-with-prometheus-grafana/upload-dashboard-json-file.png" alt-text="Screenshot showing how to run query." border="true" lightbox="./media/monitor-with-prometheus-grafana/upload-dashboard-json-file.png":::

1. After the upload is complete, you can click on the dashboard to view the metrics. 

    :::image type="content" source="./media/monitor-with-prometheus-grafana/matrix-view.png" alt-text="Screenshot showing how to view the output." border="true" lightbox="./media/monitor-with-prometheus-grafana/matrix-view.png":::
   
## Reference

* Apache, Apache Spark, Spark, and associated open source project names are [trademarks](./trademarks.md) of the [Apache Software Foundation](https://www.apache.org/) (ASF).
