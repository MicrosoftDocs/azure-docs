{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "adminUsername": {
        "type": "string",
        "defaultValue": "azureuser",
        "metadata": {
          "description": "Admin user name of the virtual machine."
        }
      },
      "adminGroupObjectIds": {
        "type": "array",
        "metadata": {
          "description": "AAD admin group object ids who need to be added to the cluster as admin users."
        }
      },
      "cniNetworkId": {
        "type": "string",
        "metadata": {
          "description": "The ARM id of the network to be used as the cni network."
        }
      },
      "cloudServicesNetworkId": {
        "type": "string",
        "metadata": {
          "description": "The ARM id of the cloud services network"
        }
      },
      "podCidrs": {
        "type": "array",
        "metadata": {
          "description": "Nexus Kubernetes cluster pod CIDRs."
        },
        "defaultValue": ["10.244.0.0/16"]
      },
      "dnsServiceIp": {
        "type": "string",
        "metadata": {
          "description": "Nexus Kubernetes cluster DNS service IP."
        },
        "defaultValue": "10.96.0.10"
      },
      "serviceCidrs": {
        "type": "array",
        "metadata": {
          "description": "Nexus Kubernetes cluster service CIDRs."
        },
        "defaultValue": ["10.96.0.0/16"]
      },
      "controlPlaneCount": {
        "type": "int",
        "metadata": {
          "description": "Number of Nexus Kubernetes control plane machines to create"
        },
        "defaultValue": 1
      },
      "extendedLocation": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "Extended location (custom-location) of the Azure Operator Nexus instance"
        }
      },
      "controlPlaneVmSkuName": {
        "type": "string",
        "metadata": {
          "description": "Nexus Kubernetes control plane vmSize to use (e.g. NC_G4_v1)"
        },
        "defaultValue": "NC_G4_v1",
        "allowedValues": [
          "NC_G2_v1",
          "NC_G4_v1",
          "NC_G8_v1",
          "NC_G12_v1",
          "NC_G16_v1"
        ]
      },
      "kubernetesClusterName": {
        "type": "string",
        "defaultValue": "[concat('nexus-k8s-cluster-',uniqueString(resourceGroup().id))]",
        "metadata": {
          "description": "Nexus Kubernetes cluster name"
        }
      },
      "systemPoolName": {
        "type": "string",
        "defaultValue": "[concat(parameters('kubernetesClusterName'), '-nodepool-1')]",
        "metadata": {
          "description": "Nexus Kubernetes cluster system pool name"
        }
      },
      "kubernetesVersion": {
        "type": "string",
        "metadata": {
          "description": "Nexus Kubernetes Kubernetes Version to use"
        },
        "defaultValue": "1.24.9"
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Azure DC location of resource"
        }
      },
      "workerVmSkuName": {
        "type": "string",
        "metadata": {
          "description": "Nexus Kubernetes worker vmSize to use (e.g. NC_M4_v1)"
        },
        "defaultValue": "NC_M4_v1",
        "allowedValues": [
          "NC_M4_v1",
          "NC_M8_v1",
          "NC_M12_v1",
          "NC_M16_v1",
          "NC_M32_v1",
          "NC_M36_v1",
          "NC_M44_v1"
        ]
      },
      "ncApiVersion": {
        "type": "string",
        "defaultValue": "2023-05-01-preview"
      },
      "sshPublicKey": {
        "type": "string",
        "metadata": {
          "description": "SSH key to install on the Nexus Kubernetes cluster"
        },
        "defaultValue": []
      },
      "systemPoolNodeCount": {
        "type": "int",
        "metadata": {
          "description": "The number of Nexus Kubernetes system pool nodes to create"
        },
        "defaultValue": 1
      }
    },
    "resources": [
      {
        "type": "Microsoft.NetworkCloud/kubernetesClusters",
        "apiVersion": "[parameters('ncApiVersion')]",
        "name": "[parameters('kubernetesClusterName')]",
        "location": "[parameters('location')]",
        "tags": {
          "AppName": "Microsoft AP5GC SMF"
        },
        "extendedLocation": {
          "name": "[parameters('extendedLocation')]",
          "type": "CustomLocation"
        },
        "properties": {
          "administratorConfiguration": {
            "adminUsername": "[parameters('adminUsername')]",
            "sshPublicKeys": [
              {
                "keyData": "[parameters('sshPublicKey')]"
              }
            ]
          },
          "controlPlaneNodeConfiguration": {
            "count": "[parameters('controlPlaneCount')]",
            "vmSkuName": "[parameters('controlPlaneVmSkuName')]",
            "availabilityZones": []
          },
          "initialAgentPoolConfigurations": [
            {
              "count": "[parameters('systemPoolNodeCount')]",
              "mode": "System",
              "name": "[parameters('systemPoolName')]",
              "vmSkuName": "[parameters('workerVmSkuName')]",
              "availabilityZones": [],
              "labels": [],
              "taints": []
            }
          ],
          "kubernetesVersion": "[parameters('kubernetesVersion')]",
          "networkConfiguration": {
            "cloudServicesNetworkId": "[parameters('cloudServicesNetworkId')]",
            "cniNetworkId": "[parameters('cniNetworkId')]",
            "podCidrs": "[parameters('podCidrs')]",
            "dnsServiceIp": "[parameters('dnsServiceIp')]",
            "serviceCidrs": "[parameters('serviceCidrs')]"
          },
          "aadConfiguration": {
            "adminGroupObjectIds": "[parameters('adminGroupObjectIds')]"
          }
        },
        "dependsOn": []
      }
    ]
  }