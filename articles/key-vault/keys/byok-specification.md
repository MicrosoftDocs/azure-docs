---
title: Bring Your Own Key Specification - Azure Key Vault | Microsoft Docs
description: This document described bring your own key specification. 
services: key-vault
author: amitbapat
manager: devtiw
tags: azure-resource-manager

ms.service: key-vault
ms.subservice: keys
ms.topic: conceptual
ms.date: 05/29/2020
ms.author: ambapat

---

# Bring Your Own Key Specification

## Scenario

A Key Vault customer would like to securely transfer a key from their on-premises HSM outside Azure, into the HSM backing Azure Key Vault. The process of importing a key generated outside Key Vault is generally referred to as Bring Your Own Key (BYOK).

The following are the requirements:
1. The key to be transferred never exists outside an HSM in plain text form.
2. Outside an HSM, the key to be transferred is always protected by a key held in the Azure Key Vault HSM

## Terminology

|Key Name|Key Type|Origin|Description|
|---|---|---|---|
|Key Exchange Key (KEK)|RSA|Azure Key Vault HSM|An HSM backed RSA key pair generated in Azure Key Vault
Wrapping Key|AES|Vendor HSM|An [ephemeral] AES key generated by HSM on-prem
Target Key|RSA, EC, AES|Vendor HSM|The key to be transferred to the Azure Key Vault HSM

**Key Exchange Key**: An HSM-backed key that customer generates in the key vault where the BYOK key will be imported. This KEK must have following properties:

1. It’s an RSA-HSM key (4096-bit or 3072-bit or 2048-bit)
2. It will have fixed key_ops (ONLY ‘import’), that will allow it to be used ONLY during BYOK
3. Must be in the same vault where the Target Key will be imported

## User Steps

To perform a key transfer, the customer performs following steps:

**Step 1:** Generates KEK

**Step 2:** Retrieves the public key of the KEK 

**Step 3:** Using HSM vendor provided BYOK tool - Imports the KEK into the target HSM and exports the Target Key protected by the KEK

**Step 4:** Imports the protected Target Key to Azure Key Vault

HSM Vendor provides a BYOK tool and accompanying documentation to their customers to complete Steps 3 and produce a Key Transfer Blob (a .byok file).


## HSM Constraints

Existing HSM may apply constraints on key that they manage, including:
* The HSM may need to be configured to allow key wrap-based export
* The target key may need to be marked CKA_EXTRACTABLE for the HSM to allow controlled export
* Dependent on implementation, the key encryption key and wrapping key may need to be marked as CKA_TRUSTED to allow it to be used to wrap keys in the HSM

The configuration of source HSM is, generally, outside the scope of this specification. Microsoft expects the HSM Vendor to produce documentation accompanying their BYOK tool to include any such configuration steps.

### Step 1: Generate KEK

Use the az keyvault key create command to create KEK with key operations set to import. Note down the key identifier 'kid' returned from the below command.

```azurecli
az keyvault key create --kty RSA-HSM --size 4096 --name KEKforBYOK --ops import --vault-name ContosoKeyVaultHSM
```

This step can also be performed using the equivalent Azure PowerShell, REST API commands or Key Vault SDKs (.NET, Python, Java, node etc.) to generate a KEK.

### Step 2: Customer runs following command to retrieve public key of KEK

```azurecli
az keyvault key download --name KEKforBYOK --vault-name ContosoKeyVaultHSM --file KEKforBYOK.publickey.pem
```

This step can also be performed using the equivalent REST API commands or Key Vault SDKs (.NET, Python, Java, node etc.) to retrieve public key and then storing it into a .pem file if executed programmatically.

### Steps 3: Generate Key Transfer Blob using HSM Vendor provided BYOK tool

Customer will use HSM Vendor provided BYOK tool to create a key transfer blob. KEK public key in (.pem file) will be one of the inputs to this tool.

#### Key Transfer Blob
Long term, Microsoft would like to use PKCS#11 CKM_RSA_AES_KEY_WRAP mechanism to transfer the target key to Azure Key Vault since this mechanism produces a single blob and, more importantly, the intermediate AES key is handled by the two HSMs and is guaranteed to be ephemeral. This mechanism is not presently available in some HSMs but the combination of protecting the target key with CKM_AES_KEY_WRAP_PAD using an AES key and protecting the AES key with CKM_RSA_PKCS_OAEP produces an equivalent blob.

The target key plaintext depends on the key type: 
* For a RSA key, the private key ASN.1 DER encoding [RFC3447] wrapped in PKCS#8 [RFC5208] 
* For an EC key, the private key ASN.1 DER encoding [RFC5915] wrapped in PKCS#8 [RFC5208]
* For an octet key, the raw bytes of the key

The bytes for the plaintext key are then transformed using the CKM_RSA_AES_KEY_WRAP mechanism:
* An ephemeral AES key is generated and encrypted with the wrapping RSA key using RSA-OAEP with SHA1.
* The encoded plaintext key is encrypted using the AES key using AES Key Wrap with Padding.
* The encrypted AES key and the encrypted plaintext key are concatenated to produce the final ciphertext blob.

The format of the transfer blob uses JSON Web Encryption compact serialization (RFC7516) primarily as a vehicle for delivering the required metadata to the service for correct decryption.

If CKM_RSA_AES_KEY_WRAP_PAD is used, the JSON serialization of the transfer blob would be:

```json
{
  "schema_version": "1.0.0",
  "header":
  {
    "kid": "<key identifier of the KEK>",
    "alg": "dir",
    "enc": "CKM_RSA_AES_KEY_WRAP"
  },
  "ciphertext":"BASE64URL(<ciphertext contents>)",
  "generator": "byok tool name and version; source HSM name and firmware version"
}

```

* kid = key identifier of KEK. For Key Vault keys it looks like this: https://ContosoKeyVaultHSM.vault.azure.net/keys/mykek/eba63d27e4e34e028839b53fac905621
* alg = algorithm. 
* dir = Direct mode, i.e. the referenced kid is used to directly protect the ciphertext which is an accurate representation of CKM_RSA_AES_KEY_WRAP
* generator = an informational field that denotes the name and version of byok tool and the source HSM manufacturer and model. This information is intended for use in troubleshooting and support.

The JSON blob is stored in file. The file must have .byok extension so that the Azure PowerShell/CLI client treats it accordingly when ‘Add-AzKeyVaultKey’ (PSH) or ‘az keyvault key import’ (CLI) command is used.

### Step 4: Upload .byok file to import HSM-key

Customer will transfer the BYOK blob to an online workstation and then run a ‘Add-AzKeyVaultKey’ or ‘az keyvault key import’ command to import this blob as a new HSM-backed key into Key Vault. 

```azurecli
az keyvault key import --vault-name ContosoKeyVaultHSM --name ContosoFirstHSMkey --byok-file KeyTransferPackage-ContosoFirstHSMkey.byok
```

This can also be achieved using the equivalent REST API commands or Key Vault SDKs (.NET, Python, Java, node etc.) if executed programmatically.

When the above command is executed, it results in sending a REST API request as follows:

```
PUT https://contosokeyvaulthsm.vault.azure.net/keys/ContosoFirstHSMKey?api-version=7.0
```

Request body:
```json
{
  "key": {
    "kty": "RSA-HSM",
    "key_ops": [
      "decrypt",
      "encrypt",
	:
	:
    ],
    "key_hsm": "<Base64 encoded BYOK_BLOB>"
  },
  "attributes": {
    "enabled": true
  }
}
```
“key_hsm” value is the entire contents of the KeyTransferPackage-ContosoFirstHSMkey.byok encoded in the Base64 format.

## References

### Azure Key Vault Rest API

* [Create key](https://docs.microsoft.com/rest/api/keyvault/createkey/createkey)
* [Get key(key attributes and public key only)](https://docs.microsoft.com/rest/api/keyvault/getkey/getkey)
* [Import key](https://docs.microsoft.com/rest/api/keyvault/importkey/importkey)


### Azure Key Vault CLI commands
* [az keyvault key create](https://docs.microsoft.com/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-create)
* [az keyvault key download](https://docs.microsoft.com/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-download)
* [az keyvault key import](https://docs.microsoft.com/cli/azure/keyvault/key?view=azure-cli-latest#az-keyvault-key-import)


## Next Steps
* Step-by-step BYOK instructions: [Import HSM-protected keys to Key Vault (BYOK)](hsm-protected-keys.byok.md)

