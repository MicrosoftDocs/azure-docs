<properties
    pageTitle="Geo-Replication for Azure SQL Database using Transact-SQL"
    description="Geo-Replication for Azure SQL Database using Transact-SQL"
    services="sql-database"
    documentationCenter=""
    authors="carlrabeler"
    manager="jeffreyg"
    editor=""/>

<tags
    ms.service="sql-database"
    ms.devlang="NA"
    ms.topic="article"
    ms.tgt_pltfrm="NA"
    ms.workload="data-management"
    ms.date="09/19/2015"
    ms.author="carlrab"/>

# Geo-Replication for Azure SQL Database using Transact-SQL



> [AZURE.SELECTOR]
- [Azure Preview Portal](sql-database-geo-replication-portal.md)
- [PowerShell](sql-database-geo-replication-powershell.md)
- [Transact-SQL](sql-database-geo-replication-transact-sql.md)


This article shows you how to configure geo-replication for an Azure SQL Database using Transact-SQL.

To configure geo-replication, you need the following:

- An Azure subscription - If you do not have an Azure subscription, simply click **FREE TRIAL** at the top of this page, and then come back to finish this article.
- A logical Azure SQL Database server <MyLocalServer> and a SQL database <MyDB> - The primary database that you want to replicate to a different geographical region.
- One or more logical Azure SQL Database servers <MySecondaryServer(n)> - The logical servers that will be the parter servers in which you will create geo-replication secondary databases and a database copy.
- A login that is DBManager on the primary, have db_ownership of the local database that you will geo-replicate, and be DBManager on the partner server(s) to which you will configure geo-replication.
- Newest version of SQL Server Management Studio - To obtain the newest version of SQL Server Management Studio (SSMS), go to [Download SQL Server Management Studio] (https://msdn.microsoft.com/library/mt238290.aspx). For information on using SQL Server Management Studio to manage an Azure SQL Database logical servers and databases, see [Managing Azure SQL Database using SQL Server Management Studio](sql-database-manage-azure-ssms.md)



## Connect to a SQL Database logical server

Connecting to SQL Database requires that you know the server name on Azure and have created a firewall rule for the IP address of the client from which you are connecting using Management Studio. You might need to sign in to the portal to get this information and accomplish this task.

1.  Sign in to the [Azure Management Portal](http://manage.windowsazure.com).

2.  In the left pane, click **SQL Databases**.

3.  On the SQL Databases home page, click **SERVERS** at the top of the page to list all of the servers associated with your subscription. Find the name of the server to which you want to connect and copy it to the clipboard.

	Next, configure your SQL Database firewall to
allow connections from your local machine. You do this by adding your local machines IP address to the firewall exception list.

1.  On SQL Databases home page, click **SERVERS** and then click the server to which you want to connect.

2.  Click **Configure** at the top of the page.

3.  Copy the IP address in CURRENT CLIENT IP ADDRESS.

4.  In the Configure page, **Allowed IP Addresses** includes three boxes where you can specify a rule name and a range of IP addresses as starting and ending values. For a rule name, you might enter the name of your computer. For the start and end range, paste in the IP address of your computer into both boxes, and then click the checkbox that appears.

	The rule name must be unique. If this is your development computer, you can enter the IP address in both the IP range start box and the IP range end box. Otherwise, you might need to enter a broader range of IP addresses to accommodate connections from additional computers in your organization.

5. Click **SAVE** at the bottom of the page.

    **Note:** There can be up as much as a five-minute delay for changes
    to the firewall settings to take effect.

	You are now ready to connect to SQL Database using Management Studio.

1.  On the taskbar, click **Start**, point to **All Programs**, point to
    **Microsoft SQL Server 2014**, and then click **SQL Server
    Management Studio**.

2.  In **Connect to Server**, specify the fully-qualified
    server name as <MyLocalServer>.database.windows.net. On Azure, the server name is an autogenerated string composed of alphanumeric characters.

3.  Select **SQL Server Authentication**.

4.  In the **Login** box, enter the SQL Server administrator login that you
    specified in the portal when you created  your server.

5.  In the **Password** box, enter the password that you specified in
    the portal when you created  your server.

8.  Click **Connect** to establish the connection.



## Add secondary database

You can use the **ALTER DATABASE** statement to create a geo-replicated secondary database on a partner server. You execute this statement on the master database of the server containing the database to be replicated. The geo-replicated database (the "primary database") will have the same name as the database being replicated and will, by default, have the same service level as the primary database. The secondary database can be readable or non-readable, and can be a single database or an elastic databbase. For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/).
After the secondary database is created and seeded, data will begin replicating asynchronously from the primary database. The steps below describe how to configure geo-replication using Management Studio. Steps to create non-readable and readable secondaries, either with a single database or an elastic database, are provided.
> [AZURE.NOTE] If the secondary database exists on the specified parther server (for example, because a geo-replication relationship currently exists or previously existed, the command will fail.


### Add non-readable secondary (single database)

Use the following steps to create a non-readable secondary as a single database.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a non-readable secondary database on <MySecondaryServer1>.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer1> WITH ALLOW_CONNECTIONS = NO);

4. Click **Execute** to run the query.


### Add readable secondary (single database)
Use the following steps to create a readable secondary as a single database.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a readable secondary database on a secondary server.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH ALLOW_CONNECTIONS = ALL);

4. Click **Execute** to run the query.



### Add non-readable secondary (elastic database)
Use the following steps to create a non-readable secondary as an elastic database.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a non-readable secondary database on a secondary server in an elastic pool.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer3> WITH ALLOW_CONNECTIONS = NO)
           , ELASTIC_POOL (name = 'MyElasticPool1');

4. Click **Execute** to run the query.



### Add readable secondary (elastic database)
Use the following steps to create a readable secondary as an elastic database.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a readable secondary database on a secondary server in an elastic pool.

        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH ALLOW_CONNECTIONS = NO)
           , ELASTIC_POOL (name = 'MyElasticPool2');

4. Click **Execute** to run the query.



## Remove secondary database

You can use the **ALTER DATABASE** statement to permanently terminate the replication partnership between a secondary database and its primary. This statement is executed on the master database on which the primary database resides. After the relationship termination, the secondary database becomes a regular read-write database. If the connectivity to secondary database is broken the command succeeds but the secondary will become read-write after connectivity is restored. For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/).

Use the following steps to remove geo-replicated secondary from a geo-repliocation partnership.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to remove a geo-replicated secondary.

        ALTER DATABASE <MyDB>
           REMOVE SECONDARY ON SERVER <MySecondaryServer1>;

4. Click **Execute** to run the query.


## Initiate a planned failover promoting a secondary database to become the new primary

You can use the **ALTER DATABASE** statement to promote a secondary database to become the new primary database in a planned fashion, demoting the existing primary to become a secondary. This statement is executed on the master database on the Azure SQL Database logical server in which the geo-replicated secondary database that is being promoted resides. This functionality is designed for planned failover, such as during the DR drills, and requires that the primary database be available.

The command performs the following workflow:

1. Temporarily switches replication to synchronous mode, causing all outstanding transactions to be flushed to the secondary and blocking all new transactions;

2. Switches the roles of the two databases in the geo-replication partnership.  

This sequence guarantees that no data loss will occur. There is a short period during which both databases are unavailable (on the order of 0 to 25 seconds) while the roles are switched. The entire operation should take less than a minute to complete under normal circumstances. For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/).


> [AZURE.NOTE]:  If the primary database is unavailable when the command is issued, the command will fail with the error message indicating that the primary server is not available. In rare cases, it is possible that the operation cannot complete and may appear stuck. In this case, the user can execute the force failover command and accept data loss.

Use the following steps to initiate a planned failover.

1. In Management Studio, connect to the Azure SQL Database logical server in which a geo-replicated secondary database resides.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to make the geo-replicated database  into a geo-replication primary with a readable secondary database on <MySecondaryServer4> in <ElasticPool2>.

        ALTER DATABASE <MyDB> FAILOVER;

4. Click **Execute** to run the query.



## Initiate an unplanned failover from the primary database to the secondary database

You can use the **ALTER DATABASE** statement to promote a secondary database to become the new primary database in an unplanned fashion, forcing the demotion of the existing primary to become a secondary at a time when the primary databse is no longer available. This statement is executed on the master database on the Azure SQL Database logical server in which the geo-replicated secondary database that is being promoted resides.

This functionality is designed for disaster recovery when restoring availability of the database is critical and some data loss is acceptable. When forced failover is invoked, the specified secondary database immediately becomes the primary database and begins accepting write transactions. As soon as the original primary database is able to reconnect with this new primary database, an incremental backup is taken on the original primary database and the old primary database is made into a secondary database for the new primary database; subsequently, it is merely a synchronizing replica of the new primary.

However, because Point In Time Restore is not supported on the secondary databases, if the user wishes to recover data committed to the old primary database that had not been replicated to the new primary database before the forced failover occurred, the user will need to engage support to recover this lost data.

> [AZURE.NOTE]: If the command is issued when the both primary and secondary are online the old primary will become the new secondary but data synchronization will not be attempted. So some data loss may occur.


If the primary database has multiple secondary databases, the command will succeed only on the secondary server on which the command was executed. However, the other secondaries will not know that the forced failover occurred. The user will have to manually repair this configuration using a “remove secondary” API and then reconfigure geo-replication on these additional secondaries.

Use the following steps to forcibly remove geo-replicated secondary from a geo-repliocation partnership.

1. In Management Studio, connect to the Azure SQL Database logical server in which a geo-replicated secondary database resides.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following **ALTER DATABASE** statement to make <MyLocalDB> into a geo-replication primary with a readable secondary database on <MySecondaryServer4> in <ElasticPool2>.

        ALTER DATABASE <MyDB>   FORCE_FAILOVER_ALLOW_DATA_LOSS;

4. Click **Execute** to run the query.

## Monitor Geo-Replication configuration and health

Monitoring tasks include monitoring of the geo-replication configuration and monitoring data replication health.  You can use the **sys.dm_geo_replication_links** dynamic management view in the master database to return information about all exiting replication links for each database on the Azure SQL Database logical server. This view contains a row for each of the replication link between primary and secondary databases. You can use the **sys.dm_replication_status** dynamic management view to return a row for each Azure SQL Database that is currently engaged in a replication replication link. This includes both primary and secondary databases. If more than one continuous replication link exists for a given primary database, this table contains a row for each of the relationships. The view is created in all databases, including the logical master. However, querying this view in the logical master returns an empty set. You can use the **sys.dm_operation_status** dynamic management view to show the status for all database operations including the status of the replication links. For more information, see [sys.dm_geo_replication_links (Azure SQL Database)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm_geo_replication_link_status (Azure SQL Database)](https://msdn.microsoft.com/library/mt575504.aspx), and [sys.dm_operation_status (Azure SQL Database)](https://msdn.microsoft.com/library/dn270022.aspx).

Use the following steps to monitor a geo-repliocation partnership.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following statement to show all databases with geo-replication links.

        SELECT database_id,start_date, partner_server, partner_database,  replication_state, is_target_role, is_non_redable_secondary FROM sys.geo_replication_links;

4. Click **Execute** to run the query.
5. Open the Databases folder, expand the **System Databases** folder, right-click on **MyDB**, and then click **New Query**.
6. Use the following statement to show the replication lags and last replication time of my secondary databases of MyDB.

        SELECT link_guid, partner_server, last_replication, replication_lag_sec FROM sys.dm_ replication_status

7. Click **Execute** to run the query.
8. Use the following statement to show the most recent geo-replication operations associated with database MyDB.

        SELECT * FROM sys.dm_ operation_status where major_resource_is = 'MyDB'
        ORDER BY start_time DESC

9. Click **Execute** to run the query.

## Copy a database

A new database is created in the same or different logical server using a default or user selected service objective, including a named elastic pool. You can use the **CREATE DATABASE**. This statement is executed on the master database for the server on which the copy will be created. The copied database on the specified server will, by default, have the same service level as the source database. The copied database will be a standard read-write database, and can be a single database or an elastic databbase. For more information, see [CREATE DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/dn268335.aspx) and [Service Tiers](https://azure.microsoft.com/documentation/articles/sql-database-service-tiers/) and [sys.dm_operation_status (Azure SQL Database)](https://msdn.microsoft.com/library/dn270022.aspx).

Use the following steps to copy a database to another Azure SQL Database logical server.

1. In Management Studio, connect to another Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following statement to show all databases with geo-replication links.

        CREATE DATABASE 'MyCopiedDB (SERVICE_OBJECTIVE = ELASTIC_POOL (name = 'MyElasticPool5))
            AS A COPY OF MyLocalServer.MyDB;

4. Click **Execute** to run the query.


## Monitor a database copy

Since the database copy process is asynchronous the user can monitor the copy state transitions and the completion time. You can use the **sys.dm_database_copy_links** dynamic management view to return information about all existing database copy links for each database on the Azure SQL Database logical server. This statement is executed on the master database for the server from which the copy is being made. You can use the **sys.dm_operation_status** dynamic management view to show the status for all database operations including the status of the replication links. For more information, see [sys.dm_database_copy_links (Azure SQL Database)](https://msdn.microsoft.com/library/mt576403.aspx)

Use the following steps to monitor a database copy operation.

1. In Management Studio, connect to your Azure SQL Database logical server.

2. Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.

3. Use the following statement to show all databases copies originating from the current server.

        SELECT * FROM sys.dm_database_copy_links;

4. Click **Execute** to run the query.

5. Use the following statement to show most recent database copy operations associated with database 'MyDB'

        SELECT * FROM sys.dm_ operation_status
            WHERE major_resource_is = 'MyDB'
                AND operation='CREATE DATABASE COPY'
            ORDER BY start_time DESC


## Next steps

- [Disaster Recovery Drills](sql-database-disaster-recovery-drills.md)




## Additional resources

- [Designing cloud applications for business continuity using Geo-Replication](sql-database-designing-cloud-solutions-for-disaster-recovery.md)
- [Business Continuity Overview](sql-database-business-continuity.md)
- [SQL Database documentation](https://azure.microsoft.com/documentation/services/sql-database/)
