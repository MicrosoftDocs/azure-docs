---
title: Monitoring and logging - Azure Video Analyzer service
description: This article provides an overview of monitoring and logging in Azure Video Analyzer service.
ms.topic: how-to
ms.date: 10/07/2021

---
# Monitor and log

In this article, you'll learn how to monitor the Azure Video Analyzer service events.
You'll also learn how to consume the logs that the service generates.

## Taxonomy of events

Below diagram represents common taxonomy used for the events or telemetry data  emitted by Video Analyzer Service:
> [!div class="mx-imgBorder"]
> :::image type="content" source="./media/event-taxonomy-cloud.png" alt-text="Diagram that shows the taxonomy of events.":::

**Event Types:** Service emits following types of event data

* **Operational:** Events generated by the actions of a user or during the execution of a [pipeline](../pipeline.md)
  
   * Volume: Expected to be low (a few times a minute, or even less). Examples:

| Event        | Level               | Short Description                                              |
| ------------- | ------------------- |  ------------------------------------------------------------ |
|RecordingStarted	|Informational|	Media recording started|
|RecordingAvailable	|Informational|	Media recording available|
|RecordingStopped	|Informational|	Media recording stopped|
|PipelineStateChanged	|Informational|	State of pipeline changed|

   *Sample operational event*
      
```json
{
  "time": "2021-10-06T21:19:36.0988630Z",
  "resourceId": "/SUBSCRIPTIONS/SUBSCRIPTIONID/RESOURCEGROUPS/TEST/PROVIDERS/MICROSOFT.MEDIA/VIDEOANALYZERS/AVASAMPLE5LFGGVOMCM7VA",
  "region": "westcentralus",
  "category": "Operational",
  "operationName": "Microsoft.VideoAnalyzer.Operational.RecordingStarted",
  "operationVersion": "1.0",
  "level": "Informational",
  "correlationId": "c7887efd-0043-4ada-aa3d-9a411e612497",
  "traceContext": "{\n  \"traceId\": \"e74a9d4c-c4b9-4024-9acf-06be76d978ad\"\n}",
  "properties": {
    "subject": "/livePipelines/livepipeline/sinks/videoSink",
    "body": {
      "type": "video",
      "location": "/videos/livetest1",
      "startTime": "2021-10-06T21:19:32.520Z"
    }
  }
}
```

* **Diagnostics:** Events that help to diagnose problems and/or performance.

   * Volume: Can be high (several times a minute), it could also impact storage cost. Recommended to only enable these events when diagnosis is needed or for troubleshooting purposes. Examples:
    
| Event             | Level           | Short Description                                            |
| ----------------- | ----------------| ------------------------------------------------------------ |
|AuthenticationError|Error|Server/Client authentication error|
|AuthorizationError |	Error|	Server/Client authorization error|
|FormatError        |	Error|	Packaging, format or encoding issues|
|MediaSessionEstablished|	Informational|	SDP or other session information|
|NetworkError        |	Error|	DNS, Network Error|
|ProtocolError        |	Error|	RTSP or any other protocol error|
|StorageError        |	Error|	Storage read/write error|
|RtspPlaybackSessionEstablished|	Informational| RTSP Playback session is establised|	
|RtspPlaybackSessionClosed|	Informational|	RTSP Playback session is closed|

*Sample diagnostic event*
  
```json
{
  "time": "2021-10-06T21:19:34.1290000Z",
  "resourceId": "/SUBSCRIPTIONS/SUBSCRIPTIONID/RESOURCEGROUPS/NEWIGNITERELEASETEST/PROVIDERS/MICROSOFT.MEDIA/VIDEOANALYZERS/AVASAMPLE5LFGGVOMCM7VA",
  "region": "westcentralus",
  "category": "Diagnostics",
  "operationName": "Microsoft.VideoAnalyzer.Diagnostics.MediaSessionEstablished",
  "operationVersion": "1.0",
  "level": "Informational",
  "traceContext": "{\n  \"traceId\": \"b03cabe2-b9d1-4be7-9770-4ac9e4fdc012\"\n}",
  "properties": {
    "subject": "/livePipelines/livepipesample/sources/rtspSource",
    "body": {
      "sdp": "SDP:\nv=0\r\no=- 0 0 IN IP4 127.0.0.1\r\ns=Azure Media Services\r\nc=IN IP4 127.0.0.1\r\nt=0 0\r\na=tool:libavformat 58.29.100\r\nm=video 0 RTP/AVP 96\r\nb=AS:1250\r\na=rtpmap:96 H264/90000\r\na=fmtp:96 packetization-mode=1; sprop-parameter-sets=Z00AKeKQDwBE/LgLcBAQGkHiRFQ=,aO48gA==; profile-level-id=4D0029\r\na=range:npt=now-\r\na=control:streamid=0\r\n"
    }
  }
}

```
* **Audit:** Event is used to log API access. 
    * Volume: Usually low. Recommended to only enable these events when auditing is needed.

*Sample diagnostic event*
  
```json
{
  "time": "2021-10-07T23:53:31.6792370Z",
  "resourceId": "/SUBSCRIPTIONS/SUBSCRIPTIONID /RESOURCEGROUPS/NEWIGNITERELEASEMAYANK/PROVIDERS/MICROSOFT.MEDIA/VIDEOANALYZERS/AVASAMPLE5LFGGVOMCM7VA",
  "region": "westcentralus",
  "category": "Audit",
  "operationName": "Microsoft.VideoAnalyzer.Audit.ResourceGet",
  "level": "Warning",
  "uri": "https://6e1d86578c9a464480061a5ea2af9ec9.api.westcentralus-private1.videoanalyzer.azure.net/videos/batchjobsinknode",
  "resultType": "Failed",
  "resultSignature": "403",
  "identity": [
    {
      "alg": "RS256",
      "kid": "jrLTTDh9dAJdDDHIXZnySD4EVeI",
      "typ": "JWT"
    },
    {
      "sub": "livetest1",
      "aud": [ "https://6e1d86578c9a464480061a5ea2af9ec9.streaming.westcentralus-private1.videoanalyzer.azure.net/fa24f509-e9b6-41bc-9bd6-c09a5e6a8d10", "wss://6e1d86578c9a464480061a5ea2af9ec9.rtsp-tunnel.westcentralus-private1.videoanalyzer.azure.net/fa24f509-e9b6-41bc-9bd6-c09a5e6a8d10" ],
      "exp": 1633410145,
      "iss": "https://westcentralus-private1.videoanalyzer.azure.net/"
    }
  ],
  "traceContext": "{\n  \"traceId\": \"4bb0dcf5-5c6d-4aa3-8c03-3f3d7e2c6210\"\n}",
  "properties": { "subject": "/videos/batchjobsinknodesample" }
}

```

## Events monitoring

You can use Video Analyzer’s events generated by service to your storage account. Events that originate from the service can be consumed by Azure monitor.

## Event schema

 Events generated by Video Analyzer conform to the [streaming messaging pattern](../../../iot-hub/iot-hub-devguide-messages-construct.md) established by Azure IoT Hub. The pattern consists of system properties, application properties, and a body.

### Common Properties

Every event, when observed via IoT Hub, has a set of common properties:

| Property      | Property type       | Data type | Description                                                  |
| ------------- | ------------------- | --------- | ------------------------------------------------------------ |
| `trace-id`    | system              | guid      | Unique event ID.                                             |
| `resourceId`  | applicationProperty | string    | ARM path for the Azure Video Analyzer account.               |
| `subject`     | applicationProperty | string    | Subpath of the entity emitting the event.                    |
| `time`        | applicationProperty | string    | Time the event was generated.                                |
| `category`    | system              | string    | Audit, Operational, Diagnostics                              |
| `operationName`| applicationProperty| string    | Event type identifier. (See the following section.)          |
| `level`        | system             | string    | Event level (Informational, Warning, Error, Critical)           |
| `body`        | body                | object    | Particular event data.                                       |
| `operationVersion` | system         | string    | Event Data version {Major}.{Minor}                           |

### Properties Sample

```json
// Azure Monitor Logs Event Sample
{
  // Common
  "time": "2021-08-23T12:00:00.000Z",
  "resourceId": "/SUBSCRIPTIONS/{SUBID}/RESOURCEGROUPS/{RGNAME}/PROVIDERS/MICROSOFT.MEDIA/VIDEOANALYZERS/{NAME}",
  "region": "{regionNameWithoutSpaces}",
  "category": "{category}", // Audit, Operational, Diagnostics
  "operationName": "Microsoft.VideoAnalyzer.{EventClass}.{EventName}", // Event Type
  "operationVersion": "1.0", // Event Data Version (present only when the event has data)
  "level": "[Informational|Warning|Error|Critical]", // Event Level
  // Optional (present for request logging)
  "uri": "{Absolute Resource URI}",
  "resultType": "[Started|In Progress|Succeeded|Failed|Active|Resolved]",
  "resultSignature": "{HTTP STATUS CODE WHEN APPLICABLE}",
  "durationMs": 0,
  "callerIpAddress": "{IP Address}",
  "identity": {
    // A JSON blob that describes the identity of the user or application that performed the operation. 
  },
  // Tracing
  "correlationId": "{Optional correlation id for the customer}",
  "traceContext": {
    "traceId": "0af7651916cd43dd8448eb211c80319c" // Event Id
  },
  // Event Properties
  "properties": {
    // Event Headers
    "subject": "/livePipelines/{livePipelineName}/[sources|processors|sinks]/{nodeName}",
    "body": {
      // Event Specific Properties
      "property1": "propertyValue1"
    }
  }
} 
```

## Metrics

You can access pipeline metrics on Azure portal, navigate to Monitoring section of your Video Analyzer account and select metrics.
Below mentioned metrics will be available for pipelines in monitoring section & also archived as logs in the configured storage account.

| Metric name                           | Type    | Labels                                                                              | Description                                                  |
| ------------------------------------- | ------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| IngressBytes              | Counter   | Pipeline                                 | The total number of bytes received by a pipeline. Only supported for RTSP sources.           |
| PipelineCount | Counter   | EntityType, State            | Provides the pipelines in either active (live) or processing (job). Emitted at a regular interval. |
| ActiveRtspPlaybackSessions     | Gauge   | VideoName            | Provides the count of active RTSP playback sessions for a specific video. Emitted at a regular interval. |
| PipelineJobsProcessingCount                 | Counter, Gauge | EntityTypeState | Provides the pipelines in processing state for an account.      |

## Azure Monitor log collection 

Video Analyzer service currently **only supports Azure Monitor** as the recommended way to consume service telemetry events. Use [Azure Monitor](../../../azure-monitor/overview.md) to consume events generated by service, customers have a built-in monitoring experience via Azure Monitor.

Follow the steps to enable monitoring & events collection with Azure Monitor:
* On Azure Portal navigate to Monitoring section of your Video Analyzer account & select Diagnostic settings.
* Click on 'Add Diagnostic setting' to enable the collection of the following logs:
    *	Operational
    *	Diagnostics
    *	Audit
* Select the logs category which you would like to enable and corresponding retention period
* For destination details, select ‘Archive to a storage account’ and specify the storage account where these log events will be stored
    > [!IMPORTANT]
    > Event log storage to log analytics, event hub & partner solution destinations is currently not enabled for Video Analyzer service
* Click Save after configuring the diagnostic settings
* To access the diagnostic logs, navigate to your storage account & you will see a container "insights-logs-category". This container will have logs in a json file format. 
* Download the desired log file and content of the file would look similar to sample below:

```json
{
    "time": "2021-10-06T21:19:36.0988630Z",
    "resourceId": "/SUBSCRIPTIONS/35C2594A-23DA-4FCE-B59C-F6FB9513EEEB/RESOURCEGROUPS/TEST/PROVIDERS/MICROSOFT.MEDIA/VIDEOANALYZERS/AVASAMPLE5LFGGVOMCM7VA",
    "region": "westcentralus",
    "category": "Operational",
    "operationName": "Microsoft.VideoAnalyzer.Operational.RecordingStarted",
    "operationVersion": "1.0",
    "level": "Informational",
    "correlationId": "c7887efd-0043-4ada-aa3d-9a411e612497",
    "traceContext": "{\n  \"traceId\": \"e74a9d4c-c4b9-4024-9acf-06be76d978ad\"\n}",
    "properties": {
        "subject": "/livePipelines/livepipemayank/sinks/videoSink",
        "body": {
            "type": "video",
            "location": "/videos/livetest1",
            "startTime": "2021-10-06T21:19:32.520Z"
        }
    }
}
{
    "time": "2021-10-06T21:19:34.1290000Z",
    "resourceId": "/SUBSCRIPTIONS/35C2594A-23DA-4FCE-B59C-F6FB9513EEEB/RESOURCEGROUPS/TEST/PROVIDERS/MICROSOFT.MEDIA/VIDEOANALYZERS/AVASAMPLE5LFGGVOMCM7VA",
    "region": "westcentralus",
    "category": "Diagnostics",
    "operationName": "Microsoft.VideoAnalyzer.Diagnostics.MediaSessionEstablished",
    "operationVersion": "1.0",
    "level": "Informational",
    "traceContext": "{\n  \"traceId\": \"b03cabe2-b9d1-4be7-9770-4ac9e4fdc012\"\n}",
    "properties": {
        "subject": "/livePipelines/livepipe/sources/rtspSource",
        "body": {
            "sdp": "SDP:\nv=0\r\no=- 0 0 IN IP4 127.0.0.1\r\ns=Azure Media Services\r\nc=IN IP4 127.0.0.1\r\nt=0 0\r\na=tool:libavformat 58.29.100\r\nm=video 0 RTP/AVP 96\r\nb=AS:1250\r\na=rtpmap:96 H264/90000\r\na=fmtp:96 packetization-mode=1; sprop-parameter-sets=Z00AKeKQDwBE/LgLcBAQGkHiRFQ=,aO48gA==; profile-level-id=4D0029\r\na=range:npt=now-\r\na=control:streamid=0\r\n"
        }
    }
```

**Activity log** is also generated automatically and can be accessed by selecting 'Activity log' in the Video Analyzer account management blade under overview option in left pane.

## FAQ

If you have questions, see the [monitoring and metrics FAQ](../faq.yml#monitoring-and-metrics).
<!-- TODO : link to update above --> <!-- TODO : link to update -->

## Next steps

[Troubleshoot Azure Video Analyzer service](troubleshoot.md)
<!-- TODO : link to update above --> <!-- TODO : link to update -->