---
author: karlerickson
ms.author: v-shilichen
ms.service: spring-apps
ms.topic: include
ms.date: 06/20/2023
---

<!-- 
For clarity of structure, a separate markdown file is used to describe how to observe the application with Basic/Standard plan.

[!INCLUDE [tutorial-applications-observability-with-basic-standard-plan](includes/tutorial-applications-observability/applications-observability-with-basic-standard-plan.md)]

-->

## 2. Add metrics to monitor the application

Azure Spring Apps provides several metrics by default, see [Metrics for Azure Spring Apps](../../concept-metrics.md) for more details. This section provides the steps to use metrics of your application and monitor the metrics in an Azure dashboard. It aggregates frequently used blades on the Azure portal and key metrics charts generated by Azure Spring Apps and Application Insights.

### Add metrics to monitor resource utilization

This section provides the steps to use the default metrics defined by Spring Boot and custom metrics defined in application code, they all are available for applications running on Azure Spring Apps. 

#### Add metrics defined by Spring Boot

Spring Boot registers several metrics, such as JVM, web server related, and logging related. The following instruction will use `JVM Memory` as an example, you can add other interested metrics following the same steps.

1. Go to the Azure Spring Apps instance overview page.

1. Select **Application Insights** in the left navigation menu to go to the Application Insights overview page.

1. Select **Metrics** in the left navigation menu. Select the edit icon in the chart title, rename the chart title to `JVM Memory Used`.

1. Select **Add metric**, for **Metric**, select the corresponding dropdown list to choose the **jvm_memory_used** metric under the **Log-based metrics** namespace, select `Avg` for **Avg**.

1. Select **Apply splitting**, for **Values**, select the corresponding dropdown list to check the **Cloud role name** box.

:::image type="content" source="../../media/tutorial-applications-observability/jvm-memory-used-chart.png" alt-text="Screenshot of the Azure portal with Azure Spring Apps instance jvm memory used chart page." lightbox="../../media/tutorial-applications-observability/jvm-memory-used-chart.png":::

> [!NOTE]
> The metrics are available after the application is deployed and running.

#### Add custom metrics defined in application code

In the PetClinic's source code, the REST controllers are annotated with the Micrometer `@Timed` annotation. This annotation will collect metrics like the number of times a method is called or the execution time of a method. 
The following are the three custom metrics details: 
- `petclinic.owner` and `petclinic.pet` defined in the `customers-service` application.
- `petclinic.visit` defined in the `visits-service` application.

Same as in the previous section, you can define a chart `REST Controller` with custom metrics, and update the **Aggregation** to `Count` for each metrics.

:::image type="content" source="../../media/tutorial-applications-observability/custom-metrics.png" alt-text="Screenshot of the Azure portal with Azure Spring Apps instance overview page." lightbox="../../media/tutorial-applications-observability/custom-metrics.png":::

### Monitor the availability of the application

This section provides the steps to check the liveness for each app on Azure Spring Apps, the liveness of the application is based on the Spring Boot Actuator.

1. Go to the Azure Spring Apps instance overview page.

1. Select **Application Insights** in the left navigation menu, select the **Application Insights** to go to the Application Insights overview page.

1. Select **Availability** in the left navigation menu, select the **Add Standard test** to add a test.

1. On the **Create Standard test** page, for **Test name**, enter `api-gateway` for API gateway app, 
   for **URL**, enter `https://[your-Azure-Spring-Apps-instance-name]-api-gateway.azuremicroservices.io/actuator/health/liveness` for the corresponding URL, 
   extend the **Success criteria**, check the **Content match** box, and enter `UP` for **Content must contain**, then select **Save** to finish the configuration.

1. Repeat the above steps to add other tests with below test names and URLs, make sure the test name and app name are consistent.

   | Test name         | URL                                                                                                                    | Content must contain |
   |-------------------|------------------------------------------------------------------------------------------------------------------------|----------------------|
   | admin-server      | https://[your-Azure-Spring-Apps-instance-name]-admin-server.azuremicroservices.io/actuator/health/liveness             | UP                   |
   | customers-service | https://[your-Azure-Spring-Apps-instance-name]-api-gateway.azuremicroservices.io/api/customer/actuator/health/liveness | UP                   |
   | vets-service      | https://[your-Azure-Spring-Apps-instance-name]-api-gateway.azuremicroservices.io/api/vet/actuator/health/liveness      | UP                   |
   | visits-service    | https://[your-Azure-Spring-Apps-instance-name]-api-gateway.azuremicroservices.io/api/visit/actuator/health/liveness    | UP                   |

### Pin metrics to a dashboard

This section provides the steps to create a custom dashboard.
If you choose to use the built-in dashboard of Application Insights created by Azure Spring Apps,
you can skip the creation of the dashboard and properly custom the dashboard chart, see more from [Application Insights Overview dashboard](../../../azure-monitor/app/overview-dashboard.md).

1. From the Azure portal menu, select **Dashboard**. Your default view might already be set to dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/portal-menu-dashboard.png" alt-text="Screenshot of the Azure portal with Dashboard selected." lightbox="../../media/tutorial-applications-observability/portal-menu-dashboard.png":::

1. Select **Create**, then select **Custom** to create a custom dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/create-dashboard-options.png" alt-text="Screenshot of the New dashboard options." lightbox="../../media/tutorial-applications-observability/create-dashboard-options.png":::

   > [!NOTE]
   > You can also choose a wizard based on Application Insights here to quickly create a default dashboard.

1. Enter a name for the dashboard, and then select **Save**.
   This action opens the **Tile Gallery** page, from which you can select tiles, and an empty grid where you'll arrange the tiles.

> [!NOTE]
> You can allow other users to view your dashboard via a shared dashboard, see more from [Share an Azure dashboard](../../../azure-portal/azure-portal-dashboard-share-access.md).

#### Pin the "App CPU Usage" chart

1. Go to the Azure Spring Apps instance overview page.

1. Select **Metrics** in the left navigation menu, select the edit icon in the chart title, rename the chart title to `App CPU Usage`.

1. Select **Add metric**, for **Metric**, select the corresponding dropdown list to choose the **App CPU Usage** metric, select `Avg` for **Aggregation**.

1. Select **Apply splitting**, for **Values**, select the corresponding dropdown list to check the `App` box.

   :::image type="content" source="../../media/tutorial-applications-observability/chart-app-cpu-usage.png" alt-text="Screenshot of the Azure portal with app cpu usage to dashboard." lightbox="../../media/tutorial-applications-observability/chart-app-cpu-usage.png":::

1. Select **Save to dashboard** to open the dropdown list, then select **Pin to dashboard**, on the **Pin to dashboard** page, select the dashboard you created in previous step, select **Pin** to pin the quickstart chart to the dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/pin-to-dashboard.png" alt-text="Screenshot of the Azure portal with pin to dashboard." lightbox="../../media/tutorial-applications-observability/pin-to-dashboard.png":::

#### Pin the "App Memory Usage" chart

1. Repeat with the previous section steps for the **App Memory Usage** metric, save the **App Memory Usage** chart to the dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/chart-app-memory-usage.png" alt-text="Screenshot of the Azure portal with app memory usage to dashboard." lightbox="../../media/tutorial-applications-observability/chart-app-memory-usage.png":::

#### Pin the "App Network In" chart

1. Repeat with the previous section steps for the **App Network In** metric, 
   select **Add filter** for an extra step, for **Property**, select the corresponding dropdown list to choose the `App`, select `=` for **Operator**, select `admin-server` and `api-gateway` for **Values**, 
   then save the **App Network In Usage** chart to the dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/chart-app-network-in-usage.png" alt-text="Screenshot of the Azure portal with app network in usage to dashboard." lightbox="../../media/tutorial-applications-observability/chart-app-network-in-usage.png":::

#### Pin the "Availability" chart

1. Go to the Azure Spring Apps instance overview page.

1. Select **Application Insights** in the left navigation menu, select the **Application Insights** to go to the Application Insights overview page.

1. Select **Metrics** in the left navigation menu, Select the edit icon in the chart title, rename the chart title to `Availability`.

1. Select **Add metric**, for **Metric**, select the corresponding dropdown list to choose the `Availability` metric under the **Application Insights standard metrics** namespace, select `Avg` for **Aggregation**.

1. Select **Apply splitting**, for **Values**, select the corresponding dropdown list to check the `Test name` box, then save the **Availability** chart to the dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/chart-availability.png" alt-text="Screenshot of the Azure portal with availability to dashboard." lightbox="../../media/tutorial-applications-observability/chart-availability.png":::

#### Pin the "Server exceptions and Dependency call failures" chart

Repeat with the previous section steps for the **Server exception** and **Dependency call failures** metrics under the **Application Insights standard metrics** namespace, save the **Server exceptions and Dependency call failures** chart to the dashboard.

:::image type="content" source="../../media/tutorial-applications-observability/chart-exceptions-and-failures.png" alt-text="Screenshot of the Azure portal with exceptions and failures to dashboard." lightbox="../../media/tutorial-applications-observability/chart-exceptions-and-failures.png":::

#### Pin the "Failed requests" chart

Repeat with the previous section steps for the **Failed requests** metric under the **Application Insights standard metrics** namespace, save the **Failed requests** chart to the dashboard.

:::image type="content" source="../../media/tutorial-applications-observability/chart-failed-requests.png" alt-text="Screenshot of the Azure portal with failed requests to dashboard." lightbox="../../media/tutorial-applications-observability/chart-failed-requests.png":::

#### Pin the "Request count" chart

Repeat with the previous section steps for the **Server requests** metric under the **Application Insights standard metrics** namespace, 
add a filter to filter the **Cloud role name** with **api-gateway** and **admin-server**, 
apply splitting for **Values** with **Cloud role name**,
save the **Request count** chart to the dashboard.

:::image type="content" source="../../media/tutorial-applications-observability/chart-request-count.png" alt-text="Screenshot of the Azure portal with server requests to dashboard." lightbox="../../media/tutorial-applications-observability/chart-request-count.png":::

#### Pin the "Response time" chart

Repeat with the previous section steps for the **Server response time** metric under the **Application Insights standard metrics** namespace, 
add a filter to filter the **Cloud role name** with **api-gateway**, 
save the **Response time** chart to the dashboard.

:::image type="content" source="../../media/tutorial-applications-observability/chart-response-time.png" alt-text="Screenshot of the Azure portal with response time to dashboard." lightbox="../../media/tutorial-applications-observability/chart-response-time.png":::

#### Pin the "Active MySQL connections" chart

Repeat with the previous section steps for the **hikaricp_connection_active** metric under the **Log-based metrics** namespace, save the **Active MySQL connections** chart to the dashboard.

:::image type="content" source="../../media/tutorial-applications-observability/chart-connection-active.png" alt-text="Screenshot of the Azure portal with active connection to dashboard." lightbox="../../media/tutorial-applications-observability/chart-connection-active.png":::

#### Pin more blades to the dashboard

You can pin some blades to the dashboard as needed, it will be convenient to jump to the corresponding page from the dashboard.

1. Go to the Azure Spring Apps instance overview page.

1. Select **Application Insights** in the left navigation menu, select the **Application Insights** to go to the Application Insights overview page.

1. Select **Application map** in the left navigation menu, and select the **Pin blade to dashboard** icon in each page header.

1. On the **Pin to dashboard** page, select the dashboard you created in previous step, select **Pin** to pin the quickstart chart to the dashboard.

   :::image type="content" source="../../media/tutorial-applications-observability/pin-application-map-blade-to-dashboard.png" alt-text="Screenshot of the Azure portal with pin application map to dashboard." lightbox="../../media/tutorial-applications-observability/pin-application-map-blade-to-dashboard.png":::

1. Repeat the previous steps to pin **Live metrics**, **Failures** and **Performance** blades to your dashboard as needed.

#### Monitor the dashboard

Go to your private `PetClinic` dashboard page and edit the tiles in the dashboard as needed for easy monitoring.

:::image type="content" source="../../media/tutorial-applications-observability/dashboard-page.png" alt-text="Screenshot of the Azure portal with dashboard." lightbox="../../media/tutorial-applications-observability/dashboard-page.png":::

## 3. Set alerts based on metrics

This section provides the steps to set up action groups and alert rules to monitor your production application.
The alert rules bind metric patterns with the action groups on the target resource,
when the metric pattern matches the condition, the alert rule is triggered, and the associated action group is executed.

### Set up an action group

1. Go to the Azure Spring Apps instance overview page.

1. Select **Alert** in the left navigation menu, select the **Action groups** to go to the Action groups list page, select the **Create** to create action group.

1. On the **Create action group** page, select the subscription and resource group you want to cover,
   for **Action group name**, enter `email-notifacation`, for **Short name**, enter `email`, for **Region**, select the region you want to use.

   :::image type="content" source="../../media/tutorial-applications-observability/create-email-notification-action-group.png" alt-text="Screenshot of the Azure portal with Action group creation." lightbox="../../media/tutorial-applications-observability/create-email-notification-action-group.png":::

1. Navigate to the **Notification** tab on the **Create action group** page, for **Notification type**, select `Email/SMS message/Push/Voice`, for **Name**, enter `email-support`.

1. On the **Email/SMS message/Push/Voice** page, check the **Email** box, enter your production email address for **Email**, then select **OK** to finish the configuration.
   You can also add other notification types if you want, such as SMS, Azure mobile app notification, Voice, etc.

   :::image type="content" source="../../media/tutorial-applications-observability/email-action-creation.png" alt-text="Screenshot of the Azure portal with email notification action group." lightbox="../../media/tutorial-applications-observability/email-action-creation.png":::

1. Select **Review and Create** to review your selections. Select **Create** to create the action group.

### Set up an alert rule

1. Go to the Azure Spring Apps instance overview page.

1. Select **Alert** in the left navigation menu, select the **Alert rules** to go to the Alert rules list page, select the **Create** to create alert rule.

1. On the **Create an alert rule** page, for **signal name**, select the dropdown list, select **See all signals**, select `App CPU Usage` in the *Metrics* area and select **Apply**;
   for the alert logic section, select **Static** for threshold type, select **Average** for **Aggregation type**, select `Greater than` for **Operator**, enter `90` for **Threshold value**;
   for the **Split by dimensions** section, select the dropdown list to choose `App` for **Dimension name**, use the default `=` for **Operator**,
   select the dropdown list to choose `Select all` for **Dimension values**; keep the default value for **When to evaluate** section.

   :::image type="content" source="../../media/tutorial-applications-observability/alert-rule-creation-app-cpu-usage.png" alt-text="Screenshot of the Azure portal with alert rule condition creation." lightbox="../../media/tutorial-applications-observability/alert-rule-creation-app-cpu-usage.png":::

1. Navigate to the **Actions** tab on the **Create an alert rule** page, select **Select action groups**,
   on the **Select action groups** page, search your email action group name, such as `email-notifacation`, check the corresponding action group, then select **Select** to finish the configuration.

   :::image type="content" source="../../media/tutorial-applications-observability/alert-rule-creation-select-action.png" alt-text="Screenshot of the Azure portal with alert rule action group selection." lightbox="../../media/tutorial-applications-observability/alert-rule-creation-select-action.png":::

1. Navigate to the **Details** tab on the **Create an alert rule** page, enter `app-cpu-high-alert` for **Alert rule name**,

1. Select **Review and Create** to review your selections. Select **Create** to create the alert rule.

1. Create an alert rule for `App Memory Usage` metric signal, and repeat the previous steps, use the below updated inputs:

   - **Signal name**: `App Memory Usage`
   - **Threshold value**: `90`
   - **Dimension name**: `App`
   - **Dimension values**: Select all.
   - **Action group name**: `email-notification`
   - **Alert rule name**: `app-memory-high-alert`

1. Create an alert rule for `App Network In` metric signal, and repeat the previous steps, use the below updated inputs:

   - **Signal name**: `App Network In`
   - **Unit**: `GB`
   - **Threshold value**: `1`
   - **Dimension name**: `App`
   - **Dimension values**: `api-gateway`
   - **Action group name**: `email-notification`
   - **Alert rule name**: `network-in-high-alert`

1. After all the alert rule creation, you can see the alert rules list below:

   :::image type="content" source="../../media/tutorial-applications-observability/alert-rule-list.png" alt-text="Screenshot of the Azure portal with alert rule list." lightbox="../../media/tutorial-applications-observability/alert-rule-list.png":::

### Pin alerts to the dashboard

Go to the Azure Spring Apps instance overview page, select **Alert** in the left navigation menu, and select the **Pin blade to dashboard** icon in this page header to pin the quickstart chart to the dashboard.
