<svg width="1280" height="720" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" overflow="hidden"><defs><clipPath id="clip0"><rect x="0" y="0" width="1280" height="720"/></clipPath></defs><g clip-path="url(#clip0)"><rect x="0" y="0" width="1280" height="720" fill="#FFFFFF"/><rect x="11.5001" y="46.5001" width="1262" height="612" stroke="#A5A5A5" stroke-width="0.666667" stroke-miterlimit="8" fill="#DEEBF7"/><rect x="18.5001" y="87.5001" width="641" height="48" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(27.2 106)">services.AddAuthentication<tspan x="229.667" y="0">(</tspan><tspan x="238.5" y="0">OpenIdConnectDefaults.AuthenticationScheme</tspan><tspan x="609.5" y="0">)</tspan><tspan x="70.6667" y="19">.</tspan><tspan x="79.5" y="19">AddMicrosoftIdentityWebApp</tspan><tspan x="309.167" y="19">(Configuration)</tspan></text><rect x="666.5" y="87.5001" width="603" height="48" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(675.733 106)">services.AddAuthentication<tspan x="229.667" y="0">(</tspan><tspan x="238.5" y="0">JwtBearerDefaults.AuthenticationScheme</tspan><tspan x="574.167" y="0">)</tspan><tspan x="79.5" y="19">.</tspan><tspan x="88.3333" y="19">AddMicrosoftIdentityWebApi</tspan><tspan x="318" y="19">(Configuration)</tspan></text><path d="M0.0413449-0.330759 2.07731-0.0762635 4.07596 0.632934 6.12795 1.78718 8.10242 3.44318 10.0633 5.4673 12.0185 7.92714 13.9067 10.6964 15.7934 13.9038 19.4925 21.3648 22.9385 30.1363 26.2561 40.0892 29.3853 51.1039 32.2008 63.1168 34.7654 75.94 37.0171 89.5126 38.9559 103.647 40.5195 118.282 41.6453 133.292 42.3332 148.49 42.5833 163.87 42.8333 179.182 42.833 179.172 43.5205 194.422 43.5199 194.413 44.6449 209.413 44.6439 209.402 46.2064 224.027 46.2054 224.019 48.0804 238.144 48.0788 238.133 50.3288 251.695 50.3269 251.685 52.8894 264.497 52.8867 264.485 55.7617 276.485 55.7586 276.473 58.8211 287.473 58.8162 287.457 62.1287 297.395 62.122 297.376 65.622 306.126 65.6121 306.104 69.2371 313.541 69.2248 313.518 71.0998 316.706 71.0879 316.687 72.9629 319.437 72.9484 319.418 74.8859 321.855 74.8644 321.831 76.8019 323.831 76.7264 323.772 78.4999 324.773 78.1721 325.354 76.3566 324.329 74.3742 322.283 72.419 319.823 70.5308 317.054 68.6436 313.845 65.0075 306.385 61.4994 297.615 58.1811 287.66 55.1147 276.646 52.2369 264.634 49.6721 251.81 47.4203 238.237 45.544 224.102 43.9805 209.468 42.8547 194.457 42.1668 179.198 41.9167 163.88 41.6667 148.505 41.667 148.515 40.9795 133.328 40.9801 133.337 39.8551 118.337 39.8561 118.348 38.2936 103.723 38.2948 103.733 36.3573 89.6078 36.3587 89.6171 34.1087 76.0546 34.1106 76.0654 31.5481 63.2529 31.5505 63.2636 28.738 51.2636 28.7419 51.2786 25.6169 40.2786 25.6213 40.2929 22.3088 30.3554 22.3147 30.3719 18.8772 21.6219 18.8889 21.6481 15.2014 14.2106 15.2127 14.2315 13.3377 11.044 13.3496 11.0628 11.4746 8.31278 11.4891 8.33241 9.55156 5.89491 9.57309 5.91943 7.63559 3.91943 7.6608 3.9429 5.7233 2.3179 5.77408 2.35302 3.77408 1.22803 3.82603 1.25164 1.88853 0.564143 1.95865 0.580759-0.0413449 0.330759ZM78.7275 320.866 84.4375 327.75 75.5039 328.187Z" fill="#4472C4" transform="matrix(-4.37114e-08 1 1 4.37114e-08 338.5 135.5)"/><path d="M968.432 135.531 968.24 137.572 967.531 139.572 966.445 141.616 964.98 143.591 963.081 145.554 960.868 147.514 955.336 151.285 948.432 154.988 940.41 158.435 931.206 161.754 921.065 164.884 909.989 167.7 898.165 170.265 885.717 172.517 872.706 174.456 859.258 176.019 845.434 177.145 831.424 177.833 817.293 178.083 803.168 178.333 803.179 178.333 789.179 179.021 789.19 179.02 775.377 180.145 775.388 180.144 761.951 181.706 761.96 181.705 748.96 183.58 748.972 183.578 736.472 185.828 736.483 185.826 724.671 188.388 724.684 188.385 713.684 191.26 713.696 191.257 703.572 194.319 703.588 194.314 694.401 197.626 694.421 197.618 686.421 201.118 686.443 201.107 679.568 204.732 679.6 204.713 674.1 208.463 674.134 208.437 671.946 210.375 671.965 210.357 670.089 212.294 670.148 212.212 669.295 213.916 668.699 213.617 669.575 211.868 671.494 209.884 673.707 207.924 679.24 204.152 686.143 200.512 694.164 197.003 703.37 193.684 713.51 190.617 724.522 187.738 736.348 185.173 748.859 182.921 761.869 181.045 775.317 179.481 789.141 178.355 803.151 177.667 817.282 177.417 831.407 177.167 831.396 177.167 845.396 176.48 845.385 176.48 859.198 175.355 859.186 175.357 872.624 173.794 872.613 173.795 885.613 171.858 885.603 171.86 898.041 169.61 898.029 169.612 909.842 167.049 909.83 167.052 920.893 164.24 920.877 164.244 931.002 161.119 930.987 161.124 940.174 157.812 940.156 157.819 948.156 154.381 948.13 154.394 955.005 150.706 954.975 150.725 960.475 146.975 960.441 147.001 962.629 145.063 962.61 145.081 964.485 143.143 964.457 143.176 965.895 141.239 965.868 141.281 966.931 139.281 966.911 139.326 967.598 137.389 967.581 137.469 967.768 135.469ZM673.204 214.045 666.475 219.938 665.799 211.019Z" fill="#4472C4"/><text fill="#4472C4" font-family="Calibri,Calibri_MSFontService,sans-serif" font-weight="400" font-size="19" transform="translate(433.619 167)">My web app or web API calls one or more downstream APIs<tspan x="-413.717" y="-94">I want to build a web app</tspan><tspan x="234.058" y="-93">I want to build a web API</tspan></text><rect x="216.5" y="219.5" width="901" height="243" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(225.333 239)">.<tspan x="8.83334" y="0">EnableTokenAcquisitionToCallDownstreamApi</tspan><tspan x="371" y="0">()</tspan><tspan x="0" y="211">.</tspan><tspan x="8.83334" y="211">AddInMemoryTokenCaches</tspan>() <tspan font-family="Calibri,Calibri_MSFontService,sans-serif" x="229.667" y="211">or</tspan><tspan x="252.5" y="211">AddDistributedTokenCaches</tspan><tspan x="473.333" y="211">()</tspan></text><rect x="392.5" y="370.5" width="685" height="29" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#9DC3E6"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(401.259 390)">.<tspan x="8.83331" y="0">AddDownstreamWebApi</tspan>("<tspan x="194.333" y="0">MyApi</tspan><tspan x="238.5" y="0">",</tspan><tspan x="265" y="0">Configuration.GetSection</tspan><tspan x="477" y="0">("</tspan><tspan fill="#A31515" x="494.667" y="0">ConfigSection</tspan>"))</text><rect x="391.5" y="281.5" width="582" height="29" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#9DC3E6"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(400.944 301)">.<tspan x="8.83334" y="0">AddMicrosoftGraph</tspan>(<tspan x="167.833" y="0">Configuration.GetSection</tspan><tspan x="379.833" y="0">(</tspan><tspan fill="#A31515" x="388.667" y="0">"</tspan><tspan fill="#A31515" x="397.5" y="0">C</tspan><tspan fill="#A31515" x="406.333" y="0">onfigSection</tspan><tspan fill="#A31515" x="512.333" y="0">"</tspan><tspan x="521.167" y="0">))</tspan></text><path d="M255.508 265.167 268.268 265.48 280.66 266.481 292.175 267.983 297.561 268.922 302.573 269.925 307.149 271.053 311.287 272.244 314.994 273.501 318.084 274.825 320.62 276.22 322.479 277.631 323.741 279.091 324.135 280.603 324.51 282.041 324.44 281.907 325.627 283.282 325.582 283.239 327.395 284.676 327.342 284.642 329.842 285.955 329.819 285.944 332.881 287.256 332.862 287.249 336.549 288.561 336.53 288.555 340.655 289.742 340.638 289.738 345.201 290.8 345.194 290.799 350.194 291.862 350.179 291.859 355.554 292.734 355.543 292.732 367.043 294.232 367.027 294.23 379.34 295.23 379.321 295.229 385.406 295.378 385.39 296.045 379.295 295.896 366.965 294.894 355.452 293.392 350.064 292.515 345.053 291.45 340.479 290.385 336.335 289.193 332.628 287.873 329.544 286.551 327.005 285.218 325.143 283.742 323.885 282.284 323.49 280.772 323.115 279.334 323.185 279.468 321.998 278.093 322.049 278.141 320.236 276.766 320.277 276.792 317.777 275.417 317.806 275.431 314.744 274.119 314.768 274.128 311.081 272.878 311.095 272.883 306.97 271.695 306.983 271.699 302.42 270.574 302.435 270.577 297.435 269.577 297.443 269.578 292.068 268.641 292.082 268.643 280.582 267.143 280.598 267.145 268.223 266.145 268.242 266.146 255.492 265.833ZM384.163 291.68 392.063 295.875 383.967 299.678Z" fill="#4472C4"/><text fill="#4472C4" font-family="Calibri,Calibri_MSFontService,sans-serif" font-weight="400" font-size="19" transform="translate(342.248 271)">Downstream API is Microsoft Graph:</text><path d="M255.518 272.167 261.473 272.481 267.318 273.423 273.16 274.931 278.813 276.941 284.278 279.453 289.552 282.467 294.511 285.857 299.157 289.561 303.429 293.645 307.26 298.041 310.653 302.628 313.545 307.469 315.873 312.439 317.572 317.538 318.643 322.704 319.02 327.914 319.395 333.101 319.389 333.058 320.452 338.246 320.441 338.207 322.129 343.27 322.114 343.234 324.427 348.171 324.41 348.14 327.285 352.89 327.271 352.868 330.584 357.493 330.56 357.465 334.435 361.777 334.418 361.759 338.668 365.822 338.649 365.805 343.212 369.555 343.184 369.535 348.184 372.847 348.167 372.836 353.354 375.836 353.327 375.822 358.764 378.322 358.737 378.311 364.362 380.311 364.333 380.302 370.146 381.802 370.109 381.795 375.214 382.511 375.121 383.171 369.998 382.453 364.152 380.944 358.499 378.934 353.034 376.421 347.824 373.409 342.802 370.081 338.216 366.312 333.948 362.232 330.052 357.897 326.722 353.246 323.831 348.47 321.502 343.499 319.802 338.399 318.732 333.171 318.355 327.962 317.98 322.774 317.986 322.818 316.924 317.693 316.934 317.73 315.246 312.668 315.261 312.704 312.948 307.766 312.964 307.796 310.089 302.984 310.107 303.011 306.732 298.448 306.749 298.469 302.936 294.094 302.957 294.116 298.707 290.054 298.73 290.073 294.105 286.386 294.124 286.4 289.187 283.025 289.21 283.039 283.96 280.039 283.986 280.053 278.548 277.553 278.576 277.564 272.951 275.564 272.979 275.573 267.167 274.073 267.197 274.079 261.384 273.142 261.42 273.145 255.483 272.833ZM374.159 378.747 381.813 383.375 373.518 386.721Z" fill="#4472C4"/><text fill="#4472C4" font-family="Calibri,Calibri_MSFontService,sans-serif" font-weight="400" font-size="19" transform="translate(341.955 359)">Downstream API is not<tspan x="176.807" y="0">Microsoft Graph:</tspan><tspan fill="#000000" font-family="Consolas,Consolas_MSFontService,sans-serif" font-size="16" x="56.417" y="-328">ConfigureServices</tspan><tspan fill="#000000" font-family="Consolas,Consolas_MSFontService,sans-serif" font-size="16" x="206.584" y="-328">(</tspan><tspan fill="#000000" font-family="Consolas,Consolas_MSFontService,sans-serif" font-size="16" x="215.417" y="-328">IServiceCollection</tspan><tspan fill="#000000" font-family="Consolas,Consolas_MSFontService,sans-serif" font-size="16" x="383.25" y="-328">services)</tspan><tspan fill="#000000" font-size="16" x="466.417" y="-328">in</tspan><tspan fill="#000000" font-style="italic" font-size="16" x="482.084" y="-328">Startup.cs</tspan></text><rect x="716.5" y="593.5" width="536" height="29" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(725.142 613)">services.AddDistributedSqlServerCache(options =&gt; {});</text><rect x="716.5" y="555.5" width="536" height="29" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(725.142 575)">services.AddCosmosCache<tspan x="203.167" y="0">(</tspan><tspan x="212" y="0">cacheOptions</tspan><tspan x="326.833" y="0">=&gt; {});</tspan></text><rect x="716.5" y="515.5" width="536" height="29" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(725.142 534)">services.AddStackExchangeRedisCache<tspan x="309.167" y="0">(options =&gt; {});</tspan></text><rect x="717.5" y="476.5" width="534" height="29" stroke="#000000" stroke-linejoin="round" stroke-miterlimit="10" fill="#BDD7EE"/><text font-family="Consolas,Consolas_MSFontService,sans-serif" font-weight="400" font-size="16" transform="translate(726.445 496)">services.AddDistributedMemoryCache<tspan x="300.333" y="0">();</tspan></text><path d="M600.511 456.167 611.461 456.542 622.047 457.67 631.944 459.424 640.781 461.617 644.738 462.936 648.319 464.318 651.402 465.766 654.118 467.282 656.28 468.871 657.888 470.48 658.941 472.19 659.265 473.875 659.577 475.5 659.534 475.388 660.534 477.013 660.486 476.952 662.048 478.514 662.01 478.482 664.135 480.044 664.1 480.021 666.788 481.521 666.764 481.51 669.889 482.947 669.872 482.94 673.372 484.315 673.351 484.307 677.288 485.557 677.269 485.552 686.144 487.802 686.119 487.796 695.994 489.484 695.973 489.481 706.535 490.606 706.512 490.604 710.724 490.75 710.701 491.416 706.477 491.27 695.892 490.143 685.993 488.451 677.096 486.196 673.139 484.939 669.619 483.557 666.474 482.11 663.757 480.593 661.595 479.004 659.987 477.396 658.934 475.685 658.61 474.001 658.298 472.376 658.341 472.487 657.341 470.862 657.389 470.923 655.827 469.361 655.865 469.394 653.74 467.831 653.775 467.854 651.088 466.354 651.108 466.364 648.046 464.927 648.068 464.936 644.505 463.561 644.52 463.566 640.582 462.254 640.607 462.261 631.795 460.074 631.817 460.078 621.942 458.328 621.965 458.332 611.402 457.207 611.426 457.208 600.489 456.833ZM709.518 487.039 717.375 491.313 709.242 495.034Z" fill="#4472C4"/><path d="M601.512 457.167 606.9 457.355 612.243 457.983 622.594 460.242 632.261 463.82 640.985 468.402 644.824 471.045 648.345 473.874 651.433 476.836 654.018 479.989 656.167 483.212 657.687 486.506 658.704 489.873 659.019 493.282 659.332 496.657 659.319 496.591 660.319 499.904 660.303 499.86 661.803 503.11 661.779 503.068 663.904 506.318 663.881 506.286 666.443 509.349 666.418 509.322 669.481 512.26 669.461 512.242 672.899 515.055 672.875 515.037 676.75 517.662 676.718 517.643 685.343 522.205 685.303 522.187 694.928 525.75 694.883 525.737 705.258 527.987 705.221 527.981 709.192 528.378 709.126 529.042 705.135 528.642 694.719 526.383 685.051 522.805 676.391 518.224 672.488 515.58 669.029 512.75 665.944 509.79 663.357 506.699 661.208 503.412 659.688 500.119 658.671 496.752 658.356 493.343 658.043 489.968 658.056 490.034 657.056 486.721 657.072 486.765 655.572 483.515 655.598 483.56 653.473 480.372 653.492 480.399 650.93 477.274 650.957 477.303 647.894 474.366 647.916 474.385 644.416 471.572 644.436 471.587 640.624 468.962 640.658 468.983 631.97 464.42 632.009 464.438 622.384 460.875 622.429 460.888 612.117 458.638 612.149 458.644 606.836 458.019 606.863 458.021 601.488 457.833ZM708.077 524.635 715.813 529.125 707.579 532.619Z" fill="#4472C4"/><path d="M0.0193472-0.332771 10.7894 0.293393 21.5764 2.23757 32.11 5.30986 42.3897 9.50949 52.3541 14.6484 61.9414 20.7892 70.9643 27.6818 79.36 35.3882 87.1286 43.7207 94.1465 52.6811 100.287 62.1428 105.552 71.9823 109.752 82.1382 112.887 92.6103 114.769 103.21 115.03 107.263 114.364 107.306 114.105 103.271 114.109 103.308 112.234 92.7458 112.243 92.7831 109.118 82.3456 109.129 82.3774 104.942 72.2524 104.956 72.2822 99.7061 62.4697 99.7204 62.494 93.5954 53.0565 93.6126 53.0805 86.6126 44.143 86.6312 44.1648 78.8812 35.8523 78.8996 35.8706 70.5246 28.1831 70.5476 28.2024 61.5476 21.3274 61.5702 21.3432 52.0077 15.2182 52.0347 15.2338 42.0972 10.1088 42.1239 10.1211 31.8739 5.93358 31.9067 5.945 21.4067 2.8825 21.4409 2.89055 10.6909 0.953048 10.7307 0.957771-0.0193472 0.332771ZM118.603 105.697 115.125 113.937 110.62 106.211Z" fill="#4472C4" transform="matrix(-4.37114e-08 1 1 4.37114e-08 602.5 454.5)"/><path d="M0.0160632-0.332946 14.2807 0.355262 28.4344 2.29669 42.3364 5.42777 55.9873 9.68587 69.1364 15.0081 81.7222 21.2071 93.6193 28.3453 104.765 36.1727 114.974 44.6904 124.245 53.8359 132.391 63.4854 139.286 73.5771 144.864 84.0438 147.124 89.381 148.944 94.7143 150.45 100.173 151.518 105.576 151.945 109.878 151.282 109.944 150.856 105.658 150.86 105.69 149.798 100.315 149.804 100.339 148.304 94.9011 148.31 94.9201 146.497 89.6076 146.506 89.63 144.256 84.3175 144.268 84.3443 138.706 73.9068 138.725 73.938 131.85 63.8755 131.87 63.9025 123.745 54.2775 123.766 54.2998 114.516 45.1748 114.536 45.1934 104.349 36.6934 104.371 36.7103 93.2459 28.8978 93.266 28.9108 81.391 21.7858 81.4152 21.799 68.8527 15.6115 68.8749 15.6215 55.7499 10.309 55.7757 10.3182 42.1507 6.06821 42.1768 6.07519 28.3018 2.95019 28.3297 2.95524 14.2047 1.01774 14.2339 1.02045-0.0160632 0.332946ZM155.514 108.311 152.062 116.562 147.532 108.85Z" fill="#4472C4" transform="matrix(-4.37114e-08 1 1 4.37114e-08 599.5 456.5)"/><text fill="#4472C4" font-family="Calibri,Calibri_MSFontService,sans-serif" font-weight="400" font-size="19" transform="translate(409.016 568)">It's <tspan font-style="italic" x="26.6667" y="0">not </tspan><tspan x="56.3333" y="0">ok to clear the token </tspan><tspan x="0" y="23">cache on app restart. Add </tspan><tspan x="0" y="45">and</tspan><tspan x="32.8333" y="45">configure a</tspan><tspan x="121.66" y="45">distributed</tspan><tspan x="0" y="68">token cache.</tspan><tspan x="-319.911" y="-73">It's OK if the token cache is </tspan><tspan x="-319.911" y="-50">cleared</tspan><tspan x="-259.824" y="-50">when I restart the </tspan><tspan x="-319.911" y="-28">app. Use an in</tspan><tspan x="-212.411" y="-28">-</tspan>memory<tspan x="-319.911" y="-5">token cache.</tspan></text><path d="M362.318 462.518 362.004 468.288 360.998 474.073 359.427 479.731 357.29 485.199 354.589 490.537 351.449 495.686 347.87 500.522 343.914 505.042 339.644 509.187 335.059 512.893 330.159 516.222 325.131 518.987 319.851 521.25 314.5 522.95 310.168 523.64 310.064 522.982 314.37 522.296 314.322 522.307 319.634 520.62 319.604 520.631 324.854 518.381 324.824 518.396 329.824 515.646 329.798 515.662 334.673 512.349 334.651 512.366 339.213 508.678 339.19 508.698 343.44 504.573 343.422 504.593 347.359 500.093 347.342 500.114 350.905 495.302 350.888 495.327 354.013 490.202 354 490.225 356.688 484.912 356.675 484.941 358.8 479.504 358.789 479.536 360.351 473.911 360.344 473.943 361.344 468.193 361.34 468.232 361.652 462.482ZM311.856 527.152 303.485 524 311.029 519.195Z" fill="#4472C4"/></g></svg>