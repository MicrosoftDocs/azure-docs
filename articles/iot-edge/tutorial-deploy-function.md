---
# Mandatory fields. See more on aka.ms/skyeye/meta.
title: Deploy Azure Function with Azure IoT Edge | Microsoft Docs 
description: Deploy Azure Function as a module to an edge device
services: iot-edge
keywords: 
author: JimacoMS2
manager: timlt

ms.author: v-jamebr
ms.date: 11/08/2017
ms.topic: article
ms.service: iot-edge

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.devlang:devlang-from-white-list
# ms.suite: 
# ms.tgt_pltfrm:
# ms.reviewer:
---

# Deploy Azure Function as an IoT Hub module - Public preview
You can use Azure Functions to deploy code that implements your business logic directly to your IoT Edge devices. This tutorial walks you through creating and deploying an Azure Function that filters sensor data on the simulated IoT Edge device that you created in the [Install Azure IoT Edge tutorial](./tutorial-install-iot-edge.md). In this tutorial, you learn how to:     

> [!div class="checklist"]
> * Use Visual Studio Code to create an Azure Function
> * Use VS Code and Docker to create a Docker image and publish it to your registry 
> * Deploy the module to your IoT Edge device
> * View generated data


The Azure Function that you create in this tutorial filters the temperature data generated by your device and only sends messages upstream to Azure IoT Hub when the temperature is above a specified threshold. 

## Prerequisites

* The Azure IoT Edge device that you created in the [Install Azure IoT Edge tutorial](./tutorial-install-iot-edge.md).
* [Visual Studio Code](https://code.visualstudio.com/). 
* The following Visual Studio Code extensions: 
  * [C# for Visual Studio Code (powered by OmniSharp) extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode.csharp). (You can install the extension from the extensions panel in Visual Studio Code.)
  * **Azure IoT Edge extension**

    > [!IMPORTANT]
    > The IoT Edge extension is not yet available in Marketplace. Perform the following steps to install it:
    > 1. Install the [Azure IoT Toolkit extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit) from the extensions panel in VS Code.
    > 2. Download the **Azure IoT Edge extension** VSIX here: [https://aka.ms/edge-extension](https://aka.ms/edge-extension). **Note**: If you use Microsoft Edge or Internet Explorer, the browser downloads the file with a ".zip" file extension. After the file downloads, you need to change the file extension back to ".vsix".
    > 3. Install the extension VSIX by using the **View | Command Palette... | Extensions: Install from VSIX...** menu command, navigating to the downloaded VSIX on your computer and clicking **Open**. (You can also install the extension by clicking **...** in the upper-right corner of the extension panel and selecting **Install from VSIX...**.)
* [Docker](https://docs.docker.com/engine/installation/). The Community Edition (CE) for your platform is sufficient for this tutorial. 
* [.NET Core 2.0 SDK](https://www.microsoft.com/net/core#windowscmd). 

## Bug Bash Configuration steps
The steps in this section are only required until Azure IoT Edge goes public. They walk you through setting up VS Code with dependencies that will not be public until we release Azure IoT Edge. 
 
1. Install version 3 or later of the [NuGet CLI](https://docs.microsoft.com/en-us/nuget/guides/install-nuget#nuget-cli). The module code depends on a couple of NuGet packages that won't be made public until we release Azure IoT Edge. For the time being, we have placed them on `myget`. You need the NuGet CLI to reference these packages. 
2. Open Visual Studio Code. 
3. Use the **View | Integrated Terminal** menu command to open the VS Code integrated terminal.
1. In integrated terminal, add a NuGet source for the **AzureIotEdgeFunction** template NuGet package.  

    ```cmd/sh
    nuget sources add -name AzureIoTEdgeFunction -source https://www.myget.org/F/dotnet-template-azure-iot-edge-function/api/v3/index.json  
    ``` 

## Choose or sign up for a Docker registry
In this tutorial, you use the Azure IoT Edge extension for VS Code to create an Azure Function and build a [Docker image](https://docs.docker.com/glossary/?term=image) with it. Then you push this Docker image to a [Docker repository](https://docs.docker.com/glossary/?term=repository) hosted by a [Docker registry](https://docs.docker.com/glossary/?term=registry). Finally, you deploy your Docker image packaged as a [Docker container](https://docs.docker.com/glossary/?term=container) from your registry to your IoT Edge device.  

You can use any Docker-compatible registry for this tutorial. Two popular Docker registry services available in the cloud are **Azure Container Registry** and **Docker Hub**:

- [Azure Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/) is available with a [paid subscription](https://azure.microsoft.com/en-us/pricing/details/container-registry/). For this tutorial, the **Basic** subscription is sufficient. 

- [Docker Hub](https://docs.docker.com/docker-hub/repos/#viewing-repository-tags) offers one free private repository if you sign up for a (free) Docker ID. 
    1. To sign up for a Docker ID, follow the instructions in [Register for a Docker ID](https://docs.docker.com/docker-id/#register-for-a-docker-id) on the Docker site. 

    2. To create a private Docker repository, follow the instructions in [Creating a new repository on Docker Hub](https://docs.docker.com/docker-hub/repos/#creating-a-new-repository-on-docker-hub) on the Docker site.

Throughout this tutorial, where appropriate, commands are provided for both Azure Container Registry and Docker Hub.

## Create an IoT Edge function project
The following steps show you how to create an IoT Edge function using Visual Studio Code and the Azure IoT Edge extension.
1. Open VS Code.
2. Use the **View | Integrated Terminal** menu command to open the VS Code integrated terminal.
3. In the integrated terminal, enter the following command to install (or update) the **AzureIoTEdgeFunction** template in dotnet:

    ```cmd/sh
    dotnet new -i Microsoft.Azure.IoT.Edge.Function
    ```
2. In the integrated terminal, enter the following command to create a project for the new module:

    ```cmd/sh
    dotnet new aziotedgefunction -n FilterFunction
    ```

    >[!NOTE]
    > This command creates the project folder, **FilterFunction**, in the current working folder. If you want to create it in another location, change directories before running the command.

3. Use the  **File | Open Folder** menu command, browse to the **FilterFunction**  folder, and click **Select Folder** to open the project in VS Code.
4. In VS Code explorer, click the **EdgeHubTrigger-Csharp** folder, then click the **run.csx** file to open it.
5. Add the following statement after the `#r "Microsoft.Azure.Devices.Client"` statement:

    ```csharp
    #r "Newtonsoft.Json"
    ```

5. Add the following using statements after the existing `using` statements:

    ```csharp
    using Newtonsoft.Json;
    ```

1. Add the following classes. These classes define the expected schema for the body of incoming messages.

    ```csharp
    class MessageBody
    {
        public Machine machine {get;set;}
        public Ambient ambient {get; set;}
        public string timeCreated {get; set;}
    }
    class Machine
    {
       public double temperature {get; set;}
       public double pressure {get; set;}         
    }
    class Ambient
    {
       public double temperature {get; set;}
       public int humidity {get; set;}         
    }
    ```

1. Replace the body of the **Run** method with the following code. It filters messages based on the temperature value in the body of the message and the temperature threshold value.

    ```csharp
    const int temperatureThreshold = 25;

    byte[] messageBytes = messageReceived.GetBytes();
    var messageString = System.Text.Encoding.UTF8.GetString(messageBytes);

    if (!string.IsNullOrEmpty(messageString))
    {
        // Get the body of the message and deserialize it
        var messageBody = JsonConvert.DeserializeObject<MessageBody>(messageString);
        
        if (messageBody != null && messageBody.machine.temperature > temperatureThreshold)
        {
            // We will send the message to the output as the temperature value is greater than the threashold
            var filteredMessage = new Message(messageBytes);
            // We need to copy the properties of the original message into the new Message object
            foreach (KeyValuePair<string, string> prop in messageReceived.Properties)
            {
                filteredMessage.Properties.Add(prop.Key, prop.Value);
            }
            // We are adding a new property to the message to indicate it is an alert
            filteredMessage.Properties.Add("MessageType", "Alert");
            // Send the message        
            await output.AddAsync(filteredMessage);
            log.Info("Received and transfered a message with temperature above the threshold");
        }
    }
    ```

11. Save the file.

## Create a Docker image and publish it to your registry

1. Build the Docker image.
    > [!IMPORTANT]
    > **For Bug Bash**, to create the Docker image, you will need to access the private registry hosting the function base image. In integrated terminal, run the following command before proceeding with the steps below: 
    > 
    > ```csh/sh
    > docker login --username "EdgePreview" --password "L0K1xGpPa88BAWu847=LWAarMsuN+obs" edgepreview.azurecr.io 
    > ```
  
    1. In VS Code explorer, click the **Docker** folder to open it. Then click the **linux-x64** folder, right-click the **Dockerfile** file, and click **Build IoT Edge module Docker image**. 
    2. In the **Select Folder** box, navigate to the **Docker/linux-x64** folder, and click **Select Folder as EXE_DIR**. 
    3. In the pop-up text box at the top of the VS Code window, enter the image name. For example, `<docker registry address>/filterfunction:latest`; where *docker registry address* is your Docker ID if you are using Docker Hub or is similar to `<your registry name>.azurecr.io`, if you are using Azure Container Registry.
 
4. Sign in to Docker. In integrated terminal, enter the following command: 

    - Docker Hub (enter your credentials when prompted):
        
        ```csh/sh
        docker login
        ```

    - Azure Container Registry:
        
        ```csh/sh
        docker login -u <username> -p <password> <Login server>
        ```
        
        To find the user name, password and login server to use in this command, go to the [Azure portal] (https://portal.azure.com). From **All resources**, click the tile for your Azure container registry to open its properties, then click **Access keys**. Copy the values in the **Username**, **password**, and **Login server** fields. The login server sould be of the form: `<your registry name>.azurecr.io`.

3. Push the image to your Docker repository. Use the **View | Command Palette ... | Edge: Push IoT Edge module Docker image** menu command and enter the image name in the pop-up text box at the top of the VS Code window. Use the same image name you used in step 1.c.

## Add registry credentials to Edge runtime on your Edge device
Add the credentials for your registry to the Edge runtime on the computer where you are running your Edge device. This gives the runtime access to pull the container. 

- For Windows, run the following command:
    
    ```cmd/sh
    iotedgectl login --address <docker-registry-address> --username <docker-username> --password <docker-password> 
    ```

- For Linux, run the following command:
    
    ```cmd/sh
    sudo iotedgectl login --address <docker-registry-address> --username <docker-username> --password <docker-password> 
    ```

## Run the solution

1. In the **Azure portal**, [https://df.onecloud.azure-test.net/](https://df.onecloud.azure-test.net/), navigate to your IoT hub.
2. Go to **IoT Edge Explorer** and select your IoT Edge device.
1. Select **Set Modules**. 
2. Add the **tempSensor** module. This step is only required if you have not previously deployed the **tempSensor** module to your IoT Edge device.
    1. Select **Add IoT Edge Module**.
    2. In the **Name** field, enter `tempSensor`.
    3. In the **Image** field, enter `edgepreview.azurecr.io/azureiotedge/simulated-temperature-sensor:1.0-preview`.
    4. Leave the other settings unchanged and click **Save**.
1. Add the **filterfunction** module.
    1. Select **Add IoT Edge Module** again.
    2. In the **Name** field, enter `filterfunction`.
    3. In the **Image** field, enter your image address; for example `<docker registry address>/filterfunction:latest`.
    74. Click **Save**.
2. Click **Next**.
3. In the **Specify Routes** step, copy the JSON below into the text box. Modules publish all messages to the Edge runtime. Declarative rules in the runtime define where those messages flow. In this tutorial, you need two routes. The first route transports messages from the temperature sensor to the filter module via the "input1" endpoint, which is the endpoint that you configured with the  **FilterMessages** handler. The second route transports messages from the filter module to IoT Hub. In this route, `upstream` is a special destination that tells Edge Hub to send messages to IoT Hub. 

    ```json
    {
       "routes":{
          "sensorToFilter":"FROM /messages/modules/tempSensor/outputs/temperatureOutput INTO BrokeredEndpoint(\"/modules/filterfunction/inputs/input1\")",
          "filterToIoTHub":"FROM /messages/modules/filterfunction/outputs/* INTO $upstream"
       }
    }
    ```

4. Click **Next**.
5. In the **Review Template** step, click **Submit**. 
6. Return to the IoT Edge device details page and click **Refresh**. You should see the new **filterfunction** module running along with the **tempSensor** module and the **IoT Edge runtime**. 

## View generated data

To monitor device to cloud messages sent from your IoT Edge device to your IoT hub:
1. Configure the Azure IoT Toolkit extension with connection string for your IoT hub: 
    1. Use the **View | Explorer** menu command to open the VS Code explorer. 
    3. In the explorer, click **IOT HUB DEVICES** and then click **...**. Click **Set IoT Hub Connection String** and enter the connection string for the IoT hub that your IoT Edge device connects to in the pop-up window. 

        To find the connection string, click the tile for your IoT hub in the Azure portal and then click **Shared access policies**. In **Shared access policies**, click the **iothubowner** policy and copy the IoT Hub connection string in the **iothubowner** window.   

1. To monitor data arriving at the IoT hub, use the **View | Command Palette... | IoT: Start monitoring D2C message** menu command. 
2. To stop monitoring data, use the **View | Command Palette... | IoT: Stop monitoring D2C message** menu command. 

## Next steps

In this tutorial, you created an Azure Function that contains code to filter raw data generated by your IoT Edge device. You can continue on to either of the following tutorials to learn about other ways that Azure IoT Edge can help you turn data into business insights at the edge.

> [!div class="nextstepaction"]
> [Create a custom module](tutorial-csharp-module.md)
> [Deploy Azure Stream Analytics as a module](tutorial-deploy-stream-analytics.md)
