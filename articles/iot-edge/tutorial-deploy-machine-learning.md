---
# Mandatory fields. See more on aka.ms/skyeye/meta.
title: Deploy Azure Machine Learning with Azure IoT Edge | Microsoft Docs 
description: Deploy Azure Machine Learning as a module to an edge device
services: iot-edge
keywords: 
author: kgremban
manager: timlt

ms.author: kgremban
ms.date: 11/15/2017
ms.topic: article
ms.service: iot-edge

---

# Deploy Azure Machine Learning as an IoT Edge module - preview

You can use IoT Edge modules to deploy code that implements your business logic directly to your IoT Edge devices. This tutorial walks you through deploying an Azure Machine Learning module that predicts when a device fails based on sensor data on the simulated IoT Edge device that you created in the Deploy Azure IoT Edge on a simulated device on [Windows][lnk-tutorial1-win] or [Linux][lnk-tutorial1-lin] tutorials. You learn how to: 

> [!div class="checklist"]
> * Create an Azure Machine Learning module
> * Deploy an Azure Machine Learning module to your IoT Edge device
> * View generated data

The Azure Machine Learning module that you create in this tutorial reads the temperature data generated by your device and only sends messages upstream to Azure IoT Hub when it predicts a failure (called an anamoly). 


## Prerequisites

* The Azure IoT Edge device that you created in the quickstart or first tutorial.
* The IoT Hub connection string for the IoT hub that your IoT Edge device connects to.

## Set up a Docker registry
In this tutorial, you use the [AI toolkit for Azure IoT Edge](https://aka.ms/aml-iot-edge-anomaly-detection) to create Docker image containing an Azure Machine Learning model. Then you push this Docker image to [Azure Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/). Finally, you deploy your Docker image packaged as a [Docker container](https://docs.docker.com/glossary/?term=container) from your registry to your IoT Edge device.  

[Azure Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/) is available with a [paid subscription](https://azure.microsoft.com/en-us/pricing/details/container-registry/). For this tutorial, the **Basic** subscription is sufficient. 

## Set up Azure Machine Learning environment
You will need to set up an Azure Machine Learning environment in order to build an Azure ML container that can run as a module on Azure IoT Edge.  

**Set up Azure Machine Learning** - follow the instructions in [Create Azure Machine Learning accounts and install Azure Machine Learning Workbench](https://docs.microsoft.com/en-us/azure/machine-learning/preview/quickstart-installation).  

**Set up Module Management for Azure ML** - you will need to install model management onto a machine in order to deploy and manage your Azure ML container.  Follow the instructions in [Model management setup](https://docs.microsoft.com/en-us/azure/machine-learning/preview/deployment-setup-configuration).

## Create the Azure ML container
This section will have you download trained model files and operationalize them (i.e. convert them into an Azure ML container).  
1. On the machine running Module Management for Azure ML, download [iot_score.py](https://github.com/Azure/ai-toolkit-iot-edge/blob/master/IoT%20Edge%20anomaly%20detection%20tutorial/iot_score.py) and [model.pkl](https://github.com/Azure/ai-toolkit-iot-edge/blob/master/IoT%20Edge%20anomaly%20detection%20tutorial/model.pkl) from the Azure ML IoT Toolkit on GitHub
    1. On Linux:
    ```
    $ sudo wget https://github.com/Azure/ai-toolkit-iot-edge/blob/master/IoT%20Edge%20anomaly%20detection%20tutorial/iot_score.py
    $ sudo wget https://github.com/Azure/ai-toolkit-iot-edge/blob/master/IoT%20Edge%20anomaly%20detection%20tutorial/model.pkl
    ```
    1. On Windows:
    ```
    todo
    ```
1. Deploy the trained model
```
$ az ml service create realtime --model-file model.pkl -f iot_score.py -n machinelearningmodule -r python
```
The service name will also be the name of the docker container image and must be all lower case.
1. View the container repository in Azure Container Services
    1. On the [Azure portal](https://portal.azure.com), navigate to **All Services**, and type "container"
    1. Select **Container registries**
    1. Select your registry. It will match the resource group, location, and subscription that you used to set up Module Management.
    1. Select **Access keys**
    1. Take note of **Login server**, **Username** and **Password**.  You will need these to login from your Edge devices.
    1. Select **Repositories**
    1. Select **machinelearningmodule**
    1. You now have the full image path of the container. Take note of this for the next section. It will look like this:  **<ACR_name>.azureacr.io/machinelearningmodule:1**

## Login to the private repo from Edge

1. Connect to your Edge device
1. Run this command using the properties you noted in the previous section
```
$ sudo iotedgectl login --address ADDRESS --username USERNAME --password PASSWORD
```

## Run the solution

1. On the [Azure portal](https://portal.azure.com), navigate to your IoT hub.
1. Go to **IoT Edge (preview)** and select your IoT Edge device.
1. Select **Set modules**.
1. Add the **tempSensor** module. This step is only required if you have not previously deployed the **tempSensor** module to your IoT Edge device.
    1. Select **Add IoT Edge Module**.
    2. In the **Name** field, enter `tempSensor`.
    3. In the **Image URI** field, enter `microsoft/azureiotedge-simulated-temperature-sensor:1.0-preview`.
    4. Click **Save**.
1. Add the **machinelearningmodule** module.
    1. Select **Add IoT Edge Module**.
    1. In the **Name** field, enter **machinelearningmodule**
    1. In the **Image** field, enter your image address; for example `<ACR_name>.azureacr.io/machinelearningmodule:1`.
    1. Click **Save**.
1. Back in the **Add Modules** step, click **Next**.
1. In the **Specify Routes** step, copy the JSON below into the text box. Modules publish all messages to the Edge runtime. Declarative rules in the runtime define where those messages flow. In this tutorial you need two routes. The first route transports messages from the temperature sensor to the machine learning module via the "amlInput" endpoint, which is the endpoint that all Azure Machine Learning modules use. The second route transports messages from the machine learning module to IoT Hub. In this route, ''amlOutput'' is the endput that all Azure Machine Learning modules use to output data, and ''upstream'' is a special destination that tells Edge Hub to send messages to IoT Hub. 

    ```json
    {
        "routes": {
            "sensorToMachineLearning":"FROM /messages/modules/tempSensor/outputs/temperatureOutput INTO BrokeredEndpoint(\"/modules/machinelearningmodule/inputs/amlInput\")",
            "machineLearningToIoTHub": "FROM /messages/modules/machinelearningmodule/outputs/amlOutput INTO $upstream"
        }
    }
    ``` 

1. Click **Next**. 
1. In the ''Review Template'' step, click ''Submit''. 
1. Return to the device details page and click ''Refresh.''  You should see the new ''machinelearningmodule'' running along with the ''tempSensor module'' and the ''IoT Edge runtime''.

## View generated data

 In VS Code, use the **View | Command Palette... | IoT: Start Monitoring D2C Messages** menu command to monitor data arriving in the IoT Hub. 

## Next steps

In this tutorial, you deployed an IoT Edge module powered by Azure Machine Learning. You can continue on to any of the other tutorials to learn about other ways that Azure IoT Edge can help you turn data into business insights at the edge.

> [!div class="nextstepaction"]
> [Deploy an Azure Function as a module](tutorial-deploy-function.md)

<!--Links-->
[lnk-tutorial1-win]: tutorial-simulate-device-windows.md
[lnk-tutorial1-lin]: tutorial-simulate-device-linux.md