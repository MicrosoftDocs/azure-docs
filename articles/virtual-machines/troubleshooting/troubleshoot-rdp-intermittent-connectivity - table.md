---
title: Remote Desktop disconnects frequently in Azure VM| Microsoft Docs
description: Learn how to troubleshoot the issue in which Remote Desktop disconnects frequently in Azure VM.
services: virtual-machines-windows
documentationCenter: ''
author: genlin
manager: cshepard
editor: ''

ms.service: virtual-machines-windows
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: vm-windows
ms.workload: infrastructure
ms.date: 10/24/2018
ms.author: genli
---

# Remote Desktop disconnects frequently in Azure VM

This article shows how to troubleshoot the issue in which Remote Desktop disconnects frequently in Azure VM.

> [!NOTE] 
> Azure has two different deployment models for creating and working with resources: 
[Resource Manager and classic](../../azure-resource-manager/resource-manager-deployment-model.md). This article describes using the Resource Manager deployment model, which we recommend using for new deployments instead of the classic deployment model.

## Symptom 

You face intermittent Remote Desktop connectivity during your sessions. You can connect to the VM but then the connection drops.

## Cause

This issue may be caused by the Remote Desktop protocol (RDP) Listener is misconfigured. Typically, this problem happens on the Custom VM.

## Solution

Before you follow the steps, [take a snapshot of the OS disk](../windows/snapshot-copy-managed-disk.md) of the affected VM as a backup. 

To resolve the problem, use Serial control or [repair the VM offline](#repair-the-vm-offline) by attaching the OS disk of the VM to a recovery VM.

### Serial Console 

Connect to [Serial Console and open CMD instance](./serial-console-windows.md), then run the commands in the [Reset RDP Listener configuration](#reset-rdp-listener-configuration) section. After that, restart the VM to see if the problem is resolved.

### Repair the VM offline

1. [Attach the OS disk to a recovery VM](../windows/troubleshoot-recovery-disks-portal.md).
2. Once the OS disk is attached to the recovery VM, make sure that the disk is flagged as **Online** in the Disk Management console. Note the drive letter that is assigned to the attached OS disk.
3. Browse to the **\windows\system32\config** folder. Copy all of the files in this folder as a backup, in case a rollback is required.
4. Start the Registry Editor (regedit.exe).
5. Select the **HKEY_LOCAL_MACHINE** key. On the menu, select **File** > **Load Hive**:
6. Browse to the **\windows\system32\config\SYSTEM** folder on the OS disk that you attached. For the name of the hive, enter **BROKENSYSTEM**. The new registry hive is displayed under the **HKEY_LOCAL_MACHINE** key. 
7. Open an elevated prompt command window (Run as administrator), then run commands in the [Reset RDP Listener configuration](#reset-rdp-listener-configuration). 
8. [Recreate the VM by using the OS disk](../windows/troubleshoot-recovery-disks-portal.md), and see if the problem is resolved.


### Reset RDP Listener configuration

| Task                                                                                                                        | Commonads for Serial Console                                                                                                                                                                                                                                                                                                                                                                                                    | Commonads for Repair the VM offline                                                                                                                                                                                                                                                                                                                                                                                                          |
|-----------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Lower the RDP   Security Layer to 0 where the communication between server and client will   use the native RDP encryption. | REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'SecurityLayer' /t REG_DWORD /d 0 /f                                                                                                                                                                                                                                                                                   | REG ADD   "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'SecurityLayer' /t REG_DWORD /d 0 /f                                                                                                                                                                                                                                                                                              |
| Lower the   encryption level to the minimum to allow legacy RDP clients to connect.                                         | REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'MinEncryptionLevel' /t REG_DWORD /d 1 /f                                                                                                                                                                                                                                                                              | REG ADD   "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'MinEncryptionLevel' /t REG_DWORD /d 1 /f                                                                                                                                                                                                                                                                                         |
| Set RDP to load the   user configuration the client machine                                                                 | REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fQueryUserConfigFromLocalMachine' /t   REG_DWORD /d 1 /f                                                                                                                                                                                                                                                              | REG ADD   "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fQueryUserConfigFromLocalMachine' /t   REG_DWORD /d 1 /f                                                                                                                                                                                                                                                                         |
| Enable RDP   Keep-Alive control                                                                                             |  <ul><li>REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal  Server\Winstations\RDP-Tcp" /v 'KeepAliveTimeout' /t REG_DWORD /d 1   /f </li><li>REG ADD "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal   Services" /v 'KeepAliveEnable' /t REG_DWORD /d 1 /f  </li><li> REG ADD   "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" /v   'KeepAliveInterval' /t REG_DWORD /d 1 /f </li></ul>                 | <ul><li>REG ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'KeepAliveTimeout' /t REG_DWORD /d 1 /f </li><li>        REG ADD   "HKLM\BROKENSOFTWARE\Policies\Microsoft\Windows NT\Terminal   Services" /v 'KeepAliveEnable' /t REG_DWORD /d 1 /f  </li><li> REG ADD            "HKLM\BROKENSOFTWARE\Policies\Microsoft\Windows NT\Terminal   Services" /v 'KeepAliveInterval' /t REG_DWORD /d 1 /f </li></ul>    |
| Set RDP Reconnect   control                                                                                                 |  <ul><li>REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritReconnectSame' /t REG_DWORD /d 0   /f </li><li>    REG ADD "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fReconnectSame' /t REG_DWORD /d 1   /f  </li><li>  REG ADD "HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal   Services" /v 'fDisableAutoReconnect' /t REG_DWORD /d 0 /f </li></ul> |  <ul><li>REG ADD   "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritReconnectSame' /t  REG_DWORD /d 0 /f </li><li> REG ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fReconnectSame' /t REG_DWORD /d 1 /f      </li><li>   REG ADD   "HKLM\BROKENSOFTWARE\Policies\Microsoft\Windows NT\Terminal   Services" /v 'fDisableAutoReconnect' /t REG_DWORD /d 0 /f  </li></ul>   |
| Set RDP Session   Time control                                                                                              |  REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritMaxSessionTime' /t REG_DWORD /d   1 /f                                                                                                                                                                                                                                                                       | REG ADD   "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritMaxSessionTime' /t REG_DWORD /d   1 /f                                                                                                                                                                                                                                                                                   |
| Set RDP   Disconnection Time control                                                                                        | <ul><li>REG ADD "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritMaxDisconnectionTime' /t   REG_DWORD /d 1 /f   </li><li>    REG ADD "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'MaxDisconnectionTime' /t REG_DWORD /d 0   /f   </ul></li>                                                                                                                    |  <ul><li>REG ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritMaxDisconnectionTime' /t   REG_DWORD /d 1 /f    </li><li>     REG ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'MaxDisconnectionTime' /t REG_DWORD /d 0   /f </ul></li>                                                                                                                                |
| Set RDP   Connection Time control                                                                                           |  REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'MaxConnectionTime' /t REG_DWORD /d 0 /f                                                                                                                                                                                                                                                                              | REG   ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'MaxConnectionTime' /t REG_DWORD /d 0 /f                                                                                                                                                                                                                                                                                          |
| Set RDP Session   idle Time control                                                                                         |   <ul><li>REG ADD   "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritMaxIdleTime' /t REG_DWORD /d 1   /f   </li><li>          REG ADD "HKLM\SYSTEM\CurrentControlSet\control\Terminal   Server\Winstations\RDP-Tcp" /v ' MaxIdleTime' /t REG_DWORD /d 0 /f      </ul></li>                                                                                                                         |  <ul><li>REG ADD   "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v 'fInheritMaxIdleTime' /t REG_DWORD /d 1   /f          </li><li>    REG ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal   Server\Winstations\RDP-Tcp" /v ' MaxIdleTime' /t REG_DWORD /d 0 /f   </ul></li>                                                                                                                                  |
|Set Limit the maximum concurrent connections                                                                                                                       |         REG ADD "HKLM\SYSTEM\CurrentControlSet\control\Terminal Server\Winstations\RDP-Tcp" /v 'MaxInstanceCount' /t REG_DWORD /d ffffffff /f                                                                                                                                                                                                                                                                                                                                                                                                      |        REG ADD "HKLM\BROKENSYSTEM\ControlSet001\control\Terminal Server\Winstations\RDP-Tcp" /v 'MaxInstanceCount' /t REG_DWORD /d ffffffff /f                                                                                                                                                                                                                                                                                                                                                                                                                 |

