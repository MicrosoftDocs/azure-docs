# Define an One Time Password technical profile in an Azure Active Directory B2C custom policy

[!INCLUDE [active-directory-b2c-advanced-audience-warning](../../includes/active-directory-b2c-advanced-audience-warning.md)]

Azure Active Directory B2C (Azure AD B2C) provides support to manage generation and verification of one time password. This technical profile can be used to generate a code and verify that code later. 

The One Time Password technical profile may also return an error message during code verification. You can design the integration with the One Time Password in the following ways:

- **Validation technical profile** - A validation technical profile calls the One Time Password technical profile to verify a code. The validation technical profile validates the user-provided data before the user journey continues. With the validation technical profile, an error message is display on a self-asserted page.

## Protocol

The **Name** attribute of the **Protocol** element needs to be set to `Proprietary`. The **handler** attribute must contain the fully qualified name of the protocol handler assembly that is used by Azure AD B2C:
`Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null`.

The following example shows a One Time Password technical profile:

```XML
<TechnicalProfile Id="VerifyCode">
  <DisplayName>Validate user input verification code</DisplayName>
  <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
  ...
```

## Generate Code
The first mode of this technical profile is to generate a code. Below are the options that can be configured for this mode.

### Input claims

The **InputClaims** element contains a list of claims required to send to one time password protocol provider. You can also map the name of your claim to the name defined below. 

| ClaimReferenceId | Required | Description |
| --------- | -------- | ----------- |
| identifier | Yes | The identifier to identify the user who needs to verify the code later. It is commonly used as the identifier of the destination where the code is delivered to, for example email address or phone number. |

The **InputClaimsTransformations** element may contain a collection of **InputClaimsTransformation** elements that are used to modify the input claims or generate new ones before sending to the one time password protocol provider.

### Output claims

The **Outputclaims** element contains a list of claims generated by one time password protocol provider. You can also map the name of your claim to the name defined below. 

| ClaimReferenceId | Required | Description |
| --------- | -------- | ----------- |
| otpGenerated | Yes | The generated code whose session is managed by B2C. |


The **OutputClaimsTransformations** element may contain a collection of **OutputClaimsTransformation** elements that are used to modify the output claims or generate new ones.

### Metadata
During code generation, below are the settings you can configure to control how the code is generated and maintained.

| Attribute | Required | Description |
| --------- | -------- | ----------- |
| CodeExpirationInSeconds | No | Time in seconds for how soon the code will expire. The default value is 600 seconds. |
| CodeLength | No | Length of the code. The default value is 6. |
| CharacterSet | No | The character set for the code which is commonly used in regular expression. For example, a-z0-9A-Z. The default value is 0-9. |
| NumRetryAttempts | No | The number of verification attempts before the code is considered invalid. The default value is 5. |
| ReuseSameCode | No | Whether a same code should be given rather than generating a new code each time given the code has not expired and is still valid. The default value is false. |

### Returning error message
There is no error message returned for code generation mode.


### Example
Below is an example of a technical profile used to generate a code

```XML
<TechnicalProfile Id="GenerateCode">
    <DisplayName>Generate Code</DisplayName>
    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
    <Metadata>
        <Item Key="Operation">GenerateCode</Item>
        <Item Key="CodeExpirationInSeconds">600</Item>
        <Item Key="CodeLength">6</Item>
        <Item Key="CharacterSet">0-9</Item>
        <Item Key="NumRetryAttempts">5</Item>
        <Item Key="ReuseSameCode">false</Item>
    </Metadata>
    <InputClaims>
        <InputClaim ClaimTypeReferenceId="identifier" PartnerClaimType="identifier" />
    </InputClaims>
    <OutputClaims>
        <OutputClaim ClaimTypeReferenceId="otpGenerated" PartnerClaimType="otpGenerated" />
    </OutputClaims>
</TechnicalProfile>
```

## Verify Code
The second mode of this technical profile is to verify a code. Below are the options that can be configured for this mode.

### Input claims

The **InputClaims** element contains a list of claims required to send to one time password protocol provider. You can also map the name of your claim to the name defined below. 

| ClaimReferenceId | Required | Description |
| --------- | -------- | ----------- |
| identifier | Yes | The identifier to identify the user who has previously generated a code. It is commonly used as the identifier of the destination where the code is delivered to, for example email address or phone number. |
| otpToVerify | Yes | The verification code provided by the user. |

The **InputClaimsTransformations** element may contain a collection of **InputClaimsTransformation** elements that are used to modify the input claims or generate new ones before sending to the one time password protocol provider.

### Output claims

There is no output claims provided during code verification of this protocol provider


The **OutputClaimsTransformations** element may contain a collection of **OutputClaimsTransformation** elements that are used to modify the output claims or generate new ones.

### Metadata
During code verification, below are the settings you can configure to control the error message when code verification failed.

| Attribute | Required | Description |
| --------- | -------- | ----------- |
| UserMessageIfSessionDoesNotExist | No | The user message if the code verification session has expired. It is either the code has expired or the code has never been generated for a given identifier. |
| UserMessageIfMaxRetryAttempted | No | The user message if the user has exceeded the maximum allowed verification attempts. |
| UserMessageIfInvalidCode | No | The user message if the code provided by the user is incorrect. |

### Returning error message

As described in [Metadata](#metadata), you can customize error message shown to the user for different error cases. You can further localize those messages by prefixing the locale, for example:

```XML
<Item Key="en.UserMessageIfInvalidCode">Wrong code has been entered.</Item>
```


### Example
Below is an example of a technical profile used to verify a code

```XML
<TechnicalProfile Id="VerifyCode">
    <DisplayName>Verify Code</DisplayName>
    <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.OneTimePasswordProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
    <Metadata>
        <Item Key="Operation">VerifyCode</Item>
        <Item Key="UserMessageIfInvalidCode">Wrong code has been entered.</Item>
        <Item Key="UserMessageIfSessionDoesNotExist">Code has expired.</Item>
        <Item Key="UserMessageIfMaxRetryAttempted">You've tried too many times.</Item>
    </Metadata>
    <InputClaims>
        <InputClaim ClaimTypeReferenceId="identifier" PartnerClaimType="identifier" />
        <InputClaim ClaimTypeReferenceId="otpGenerated" PartnerClaimType="otpToVerify" />
    </InputClaims>
</TechnicalProfile>
```