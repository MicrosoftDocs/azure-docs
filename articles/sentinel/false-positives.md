---
title: Handle false positives in Microsoft Sentinel
description: Learn how to resolve false positives in Microsoft Sentinel by creating automation rules or modifying analytics rules to specify exceptions.
author: yelevin
ms.author: yelevin
ms.topic: how-to
ms.date: 01/09/2023
---

# Handle false positives in Microsoft Sentinel

[Microsoft Sentinel analytics rules](detect-threats-built-in.md) notify you when something suspicious occurs in your network. No analytics rule is perfect, and you're bound to get some false positives that need handling. This article describes how to handle false positives, either by using automation or by modifying scheduled analytics rules.

## False positive causes and prevention

Even in a correctly built analytics rule, false positives often stem from specific entities like users or IP addresses that should be excluded from the rule.

Common scenarios include:

- Normal activities by certain users, usually service principals, show a pattern that seems suspicious.
- Intentional security scanning activity coming from known IP addresses is detected as malicious.
- A rule that excludes private IP addresses should also exclude some internal IP addresses that aren't private.

This article describes two methods for avoiding false positives:

- **Automation rules** create exceptions without modifying analytics rules.
- **Scheduled analytics rules modifications** permit more detailed and permanent exceptions.

The following table describes characteristics of each method:


|Method|Characteristic|
|-|-|
|**Automation rules**|<ul><li>Can apply to several analytics rules.</li><li>Keep an audit trail. Exceptions immediately and automatically close created incidents, recording the reason for the closure and comments.</li><li>Are often generated by analysts.</li><li>Allow applying exceptions for a limited time. For example, maintenance work might trigger false positives that outside the maintenance timeframe would be true incidents.</li></ul>|
|**Analytics rules modifications**|<ul><li>Allow advanced boolean expressions and subnet-based exceptions.</li><li>Let you use watchlists to centralize exception management.</li><li>Typically require implementation by Security Operations Center (SOC) engineers.</li><li>Are the most flexible and complete false positive solution, but are more complex.</li></ul>|

## Add exceptions by using automation rules

The simplest way to add an exception is to [add an automation rule](automate-incident-handling-with-automation-rules.md#creating-and-managing-automation-rules) when you see a false positive incident.

To add an automation rule to handle a false positive:

1. In Microsoft Sentinel, under **Incidents**, select the incident you want to create an exception for.
1. Select **Create automation rule**.
1. In the **Create new automation rule** sidebar, optionally modify the new rule name to identify the exception, rather than just the alert rule name.
1. Under **Conditions**, optionally add more **Analytics rule name**s to apply the exception to.
    Select the drop-down box containing the analytics rule name and select more analytics rules from the list.
1. The sidebar presents the specific entities in the current incident that might have caused the false positive. Keep the automatic suggestions, or modify them to fine-tune the exception. For example, you could change a condition on an IP address to apply to an entire subnet.

   :::image type="content" source="media/false-positives/create-rule.png" alt-text="Screenshot showing how to create an automation rule for an incident in Microsoft Sentinel.":::

1. After you're satisfied with the conditions, you can continue to define what the rule does:

   :::image type="content" source="media/false-positives/apply-rule.png" alt-text="Screenshot showing how to finish creating and applying an automation rule in Microsoft Sentinel.":::

   - The rule is already configured to close an incident that meets the exception criteria.
   - You can keep the specified closing reason as is, or you can change it if another reason is more appropriate.
   - You can add a comment to the automatically closed incident that explains the exception. For example, you could specify that the incident originated from known administrative activity.
   - By default, the rule is set to expire automatically after 24 hours. This expiration might be what you want, and reduces the chance of false negative errors. If you want a longer exception, set **Rule expiration** to a later time.

1. You can add more actions if you want. For example, you can add a tag to the incident, or you can run a playbook to send an email or a notification or to synchronize with an external system.

1. Select **Apply** to activate the exception.

> [!TIP]
> You can also create an automation rule from scratch, without starting from an incident. Select **Automation** from the Microsoft Sentinel left navigation menu, and then select **Create** > **Add new rule**. [Learn more about automation rules](automate-incident-handling-with-automation-rules.md).

## Add exceptions by modifying analytics rules

Another option for implementing exceptions is to modify the analytics rule query. You can include exceptions directly in the rule, or preferably, when possible, use a reference to a [watchlist](watchlists-queries.md#create-an-analytics-rule-with-a-watchlist). You can then manage the exception list in the watchlist.

### Modify the query

To edit existing analytics rules, select **Automation** from the Microsoft Sentinel left navigation menu. Select the rule you want to edit, and then select **Edit** at lower right to open the **Analytics Rules Wizard**.

For detailed instructions on using the **Analytics Rules Wizard** to create and edit analytics rules, see [Create custom analytics rules to detect threats](detect-threats-custom.md).

To implement an exception in a typical rule preamble, you can add a condition like `where IPAddress !in ('<ip addresses>')` near the beginning of the rule query. This line excludes specific IP addresses from the rule.

```kusto
let timeFrame = 1d;
SigninLogs
| where TimeGenerated >= ago(timeFrame)
| where IPAddress !in ('10.0.0.8', '192.168.12.1')
...
```

This type of exception isn't limited to IP addresses. You can exclude specific users by using the `UserPrincipalName` field, or exclude specific apps by using `AppDisplayName`.

You can also exclude multiple attributes. For example, to exclude alerts from either the IP address `10.0.0.8` or the user `user@microsoft.com`, use:

```kusto
| where IPAddress !in ('10.0.0.8')
| where UserPrincipalName != 'user@microsoft.com'
```

To implement a more fine-grained exception when applicable, and reduce the chance for false negatives, you can combine attributes. The following exception applies only if both values appear in the same alert:

```kusto
| where IPAddress != '10.0.0.8' and UserPrincipalName != 'user@microsoft.com'
```

### Exclude subnets

Excluding IP ranges used by an organization requires subnet exclusion. The following example shows how to exclude subnets.

The `ipv4_lookup` operator is an enrichment operator, not a filtering operator. The `where isempty(network)` line actually does the filtering, by inspecting those events that don't show a match.

```kusto
let subnets = datatable(network:string) [ "111.68.128.0/17", "5.8.0.0/19", ...];
let timeFrame = 1d;
SigninLogs
| where TimeGenerated >= ago(timeFrame)
| evaluate ipv4_lookup(subnets, IPAddress, network, return_unmatched = true)
| where isempty(network)
...
```

### Use watchlists to manage exceptions

You can use a watchlist to manage the list of exceptions outside the rule itself. When applicable, this solution has the following advantages:

- An analyst can add exceptions without editing the rule, which better follows SOC best practices.
- The same watchlist can apply to several rules, enabling central exception management.

Using a watchlist is similar to using a direct exception. Use `_GetWatchlist('<watchlist name>')` to call the watchlist:

```kusto
let timeFrame = 1d;
let logonDiff = 10m;
let allowlist = (_GetWatchlist('ipallowlist') | project IPAddress);
SigninLogs
| where TimeGenerated >= ago(timeFrame)
| where IPAddress !in (allowlist)
...
```

You can also do subnet filtering by using a watchlist. For example, in the preceding subnets exclusion code, you could replace the subnets `datatable` definition with a watchlist:

```kusto
let subnets = _GetWatchlist('subnetallowlist');
```

## Next steps

For more information, see:
- [Use UEBA data to analyze false positives](investigate-with-ueba.md#use-ueba-data-to-analyze-false-positives)
- [Automate incident handling in Microsoft Sentinel with automation rules](automate-incident-handling-with-automation-rules.md)
- [Create custom analytics rules to detect threats](detect-threats-custom.md)
- [Use Microsoft Sentinel watchlists](watchlists.md)
