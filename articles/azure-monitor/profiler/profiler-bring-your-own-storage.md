---
title: Configure BYOS for Profiler and Snapshot Debugger
description: Configure Bring Your Own Storage (BYOS) for Profiler and Snapshot Debugger.
ms.author: hannahhunter
author: hhunter-ms
ms.reviewer: charles.weininger
reviewer: cweining
ms.topic: conceptual
ms.date: 08/18/2022
ms.custom: devdivchpfy22, devx-track-azurepowershell
---

# Configure BYOS for Application Insights Profiler and Snapshot Debugger

This article shows you how to configure Bring Your Own Storage (BYOS) for Application Insights Profiler and Snapshot Debugger.

## What is BYOS and why might I need it?

When you use Application Insights Profiler or Snapshot Debugger, artifacts generated by your application are uploaded into Azure Storage accounts over the public internet. For these artifacts and storage accounts, Microsoft controls and covers the cost for:

* Processing and analysis.
* Encryption-at-rest and lifetime management policies.

When you configure BYOS, artifacts are uploaded into a storage account that you control. That means you control and are responsible for the cost of:

* The encryption-at-rest policy and the Lifetime management policy.
* Network access.

> [!NOTE]
> BYOS is required if you're enabling Azure Private Link or customer-managed keys.
>
> * [Learn more about Private Link for Application Insights](../logs/private-link-security.md).
> * [Learn more about customer-managed keys for Application Insights](../logs/customer-managed-keys.md).

## How is my storage account accessed?

1. Agents running in your virtual machines or Azure App Service upload artifacts (profiles, snapshots, and symbols) to blob containers in your account.

    This process involves contacting Profiler or Snapshot Debugger to obtain a shared access signature token to a new blob in your storage account.

1. Profiler or Snapshot Debugger will:

    - Analyze the incoming blob.
    - Write back the analysis results and log files into blob storage.
  
    Depending on available compute capacity, this process might occur anytime after upload.

1. When you view Profiler traces or Snapshot Debugger analysis, the service fetches the analysis results from blob storage.

## Prerequisites

* Create your storage account in the same location as your Application Insights resource.

    For example, if your Application Insights resource is in West US 2, your storage account must also be in West US 2.

* Grant the `Storage Blob Data Contributor` role to the Azure Active Directory (Azure AD) application named `Diagnostic Services Trusted Storage Access` via the [Access Control (IAM)](../../role-based-access-control/role-assignments-portal.md) page in your storage account.
* If Private Link is enabled, allow connection to our Trusted Microsoft Service from your virtual network.

## Enable BYOS

This section shows you how to enable BYOS.

### Grant access to Diagnostic Services to your storage account

A BYOS storage account is linked to an Application Insights resource. There might be only one storage account per Application Insights resource and both must be in the same location. You might use the same storage account with more than one Application Insights resource.

First, Application Insights Profiler and Snapshot Debugger must be granted access to the storage account. To grant access, add the role `Storage Blob Data Contributor` to the Azure AD application named `Diagnostic Services Trusted Storage Access` via the **Access Control (IAM)** page in your storage account.

1. Select **Access control (IAM)**.

1. Select **Add** > **Add role assignment** to open the **Add role assignment** page.

1. Assign the following role. For more information, see [Assign Azure roles by using the Azure portal](../../role-based-access-control/role-assignments-portal.md).
  
    | Setting | Value |
    | --- | --- |
    | Role | Storage Blob Data Contributor |
    | Assign access to | User, group, or service principal |
    | Members | Diagnostic Services Trusted Storage Access |

    :::image type="content" source="media/profiler-bring-your-own-storage/add-role-assignment-page.png" alt-text="Screenshot that shows the Add role assignment page in the Azure portal.":::
    
   After you add the role, it appears under the **Role assignments** section.
       :::image type="content" source="media/profiler-bring-your-own-storage/figure-11.png" alt-text="Screenshot that shows the IAM screen after Role assignments.":::
    
If you're also using Private Link, one more configuration is required to allow connection to our Trusted Microsoft Service from your virtual network. For more information, see [Storage network security documentation](../../storage/common/storage-network-security.md#trusted-microsoft-services).

### Link your storage account with your Application Insights resource

To configure BYOS for code-level diagnostics (Profiler/Snapshot Debugger), there are three options:

* Use Azure PowerShell cmdlets.
* Use the Azure CLI.
* Use Azure Resource Manager templates.

#### [PowerShell](#tab/azure-powershell)

1. Make sure you've installed Az PowerShell 4.2.0 or greater.

    To install Azure PowerShell, see the [Azure PowerShell documentation](/powershell/azure/install-az-ps).

1. Install the Application Insights PowerShell extension.

    ```powershell
    Install-Module -Name Az.ApplicationInsights -Force
    ```

1. Sign in with your Azure account subscription.

    ```powershell
    Connect-AzAccount -Subscription "{subscription_id}"
    ```

    For more information on how to sign in, see the [Connect-AzAccount documentation](/powershell/module/az.accounts/connect-azaccount).

1. Remove any previous storage account linked to your Application Insights resource.

    Pattern:

    ```powershell
    $appInsights = Get-AzApplicationInsights -ResourceGroupName "{resource_group_name}" -Name "{application_insights_name}"
    Remove-AzApplicationInsightsLinkedStorageAccount -ResourceId $appInsights.Id
    ```

    Example:

    ```powershell
    $appInsights = Get-AzApplicationInsights -ResourceGroupName "byos-test" -Name "byos-test-westus2-ai"
    Remove-AzApplicationInsightsLinkedStorageAccount -ResourceId $appInsights.Id
    ```

1. Connect your storage account with your Application Insights resource.
  
    Pattern:

    ```powershell
    $storageAccount = Get-AzStorageAccount -ResourceGroupName "{resource_group_name}" -Name "{storage_account_name}"
    $appInsights = Get-AzApplicationInsights -ResourceGroupName "{resource_group_name}" -Name "{application_insights_name}"
    New-AzApplicationInsightsLinkedStorageAccount -ResourceId $appInsights.Id -LinkedStorageAccountResourceId $storageAccount.Id
    ```

    Example:

    ```powershell
    $storageAccount = Get-AzStorageAccount -ResourceGroupName "byos-test" -Name "byosteststoragewestus2"
    $appInsights = Get-AzApplicationInsights -ResourceGroupName "byos-test" -Name "byos-test-westus2-ai"
    New-AzApplicationInsightsLinkedStorageAccount -ResourceId $appInsights.Id -LinkedStorageAccountResourceId $storageAccount.Id
    ```

#### [Azure CLI](#tab/azure-cli)

1. Make sure you've installed the Azure CLI.

    To install the Azure CLI, see the [Azure CLI documentation](/cli/azure/install-azure-cli).

1. Install the Application Insights CLI extension.

    ```azurecli
    az extension add -n application-insights
    ```

1. Connect your storage account with your Application Insights resource.

    Pattern:

    ```azurecli
    az monitor app-insights component linked-storage link --resource-group "{resource_group_name}" --app "{application_insights_name}" --storage-account "{storage_account_name}"
    ```
  
    Example:

    ```azurecli
    az monitor app-insights component linked-storage link --resource-group "byos-test" --app "byos-test-westus2-ai" --storage-account "byosteststoragewestus2"
    ```
  
    Expected output:

    ```powershell
    {
      "id": "/subscriptions/{subscription}/resourcegroups/byos-test/providers/microsoft.insights/components/byos-test-westus2-ai/linkedstorageaccounts/serviceprofiler",
      "linkedStorageAccount": "/subscriptions/{subscription}/resourceGroups/byos-test/providers/Microsoft.Storage/storageAccounts/byosteststoragewestus2",
      "name": "serviceprofiler",
      "resourceGroup": "byos-test",
      "type": "microsoft.insights/components/linkedstorageaccounts"
    }
    ```

    > [!NOTE]
    > For performing updates on the linked storage accounts to your Application Insights resource, see the [Application Insights CLI documentation](/cli/azure/monitor/app-insights/component/linked-storage).

#### [Resource Manager template](#tab/azure-resource-manager)

1. Create an Azure Resource Manager template file with the following content (*byos.template.json*):

    ```json
    {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "applicationinsights_name": {
          "type": "String"
        },
        "storageaccount_name": {
          "type": "String"
        }
      },
      "variables": {},
      "resources": [
        {
          "name": "[concat(parameters('applicationinsights_name'), '/serviceprofiler')]",
          "type": "Microsoft.Insights/components/linkedStorageAccounts",
          "apiVersion": "2020-03-01-preview",
          "properties": {
            "linkedStorageAccount": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageaccount_name'))]"
          }
        }
      ],
      "outputs": {}
    }
    ```

1. Run the following PowerShell command to deploy the preceding template:

    Syntax:

    ```powershell
    New-AzResourceGroupDeployment -ResourceGroupName "{your_resource_name}" -TemplateFile "{local_path_to_arm_template}"
    ```

    Example:

    ```powershell
    New-AzResourceGroupDeployment -ResourceGroupName "byos-test" -TemplateFile "D:\Docs\byos.template.json"
    ```

1. Provide the following parameters when you're prompted in the PowerShell console:
  
    |           Parameter           |                                Description                               |
    |-------------------------------|--------------------------------------------------------------------------|
    | `application_insights_name`     | The name of the Application Insights resource to enable BYOS.            |
    | `storage_account_name`          | The name of the storage account resource that you'll use as your BYOS. |
  
    Expected output:

    ```powershell
    Supply values for the following parameters:
    (Type !? for Help.)
    application_insights_name: byos-test-westus2-ai
    storage_account_name: byosteststoragewestus2
    
    DeploymentName          : byos.template
    ResourceGroupName      : byos-test
    ProvisioningState       : Succeeded
    Timestamp               : 4/16/2020 1:24:57 AM
    Mode                    : Incremental
    TemplateLink            :
    Parameters              :
                              Name                            Type                       Value
                              ==============================  =========================  ==========
                              application_insights_name        String                     byos-test-westus2-ai
                              storage_account_name             String                     byosteststoragewestus2
                              
    Outputs                 :
    DeploymentDebugLogLevel :
    ```

1. Enable code-level diagnostics (Profiler/Snapshot Debugger) on the workload of interest through the Azure portal. In this example, it's **App Service** > **Application Insights**.

    :::image type="content" source="media/profiler-bring-your-own-storage/figure-20.png" alt-text="Screenshot that shows the code-level diagnostics in the Azure portal.":::

## Troubleshooting

This section offers troubleshooting tips for common issues.

### Template schema '{schema_uri}' isn't supported

* Make sure that the `$schema` property of the template is valid. It must follow this pattern:
`https://schema.management.azure.com/schemas/{schema_version}/deploymentTemplate.json#`.
* Make sure that the `schema_version` of the template is within valid values: `2014-04-01-preview, 2015-01-01, 2018-05-01, 2019-04-01, 2019-08-01`.
    
    Error message:

    ```powershell
    New-AzResourceGroupDeployment : 11:53:49 AM - Error: Code=InvalidTemplate; Message=Deployment template validation failed: 'Template schema
    'https://schema.management.azure.com/schemas/2020-01-01/deploymentTemplate.json#' is not supported. Supported versions are
    '2014-04-01-preview,2015-01-01,2018-05-01,2019-04-01,2019-08-01'. Please see https://aka.ms/arm-template for usage details.'.
    ```

### No registered resource provider found for location '{location}'

* Make sure that the `apiVersion` of the resource `microsoft.insights/components` is `2015-05-01`.
* Make sure that the `apiVersion` of the resource `linkedStorageAccount` is `2020-03-01-preview`.
    
    Error message:

    ```powershell
    New-AzResourceGroupDeployment : 6:18:03 PM - Resource microsoft.insights/components 'byos-test-westus2-ai' failed with message '{
      "error": {
        "code": "NoRegisteredProviderFound",
        "message": "No registered resource provider found for location 'westus2' and API version '2020-03-01-preview' for type 'components'. The supported api-versions are '2014-04-01,
    2014-08-01, 2014-12-01-preview, 2015-05-01, 2018-05-01-preview'. The supported locations are ', eastus, southcentralus, northeurope, westeurope, southeastasia, westus2, uksouth,
    canadacentral, centralindia, japaneast, australiaeast, koreacentral, francecentral, centralus, eastus2, eastasia, westus, southafricanorth, northcentralus, brazilsouth, switzerlandnorth,
    australiasoutheast'."
      }
    }'
    ```

### Storage account location should match AI component location

* Make sure that the location of the Application Insights resource is the same as the storage account.
    
    Error message:

    ```powershell
    New-AzResourceGroupDeployment : 1:01:12 PM - Resource microsoft.insights/components/linkedStorageAccounts 'byos-test-centralus-ai/serviceprofiler' failed with message '{
      "error": {
        "code": "BadRequest",
        "message": "Storage account location should match AI component location",
        "innererror": {
          "trace": [
            "System.ArgumentException"
          ]
        }
      }
    }'
    ```

For general Profiler troubleshooting, see the [Profiler troubleshooting documentation](profiler-troubleshooting.md).

For general Snapshot Debugger troubleshooting, see the [Snapshot Debugger troubleshooting documentation](/troubleshoot/azure/azure-monitor/app-insights/snapshot-debugger-troubleshoot).

## Frequently asked questions

This section provides answers to common questions.

### If I've enabled Profiler/Snapshot Debugger and BYOS, will my data be migrated into my storage account?

  No, it won't.

### Will BYOS work with encryption-at-rest and customer-managed keys?
  
  Yes. To be precise, BYOS is a requirement to have Profiler/Snapshot Debugger enabled with customer-manager keys.

### Will BYOS work in an environment isolated from the internet?
  
  Yes. BYOS is a requirement for isolated network scenarios.

### Will BYOS work with both customer-managed keys and Private Link enabled?
  
  Yes, it's possible.

### If I've enabled BYOS, can I go back to using Diagnostic Services storage accounts to store my collected data?
  
  Yes, you can, but we don't currently support data migration from your BYOS.

### After I enable BYOS, will I take over all the related costs of storage and networking?

  Yes.
