<properties
	pageTitle="Device management with the Gateway SDK | Microsoft Azure"
	description="Azure IoT Hub Gateway SDK walkthrough showing how to implement device management when you are using the Gateway SDK"
	services="iot-hub"
	documentationCenter=""
	authors="dominicbetts"
	manager="timlt"
	editor=""/>

<tags
     ms.service="iot-hub"
     ms.devlang="cpp"
     ms.topic="article"
     ms.tgt_pltfrm="na"
     ms.workload="na"
     ms.date="06/15/2016"
     ms.author="dobett"/>


# IoT Gateway SDK (beta) – device management with the Gateway SDK

This tutorial shows you how to use the [device management][lnk-device-management] capabilities of IoT Hub alongside the [Azure IoT Hub Gateway SDK][lnk-gateway-sdk]. The tutorial uses an Intel Edison Compute Module to host a gateway with simulated devices that sends telemetry to your IoT hub. You use the device management capabilities in IoT Hub to perform a remote firmware update on the Edison board.

This tutorial covers:

- **Architecture**: important architectural information about the device management sample.

- **Build and run**: the steps required to build and run the sample.

## Architecture

In this tutorial, you provision an Intel Edison board to act as an IoT device gateway connected to IoT Hub. You also configure the Edison board so you can manage it through IoT Hub. The following diagram shows the key elements of the solution you build in this tutorial:

![Gateway and device management architecture][img-architecture]

### Devices

There are three IoT devices connected to IoT Hub in this solution:

- The Edison board is a device named **GW-device**. In the tutorial you use the device management capabilities of IoT Hub to update the firmware of this physical device.

- Two simulated devices (**GW-ble1-demo** and **GW-ble2-demo**). These devices simulate Bluetooth low energy devices that connect to IoT Hub through the gateway and send temperature telemetry to your hub.

### Gateway software

The gateway software runs as a service on the Edison board. Two simulated devices generate temperature telemetry. The mapping module maps these simulated devices to devices registered with IoT Hub and the HTTP module handles communication with the IoT Hub endpoint. The [IoT Gateway SDK  – send device-to-cloud messages with a simulated device][lnk-gateway-scenario] article describes this scenario in detail.

### Device management client

The [device management client][lnk-device-management] runs as a service on the Edison board. This enables you to run remote jobs on the Edison board such as [firmware updates][lnk-dm-jobs], reboots, and configuration updates as well as querying device properties. In this tutorial, the device management client receives and processes a request to perform a firmware update on the Edison board.

### IoT Hub

[Azure IoT Hub][lnk-iot-hub] is a fully managed service that enables reliable and secure bidirectional communications between millions of IoT devices and a solution back end. In this tutorial, IoT Hub:

- Enables the three devices to connect to the cloud.
- Receives the telemetry generated by the simulated devices from the gateway.
- Enables you to send a firmware update request to the Edison board.
- Monitors the progress of the firmware update job.

### Device management sample UI

The [device management sample UI][lnk-dm-sample-ui] is a sample web application that enables you to use the device management capabilities of IoT Hub in an interactive web UI. For example, you can use the sample UI to query the devices connected to your IoT Hub and submit firmware update jobs to your devices. In this tutorial, you use the sample UI to submit a firmware update job to the Edison board and monitor the progress of that job through to completion.

## Build and run

To run this sample you must build a custom image for your Edison board that includes the IoT Hub gateway software and device management client.

Before you get started, you should make sure you can connect your Edison board to your wireless network. To set up your Edison board, you need to connect it to a host computer. Later, you will use the host computer to flash your Edison board with the custom image you create. Intel has a set of getting started guides that include guides for the following operating systems:

- [Get Started with the Intel Edison Development Board on Windows 64-bit][lnk-setup-win64].
- [Get Started with the Intel Edison Development Board on Windows 32-bit][lnk-setup-win32].
- [Getting Started with the Intel® Edison Board on Linux][lnk-setup-linux].

To set up your Edison board and familiarize yourself with it, you should complete all the steps in these "Get started" articles except for:

- Flashing the latest firmware. You update the firmware as part of this tutorial so you don't need to complete this step at this time.
- The last step, "Choose IDE", which is unnecessary for the current tutorial.

When you have set up the Edison board and installed the necessary drivers on your host machine, you should make sure you can connect to the Edison board using a serial terminal. The [Setting up a serial terminal][lnk-serial-connection] page on the Intel website has links to set up instructions for host operating systems such as Windows and Linux.

You also need to complete these tasks

- [Create an IoT hub][lnk-create-hub] in your Azure subscription. You need the name of your hub to complete this tutorial. If you don't already have an Azure subscription, you can get a [free account][lnk-free-trial].
- Add three devices (**GW-ble1-demo**, **GW-ble2-demo**, and **GW-device**) to your IoT hub and make a note of their ids and device keys. You can use the [Device Explorer or iothub-explorer][lnk-explorer-tools] tools to add these devices to the IoT hub you created in the previous step and retrieve their keys. You use two of these devices (**GW-ble1-demo** and **GW-ble2-demo**) as simulated BLE devices connected to the gateway, and one device (**GW-device**) to identify the Edison gateway device as a device management client you can manage from your IoT Hub.

### Prepare your build environment and verify that you can build a custom image

To create a custom image for your Edison board, you need a Linux environment. These steps assume you are using Ubuntu 14.04 which, at the time of writing, is the recommended platform to use. You should have at least 40 GB free on your home partition.

> [AZURE.NOTE] The script that builds the custom image can take up to 6 hours to run on a 4 CPU core machine. You can reduce this time by using a more powerful machine that has more CPU cores.

For the steps in this section, we consulted the following articles: [Intel Edison Board Support Package][lnk-inteledison-bsp], [Manually Building Yocto Images for the Intel Edison Board from Source][lnk-hackgnar], and [Creating a Custom Linux Kernel for the Edison (release 2.1)][lnk-shawnhymel].

1. Sign in to your Ubuntu 14.04 machine and execute the following command in your home folder to download the Edison source package:
    
    ```
    curl -O http://downloadmirror.intel.com/25028/eng/edison-src-ww25.5-15.tgz
    ```

2. Uncompress the source package to create an **edison-src** folder in your home folder with the following command and navigate to the new **edison-src** folder:
    
    ```
    tar xfvz edison-src-ww25.5-15.tgz
    cd edison-src/
    ```

3. Install the prerequisite packages:
    
    ```
    sudo apt-get -y install build-essential git diffstat gawk chrpath texinfo libtool gcc-multilib libsdl1.2-dev u-boot-tools
    ```

4. Create the two new directories in the **edison-src** folder:
    
    ```
    mkdir bitbake_download_dir
    mkdir bitbake_sstate_dir 
    ```

5. Run the following script to download your build environment. If you have more than 4 CPU cores, set the **--parallel_make** and **--bb_number_thread** script arguments to the number of cores you have available:
    
    ```
    ./meta-intel-edison/setup.sh --dl_dir=bitbake_download_dir  --sstate_dir=bitbake_sstate_dir 
    ```

6. Update the location of the Paho git repository. Edit the file **~/edison-src/out/linux64/poky/meta-intel-iot-middleware/recipes-connectivity/paho-mqtt/paho-mqtt_3.1.bb** and replace the URL `git://git.eclipse.org/gitroot/paho/org.eclipse.paho.mqtt.c.git/` with `git://github.com/eclipse/paho.mqtt.c.git`.

7. Initialize your build environment with the following commands:
    
    ```
    cd out/linux64/
    source poky/oe-init-build-env
    ```

8. Use the following command to build your custom image. The first time you run this command it can take up to 6 hours to run on a 4 CPU core machine. Subsequent rebuilds after you have added your own customizations will be much faster:
    
    ```
    bitbake edison-image
    ```

9. Finalize the build by running the following commands:
    
    ```
    cd ~/edison-src/
    ./meta-intel-edison/utils/flash/postBuild.sh ./out/linux64/build/
    ```

The files you need to flash the Edison board are now in the **~/edison-src/out/linux64/build/toFlash/** folder.

### Add the Gateway SDK to your custom image

The steps in this section guide you through the process of adding the Gateway SDK to your custom image so that the Edison board acts as an IoT gateway when it boots. For this tutorial, the gateway includes a module that simulates two Bluetooth low energy (BLE) devices that generate temperature telemetry for the gateway to forward to your IoT hub.

Complete the following steps on the same Ubuntu 14.04 machine you used to build an Edison image in the previous section.

1. Clone the Gateway SDK to your home folder:
    
    ```
    cd ~
    git clone https://github.com/Azure/azure-iot-gateway-sdk.git --recursive
    ```

2. Configure the gateway to connect to your IoT Hub and simulate two devices. Edit the file **~/azure-iot-gateway-sdk/samples/simulated_device_cloud_upload/src/simulated_device_cloud_upload_intel_edison.json** and replace the **IoTHubName**, **IoTHubSuffix**, **deviceID**, and **deviceKey** placeholders with the values you noted when you configured your IoT Hub. Use the devices **GW-ble1-demo** and **GW-ble2-demo** you created earlier.

3. Create a folder to contain your new recipe:
    
    ```
    mkdir ~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/azure-iot-field-gateway-sdk
    ```

4. Copy the recipe file called **azure-iot-field-gateway-sdk.bb** from the folder **~/azure-iot-gateway-sdk/samples/simulated_device_cloud_upload/src/** to the folder **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/azure-iot-field-gateway-sdk/** you just created. Edit the file to replace the two occurences of  `<<userName>>` with your current user name.

5. Edit **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-core/images/edison-image.bb** to add an entry for your new recipe. Add the following line at the end of the file:
    
    ```
    IMAGE_INSTALL += "azure-iot-field-gateway-sdk"
    ```

6. You can now test your changes by running the **bitbake** command to build just the new recipe:
    
    ```
    cd ~/edison-src/out/linux64/
    source poky/oe-init-build-env
    bitbake azure-iot-field-gateway-sdk
    ```

### Add the Azure IoT Hub device management client to your custom image

The steps in this section guide you through the process of adding the IoT Hub device management client to your custom image so you can manage the Edison gateway device from your IoT Hub. For this tutorial, the device management client includes sample code to enable a firmware update on your Edison gateway device.

Complete the following steps on the same Ubuntu 14.04 machine you used in the previous section to add the gateway to your Edison image.

1. Clone the **dmpreview** branch of the IoT Hub SDKs repository to your home folder:
    
    ```
    cd ~
    git clone https://github.com/Azure/azure-iot-sdks -b dmpreview --recursive
    ```

2. Create the following folders to contain your new recipe:
    
    ```
    mkdir ~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/iotdm-edison-sample
    mkdir ~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/iotdm-edison-sample/files
    ```

3. Copy the file **iotdm-edison-sample.bb** from the **~/azure-iot-sdks/c/iotdm_client/samples/iotdm_edison_sample/bitbake/** folder to the **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/iotdm-edison-sample** folder.

4. Edit the file **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/iotdm-edison-sample/iotdm-edison-sample.bb** and replace `-Duse_http:BOOL=OFF` with `-Duse_http:BOOL=ON`.

5. Copy the file **iotdm_edison_sample.service** from the **~/azure-iot-sdks/c/iotdm_client/samples/iotdm_edison_sample/bitbake/** folder to the **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-support/iotdm-edison-sample/files** folder.

6. Edit the file **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-core/images/edison-image.bb** to add an entry for your new recipe. Add the following line at the end of the file:
    
    ```
    IMAGE_INSTALL += "iotdm-edison-sample"
    ```

7. Because the Gateway SDK and device management client share some libraries, you need to edit the **~/edison-src/out/linux64/poky/meta/classes/sstate.bbclass** file. Add the following lines at the end of this file. Be sure to replace `<your user>` with your current user name:
    
    ```
    SSTATE_DUPWHITELIST += "/home/<your user>/edison-src/out/linux64/build/tmp/sysroots/edison/usr/lib/libaziotsharedutil.a"
    SSTATE_DUPWHITELIST += "/home/<your user>/edison-src/out/linux64/build/tmp/sysroots/edison/usr/include/azureiot"
    ```

8. Configure WiFi to start automatically on the Edison board by editing the file **~/edison-src/meta-intel-edison/meta-intel-edison-distro/recipes-connectivity/wpa_supplicant/wpa-supplicant/wpa_supplicant.conf-sane** and adding the following lines at the end of the file. Be sure to replace `<your wifi ssid>` and `<your wifi password>` with the correct values for your WiFi network:
    
    ```
    network={
      ssid="<your wifi ssid>"
      key_mgmt=WPA-PSK
      pairwise=CCMP TKIP
      group=CCMP TKIP WEP104 WEP40
      eap=TTLS PEAP TLS
      psk="<your wifi password>"
    }
    ```

9. You can now build the image for your Edison board that contains the Gateway SDK and device management client. The **bitbake** command will run much faster than previously because it only needs to build the new recipe and add it to the image:
    
    ```
    cd ~/edison-src/out/linux64/
    source poky/oe-init-build-env
    bitbake edison-image
    ```

10. Finalize the build by running the following commands:
  
    ```
    cd ~/edison-src/
    ./meta-intel-edison/utils/flash/postBuild.sh ./out/linux64/build/
    ```

The files you need to flash the Edison board are now in the **~/edison-src/out/linux64/build/toFlash/** folder.

### Flash your Intel Edison with the custom image

You can now flash your Edison board with your custom image that contains both the IoT Hub device management client and gateway software.

Copy the files from the **toFlash** folder on the Ubuntu machine you used to build the custom image to the machine that connects to your Edison board with a USB cable.

If you are using a Windows machine to connect to your Edison with a USB cable, you should run the **flashall.bat** script to flash your Edison. If you are using a Linux machine to connect to your Edison with a USB cable, you should run the **flashall.bat** script to flash your Edison.

When the flashing process is complete, connect to your Edison using a [serial connection][lnk-serial-connection] from your host machine and sign in as **root**. You should verify your Edison board is now connected to your WiFi network.

### Run the sample

You must configure the device management client on the Edison board to connect as the **GW-device** device to your IoT hub. Use a text editor (such as **vi** or **nano**) to create a file called **.cs** in the /home/root folder on the Edison. This file should contain just the connection string of the **GW-device**. If you didn't make a note of this connection string previously, you can use the [Device Explorer or iothub-explorer][lnk-explorer-tools] tools to retrieve this device connection string from the IoT Hub device registry.

When you have created the **.cs** file, reboot the Edison board using the following command:

```
reboot -h now
```

When the Edison reboots, check that both the device management and gateway services start up with an **OK** status:

```
[  OK  ] Started Daemon to receive the wpa_supplicant event.
         Starting PulseAudio Sound System...
[  OK  ] Started WPA supplicant service.
[  OK  ] Started Azure IoT DM as a service..
[  OK  ] Started Azure Iot Gateway as a service..
         Stopping Daemon to receive the wpa_supplicant event...
[  OK  ] Stopped Daemon to receive the wpa_supplicant event.

```

To troubleshoot any issues with the IoT gateway service, look at the entries in the **/deviceCloudUploadGatewaylog.log** file on the Edison. You can also use the following command to view any output from the service:

```
systemctl status simulated_device_cloud_upload.service
```

To troubleshoot any issues with the IoT device management service, use the following command to view any output:

```
systemctl status iotdm_edison_sample.service
```

### Start the firmware update job

A firmware update on the Edison requested by the IoT device management service normally downloads a zip file that contains the firmware from a URL. To simplify this tutorial, you manually copy the zip file to the Edison board and then use a **file://** URL instead of an **http://** URL when you request the update.

Again, to simplify the tutorial the firmware update reapplies the same firmware image instead of using a brand new image. You will be able to see this image being applied to the Edison board.

Create a zip file called **edison.zip** that contains all the files and subfolders from the **toFlash** folder on the Ubuntu machine you used to create the custom image. Make sure that the files from the **toFlash** folder are in the root of the zip file. Use a tool such as SCP (or PSCP if you are using Putty) to copy the **edison.zip** file to the /home/root folder on your Edison board.

To submit the firmware update job and monitor its progress, use the Node.js [device management sample UI][lnk-dm-sample-ui]. You can run this sample on either Windows or Linux and it requires [Node.js][lnk-nodejs] 6.1.0 or greater. To retrieve, build, and run the device management sample UI on your desktop machine, follow the steps below:

1. Open a **Command Prompt**.

2. Confirm that you’ve installed Node.js 6.1.0 or greater by typing `node --version`.

3. Clone the Azure IoT device management UI GitHub repository by running the following command:

    ```
    git clone https://github.com/Azure/azure-iot-device-management.git
    ```
    
4. In the root folder of your cloned copy of the Azure IoT device management UI repository, run the following command to retrieve the dependent packages:

    ```
    npm install
    ```

5. When the npm install command has completed, run the following command to build the code:

    ```
    npm run build
    ```

6. Use a text editor to open the user-config.json file in root of the cloned folder. Replace the text "&lt;YOUR CONNECTION STRING HERE&gt;" with your IoT Hub connection string. You can find this connection string in the Azure [portal][lnk-azure-portal].

7. In the command prompt, run the following command to start the device management UX app:

    ```
    npm run start
    ```

8. When the command prompt reports "Services have started", open a web browser and navigate to the device management app at the following URL to view your devices: <http://127.0.0.1:3003>.

    ![Device management UI][img-dm-ui]

9. Select the **GW-device** device, in the **Device Jobs** dropdown select **Firmware Update**, and then click **Start**.

10. In the **Package URI** field, enter **file:///home/root/edison.zip** to use the image file you previously copied to the Edison board. Click **Submit**, click **Yes**, and then click the **Job History** link to see the new parent and child jobs running:

    ![Job history link][img-history-link]

11. After several minutes, in the serial terminal connected to your Edison board, you will see the Edison reboot and apply the firmware changes:

    ```
    reading ota_update.scr
    14747 bytes read in 17 ms (846.7 KiB/s)
    ## Executing script at 00100000
    === OTA update script ===
    Validating Ota package
    part find mmc 0 label:update u_part_num;
    ota drive is mmc 0:9

    Validating edison_ifwi-dbg-00-dfu.bin hash for boot0 and boot1 partitions

    fatload mmc 0:9 0x6400000 edison_ifwi-dbg-00-dfu.bin;
    reading edison_ifwi-dbg-00-dfu.bin
    ...
    ```

12. When the Edison finishes rebooting, refresh the page in the device management sample UI to see that the job status is now **completed** for the two firmware update jobs:

    ![Job status complete][img-job-status]

You have now completed the tutorial that shows you how to use the IoT Hub gateway software and device management client on an Intel Edison board. As part of this tutorial you:

- Created a custom Intel Edison image that includes the IoT Hub device management client and gateway software configured to start up whenever the Edison board boots.
- Configured the Edison board and device management client to connect to your IoT hub.
- Started a device management job from the sample UI that causes the Edison board to reboot and apply a new firmware image.

## Next steps

To learn more about device management with IoT Hub and the sample UI, see the [Overview of Azure IoT Hub device management][lnk-device-management] article.

If you want to gain a more advanced understanding of the Gateway SDK and experiment with some code examples, visit the [Azure IoT Gateway SDK][lnk-gateway-sdk].

To further explore the capabilities of IoT Hub, see:

- [Designing your solution][lnk-design]
- [Developer guide][lnk-devguide]
- [Exploring device management using the sample UI][lnk-dmui]
- [Using the Azure Portal to manage IoT Hub][lnk-portal]



<!-- Links and images -->

[img-dm-ui]: media/iot-hub-gateway-sdk-device-management/image1.png
[img-history-link]: media/iot-hub-gateway-sdk-device-management/image2.png
[img-job-status]: media/iot-hub-gateway-sdk-device-management/image3.png
[img-architecture]: media/iot-hub-gateway-sdk-device-management/architecture.png

[lnk-iot-hub]: iot-hub-what-is-iot-hub.md
[lnk-device-management]: iot-hub-device-management-overview.md
[lnk-gateway-sdk]: https://github.com/Azure/azure-iot-gateway-sdk/
[lnk-setup-win64]: https://software.intel.com/get-started-edison-windows
[lnk-setup-win32]: https://software.intel.com/get-started-edison-windows-32
[lnk-setup-osx]: https://software.intel.com/get-started-edison-osx
[lnk-setup-linux]: https://software.intel.com/get-started-edison-linux
[lnk-serial-connection]: https://software.intel.com/setting-up-serial-terminal-intel-edison-board
[lnk-inteledison-bsp]: http://www.intel.com/content/dam/support/us/en/documents/edison/sb/edisonbsp_ug_331188007.pdf
[lnk-hackgnar]: http://www.hackgnar.com/2016/01/manually-building-yocto-images-for.html
[lnk-shawnhymel]: http://shawnhymel.com/724/creating-a-custom-linux-kernel-for-the-edison-yocto-2-1/
[lnk-create-hub]: iot-hub-manage-through-portal.md
[lnk-free-trial]: https://azure.microsoft.com/pricing/free-trial/
[lnk-explorer-tools]: https://github.com/Azure/azure-iot-sdks/blob/master/doc/manage_iot_hub.md
[lnk-nodejs]: https://nodejs.org/
[lnk-azure-portal]: https://portal.azure.com
[lnk-dm-sample-ui]: iot-hub-device-management-ui-sample.md
[lnk-gateway-physical]: iot-hub-gateway-sdk-physical-device.md
[lnk-gateway-scenario]: iot-hub-linux-gateway-sdk-simulated-device.md
[lnk-dm-jobs]: iot-hub-device-management-device-jobs.md

[lnk-design]: iot-hub-guidance.md
[lnk-devguide]: iot-hub-devguide.md
[lnk-dmui]: iot-hub-device-management-ui-sample.md
[lnk-portal]: iot-hub-manage-through-portal.md