---
title: Use Microsoft Defender for Endpoint's threat and vulnerability management capabilities with Azure Security Center
description: Enable, deploy, and use Microsoft Defender for Endpoint's threat and vulnerability management capabilities with Azure Security Center to discover weaknesses in your Azure and hybrid machines
services: security-center
author: memildin
manager: rkarlin
ms.service: security-center
ms.topic: how-to
ms.date: 10/05/2021
ms.author: memildin

---
# Investigate weaknesses with Microsoft Defender for Endpoint's threat and vulnerability management 

A core component of every cyber risk and security program is the identification and analysis of vulnerabilities.

Security Center regularly checks your connected machines to ensure they're running a vulnerability assessment tool.

When a machine is found that doesn't have vulnerability assessment solution deployed, Security Center generates the following security recommendation:

**A vulnerability assessment solution should be enabled on your virtual machines**

Use this recommendation to deploy a vulnerability assessment solution to your Azure virtual machines and your Azure Arc enabled hybrid machines.

A choice of vulnerability assessment solution tools is included with Azure Defender for servers:

- The Microsoft threat and vulnerability management module of Microsoft Defender for Endpoint
- The integrated Qualys agent which is deployed by a Security Center recommendation

You can define which tool is deployed to machines in your subscriptions with the auto provisioning tool as described below.

> [!NOTE]
> The findings for **all** vulnerability assessment tools are provided in a Security Center recommendation **Vulnerabilities in your virtual machines should be remediated.**. Learn about how to [View and remediate findings from vulnerability assessment solutions on your VMs](remediate-vulnerability-findings-vm.md)

## Availability

|Aspect|Details|
|----|:----|
|Release state:|Preview. [!INCLUDE [Legalese](../../includes/security-center-preview-legal-text.md)]|
|Machine types:|:::image type="icon" source="./media/icons/yes-icon.png"::: Azure virtual machines<br>:::image type="icon" source="./media/icons/yes-icon.png"::: Azure Arc enabled machines|
|Pricing:|Requires [Azure Defender for servers](defender-for-servers-introduction.md)|
|Required roles and permissions:|[Owner](../role-based-access-control/built-in-roles.md#owner) (resource group level) can deploy the scanner<br>[Security Reader](../role-based-access-control/built-in-roles.md#security-reader) can view findings|
|Clouds:|:::image type="icon" source="./media/icons/yes-icon.png"::: Commercial clouds<br>:::image type="icon" source="./media/icons/no-icon.png"::: National/Sovereign (Azure Government, Azure China 21Vianet)|
|||


## Overview of threat and vulnerability management

Microsoft threat and vulnerability management is a built-in module in Microsoft Defender for Endpoint. The integration with Azure Defender does not involve any changes at the endpoint level - it takes place in the background between the two platforms. 

[Threat and vulnerability management](/microsoft-365/security/defender-endpoint/next-gen-threat-and-vuln-mgt) identifies vulnerabilities and misconfigurations in real time with sensors, and without the need of agents or periodic scans.

For a quick overview of threat and vulnerability management, watch this video:

> [!VIDEO https://www.microsoft.com/videoplayer/embed/RE4mLsn]

> [!TIP]
> As well as alerting you to potential vulnerabilities, threat and vulnerability management provides additional options in Security Center's asset inventory tool. Learn more in [Software inventory](asset-inventory.md#access-a-software-inventory).

## Configure auto provisioning of threat and vulnerability management

1. From Security Center's menu, select **Pricing & settings**.
1. Select the relevant subscription.
1. Open the **Auto provisioning** page.
1. Set the status of auto provisioning for the vulnerability assessment for machines to **On** and select the **Microsoft threat and vulnerability management**.

    :::image type="content" source="media/deploy-vulnerability-assessment-tvm/auto-provision-vulnerability-assessment-agent.png" alt-text="Configure auto provisioning of the threat and vulnerability management module in Azure Security Center.":::

1. Select **Apply** and **Save**.



1. From the [Azure portal](https://azure.microsoft.com/features/azure-portal/), open **Security Center**.

1. From Security Center's menu, open the **Recommendations** page.

1. Select the recommendation [A vulnerability assessment solution should be enabled on your virtual machines](https://portal.azure.com/#blade/Microsoft_Azure_Security/RecommendationsBlade/assessmentKey/ffff0522-1e88-47fc-8382-2a80ba848f5d).

    :::image type="content" source="./media/deploy-vulnerability-assessment-vm/recommendation-page-machine-groupings.png" alt-text="The groupings of the machines in the recommendation page." lightbox="./media/deploy-vulnerability-assessment-vm/recommendation-page-machine-groupings.png":::

    > [!TIP]
    > The machine "server16-test" above, is an Azure Arc enabled machine. To deploy the vulnerability assessment scanner to your on-premises and multi-cloud machines, see [Connect your non-Azure machines to Security Center](quickstart-onboard-machines.md).
    >
    > Security Center works seamlessly with Azure Arc. When you've deployed Azure Arc, your machines will appear in Security Center and no Log Analytics agent is required.

    Your machines will appear in one or more of the following groups:

    * **Healthy resources** – Security Center has detected a vulnerability assessment solution running on these machines.
    * **Unhealthy resources** – A vulnerability scanner extension can be deployed to these machines. 
    * **Not applicable resources** – these machines can't have a vulnerability scanner extension deployed. Your machine might be in this tab because it's an image in an AKS cluster, it's part of a virtual machine scale set, or it's not running one of the supported operating systems for the integrated vulnerability scanner:

        | **Vendor** | **OS** | **Supported versions** |
        |----|----|----|
        |Microsoft|Windows|All|
        |Red Hat|Enterprise Linux|5.4+, 6, 7.0-7.8, 8.0-8.1|
        |Red Hat|CentOS|5.4+, 6, 7.0-7.7, 8.0-8.1|
        |Red Hat|Fedora|22-31|
        |SUSE|Linux Enterprise Server (SLES)|11, 12, 15|
        |SUSE|OpenSUSE|12, 13, 15.0-15.2|
        |SUSE|Leap|42.1|
        |Oracle|Enterprise Linux|5.11, 6, 7.0-7.5|
        |Debian|Debian|7.x-10.x|
        |Ubuntu|Ubuntu|12.04 LTS, 14.04 LTS, 15.x, 16.04 LTS, 18.04 LTS, 19.10, 20.04 LTS|

1. From the list of unhealthy machines, select the ones to receive a vulnerability assessment solution and select **Remediate**.

    >[!IMPORTANT]
    > Depending on your configuration, this list might appear differently. 
    >
    > - If you haven't got a third-party vulnerability scanner configured, you won't be offered the opportunity to deploy it.
    > - If your selected machines aren't protected by Azure Defender, the ASC integrated vulnerability scanner option won't be available.

    :::image type="content" source="./media/deploy-vulnerability-assessment-vm/recommendation-remediation-options-builtin.png" alt-text="The options for which type of remediation flow you want to choose when responding to the recommendation **A vulnerability assessment solution should be enabled on your virtual machines** recommendation page":::

1. Choose the recommended option, **Deploy ASC integrated vulnerability scanner**, and **Proceed**.

1. You'll be asked for one further confirmation. Select **Remediate**.

    The scanner extension will be installed on all of the selected machines within a few minutes.
    
    Scanning begins automatically as soon as the extension is successfully deployed. Scans will then run every 12 hours. This interval isn't configurable.

    >[!IMPORTANT]
    > If the deployment fails on one or more machines, ensure the target machines can communicate with Qualys' cloud service by adding the following IPs to your allow lists (via port 443 - the default for HTTPS):
    >
    >   - `https://qagpublic.qg3.apps.qualys.com` - Qualys' US data center
    >
    >   - `https://qagpublic.qg2.apps.qualys.eu` - Qualys' European data center
    >
    > If your machine is in a European Azure region, its artifacts will be processed in Qualys' European data center. Artifacts for virtual machines located elsewhere are sent to the US data center.


## Automate at-scale deployments

> [!NOTE]
> All of the tools described in this section are available from [Security Center's GitHub community repository](https://github.com/Azure/Azure-Security-Center/blob/master/README.md). There, you can find scripts, automations, and other useful resources to use throughout your ASC deployment.
>
> Some of these tools only affect new machines connected after you enable at scale deployment. Others also deploy to existing machines. You can combine multiple approaches.

Some of the ways you can automate deployment at scale of the integrated scanner:

- **Azure Resource Manager** – This method is available from **view recommendation logic** in the Azure portal. The remediation script includes the relevant ARM template you can use for your automation:
    :::image type="content" source="./media/deploy-vulnerability-assessment-vm/deploy-at-scale-remediation-logic.png" alt-text="The remediation script includes the relevant ARM template you can use for your automation." lightbox="./media/deploy-vulnerability-assessment-vm/deploy-at-scale-remediation-logic.png":::
- **DeployIfNotExists policy** – [A custom policy](https://github.com/Azure/Azure-Security-Center/tree/master/Remediation%20scripts/Enable%20the%20built-in%20vulnerability%20assessment%20solution%20on%20virtual%20machines%20(powered%20by%20Qualys)/Azure%20Policy) for ensuring all newly created machines receive the scanner. Select **Deploy to Azure** and set the relevant parameters. You can assign this policy at the level of resource groups, subscriptions, or management groups.
- **PowerShell Script** – Use the ```Update qualys-remediate-unhealthy-vms.ps1``` script to deploy the extension for all unhealthy virtual machines. To install on new resources, automate the script with [Azure Automation](../automation/automation-intro.md). The script finds all unhealthy machines discovered by the recommendation and executes an Azure Resource Manager call.
- **Azure Logic Apps** – Build a logic app based on [the sample app](https://github.com/Azure/Azure-Security-Center/tree/master/Workflow%20automation/Install-VulnAssesmentAgent). Use Security Center's [workflow automation](workflow-automation.md) tools to trigger your logic app to deploy the scanner whenever the **A vulnerability assessment solution should be enabled on your virtual machines** recommendation is generated for a resource.
- **REST API** – To deploy the integrated vulnerability assessment solution using Security Center's REST API, make a PUT request for the following URL and add the relevant resource ID: ```https://management.azure.com/<resourceId>/providers/Microsoft.Security/serverVulnerabilityAssessments/default?api-Version=2015-06-01-preview​```



## Trigger an on-demand scan

You can trigger an on-demand scan from the machine itself, using locally or remotely executed scripts or Group Policy Object (GPO). Alternatively, you can integrate it into your software distribution tools at the end of a patch deployment job. 

The following commands trigger an on-demand scan:

- **Windows machines**: ```REG ADD HKLM\SOFTWARE\Qualys\QualysAgent\ScanOnDemand\Vulnerability /v "ScanOnDemand" /t REG_DWORD /d "1" /f```
- **Linux machines**: ```sudo /usr/local/qualys/cloud-agent/bin/cloudagentctl.sh action=demand type=vm```

## FAQ - Integrated vulnerability scanner (powered by Qualys)

### Are there any additional charges for the Qualys license?
No. The built-in scanner is free to all Azure Defender users. The recommendation deploys the scanner with its licensing and configuration information. No additional licenses are required. 

### What prerequisites and permissions are required to install the Qualys extension?
You'll need write permissions for any machine on which you want to deploy the extension.

The Azure Security Center vulnerability assessment extension (powered by Qualys), like other extensions, runs on top of the Azure Virtual Machine agent. So it runs as Local Host on Windows, and Root on Linux.

During setup, Security Center checks to ensure that the machine can communicate with the following two Qualys data centers (via port 443 - the default for HTTPS):

- `https://qagpublic.qg3.apps.qualys.com` - Qualys' US data center
- `https://qagpublic.qg2.apps.qualys.eu` - Qualys' European data center

The extension doesn't currently accept any proxy configuration details.

### Can I remove the Security Center Qualys extension? 
If you want to remove the extension from a machine, you can do it manually or with any of your programmatic tools. 

You'll need the following details:

* On Linux, the extension is called "LinuxAgent.AzureSecurityCenter" and the publisher name is "Qualys"
* On Windows, the extension is called "WindowsAgent.AzureSecurityCenter" and the provider name is "Qualys"

### How does the extension get updated?
Like the Azure Security Center agent itself and all other Azure extensions, minor updates of the Qualys scanner might automatically happen in the background. All agents and extensions are tested extensively before being automatically deployed.

### Why does my machine show as "not applicable" in the recommendation?
The recommendation details page groups your machines into the following lists: **healthy**, **unhealthy**, and **not applicable**.

If you have machines in the **not applicable** resources group, it means Security Center can't deploy the vulnerability scanner extension on those machines.

Your machine might be in this tab because:

- It's not protected by Azure Defender - As explained above, the vulnerability scanner included with Azure Security Center is only available for machines protected by [Azure Defender for servers](defender-for-servers-introduction.md).

- It's an image in an AKS cluster or part of a virtual machine scale set - This extension doesn't support VMs that are PaaS resources.

- It's not running one of the supported operating systems:

    | **Vendor** | **OS** | **Supported versions** |
    |----|----|----|
    |Microsoft|Windows|All|
    |Red Hat|Enterprise Linux|5.4+, 6, 7.0-7.8, 8.0-8.1|
    |Red Hat|CentOS|5.4+, 6, 7.0-7.7, 8.0-8.1|
    |Red Hat|Fedora|22-31|
    |SUSE|Linux Enterprise Server (SLES)|11, 12, 15|
    |SUSE|OpenSUSE|12, 13, 15.0-15.2|
    |SUSE|Leap|42.1|
    |Oracle|Enterprise Linux|5.11, 6, 7.0-7.5|
    |Debian|Debian|7.x-10.x|
    |Ubuntu|Ubuntu|12.04 LTS, 14.04 LTS, 15.x, 16.04 LTS, 18.04 LTS, 19.10, 20.04 LTS|
    ||||

### What is scanned by the built-in vulnerability scanner?
The scanner runs on your machine to look for vulnerabilities of the machine itself. From the machine, it can't scan your network.

### Does the scanner integrate with my existing Qualys console?
The Security Center extension is a separate tool from your existing Qualys scanner. Licensing restrictions mean that it can only be used within Azure Security Center.

### Microsoft Defender for Endpoint also includes Threat & Vulnerability Management (TVM). How is this Azure Defender vulnerability assessment extension different?
We're actively developing a world-class vulnerability management service with the Microsoft Defender for Endpoint's Threat & Vulnerability Management solution, built into Windows.

Today, Azure Security Center's vulnerability assessment extension is powered by Qualys. The extension also benefits from Qualys's own knowledge of vulnerabilities that don't yet have CVEs.

### How quickly will the scanner identify newly disclosed critical vulnerabilities?
Within 48 hrs of the disclosure of a critical vulnerability, Qualys incorporates the information into their processing and can identify affected machines.



## Next steps

> [!div class="nextstepaction"]
> [Remediate the findings from your vulnerability assessment solution](remediate-vulnerability-findings-vm.md)

Security Center also offers vulnerability analysis for your:

- SQL databases - see [Explore vulnerability assessment reports in the vulnerability assessment dashboard](defender-for-sql-on-machines-vulnerability-assessment.md#explore-vulnerability-assessment-reports)
- Azure Container Registry images - see [Use Azure Defender for container registries to scan your images for vulnerabilities](defender-for-container-registries-usage.md)
