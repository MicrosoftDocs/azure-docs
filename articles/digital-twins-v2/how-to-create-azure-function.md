---
# Mandatory fields.
title: Create an Azure Function for Azure Digital Twins
titleSuffix: Azure Digital Twins
description: See how to create an Azure Function that can access and be triggered by Azure digital twins.
author: cschorm
ms.author: cschorm # Microsoft employees only
ms.date: 3/17/2020
ms.topic: how-to
ms.service: digital-twins

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.reviewer: MSFT-alias-of-reviewer
# manager: MSFT-alias-of-manager-or-PM-counterpart
---

# Create Azure Functions apps for Azure Digital Twins

This article walks you through creating an [Azure Function](../azure-functions/functions-overview.md) for use with Azure Digital Twins. Here is a quick look of the steps it contains:

1. Create an Azure Function app in Visual Studio
2. Write an Azure Function with an Event Grid trigger
3. Add authentication code to the function to be able to access Azure Digital Twins 
4. Deploy the function app to Azure
5. Set up security access. In order for the Azure Function to receive an access token at runtime to access the service, you need to configure Managed Service Identity for the function app.
6. Subscribe the Azure Function to Event Grid. This endpoint could be:
    * An Event Grid endpoint attached to Azure Digital Twins to process messages coming from Azure Digital Twins itself (such as property change messages, telemetry messages generated by twins in the tree, or life-cycle messages)
    * The IoT system topics used by IoT Hub to send telemetry and other device events
    * An Event Grid endpoint receiving messages from other services

## Create an Azure Functions app with Visual Studio

In Visual Studio 2019, select *File > New Project*.

[![Visual Studio: new project](media/how-to-create-azure-function/vs-new-azfn-project.png)](media/how-to-create-azure-function/vs-new-azfn-project.png)

Search for the Azure Functions template and press "Next".

[![Visual Studio: configure project](media/how-to-create-azure-function/vs-azfn-project-config.png)](media/how-to-create-azure-function/vs-azfn-project-config.png)

Specify a name for the function app and press "Create"

Select the Event Grid trigger and press "Create".

[![Visual Studio: project trigger](media/how-to-create-azure-function/vs-azfn-project-trigger.png)](media/how-to-create-azure-function/vs-azfn-project-trigger.png)

## Function app code

The generated Azure Function will look like this: 

```csharp
// Default URL for triggering Event Grid function in the local environment
// http://localhost:7071/runtime/webhooks/EventGrid?functionName={functionname}
using System;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Host;
using Microsoft.Azure.EventGrid.Models;
using Microsoft.Azure.WebJobs.Extensions.EventGrid;
using Microsoft.Extensions.Logging;

namespace adtIngestFunctionSample
{
    public static class Function1
    {
        [FunctionName("Function1")]
        public static void Run([EventGridTrigger]EventGridEvent eventGridEvent, ILogger log)
        {
            log.LogInformation(eventGridEvent.Data.ToString());
        }
    }
}
```

### Run and debug the function app

You can now compile and run the Azure Function. While Azure functions are ultimately intended to run in the cloud, you can also run and debug Azure functions locally.

For more information about this, see [Debug Event Grid trigger locally](../azure-functions/functions-debug-event-grid-trigger-local.md).

### Add the Azure Digital Twins SDK to your function app

Visit [Use the Azure Digital Twins APIs](how-to-use-apis.md) to see how to generate the Azure Digital Twins SDK using AutoRest, and compile it as a reusable project.

To be able to access Azure Digital Twins from your Azure Function, add the Azure Digital Twins SDK project to the function app. You can do that by right-selecting *Dependencies* in the Solution Explorer and choosing *Add Reference...*.

Alternatively, you can also add the generated code from AutoRest directly to the function app project.

Once you have added a reference to the project or added the classes, you can access the Azure Digital Twins API after adding the following line to your project:

```csharp
using Azure Digital TwinsApi;
```

### Set up authentication against Azure Digital Twins

First, add: 
* The Azure Digital Twins app ID
* The URL for your Azure Digital Twins instance 
* A variable to hold your Azure Digital Twins client instance to the function project

Also change the function signature to be asynchronous.

```csharp
namespace adtIngestFunctionSample
{
    public static class Function1
    {
        const string AdtAppId = "0b07f429-9f4b-4714-9392-cc5e8e80c8b0";
        const string AdtInstanceUrl = "<your-Azure-Digital-Twins-instance-URL>";
        static AzureDigitalTwinsAPIClient client;

        [FunctionName("Function1")]
        public static async Task Run([EventGridTrigger]EventGridEvent eventGridEvent, ILogger log)
        {
            log.LogInformation(eventGridEvent.Data.ToString());
        }
    }
}
```

Next, add an authentication function:
```csharp
public async static Task Authenticate(ILogger log)
{
    var azureServiceTokenProvider = new AzureServiceTokenProvider();
    string accessToken = await azureServiceTokenProvider.GetAccessTokenAsync(AdtAppId);

    var wc = new System.Net.Http.HttpClient();
    wc.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);

    try
    {
        TokenCredentials tk = new TokenCredentials(accessToken);
        client = new AzureDigitalTwinsAPIClient(tk)
        {
            BaseUri = new Uri(AdtInstanceUrl)
        };
        log.LogInformation($"Azure Digital Twins client connection created.");
    }
    catch (Exception e)
    {
        log.LogError($"Azure Digital Twins client connection failed.");
    }
}
```

The complete example:
```csharp
// Default URL for triggering Event Grid function in the local environment
// http://localhost:7071/runtime/webhooks/EventGrid?functionName={functionname}
using System;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Host;
using Microsoft.Azure.EventGrid.Models;
using Microsoft.Azure.WebJobs.Extensions.EventGrid;
using Microsoft.Extensions.Logging;
using Azure Digital TwinsApi;
using System.Threading.Tasks;
using Microsoft.Azure.Services.AppAuthentication;
using System.Net.Http.Headers;
using Microsoft.Rest;

namespace adtIngestFunctionSample
{
    public static class Function1
    {
        const string AdtAppId = "0b07f429-9f4b-4714-9392-cc5e8e80c8b0";
        const string AdtInstanceUrl = "<your-Azure-Digital-Twins-instance-URL>";
        static AzureDigitalTwinsAPIClient client;

        [FunctionName("Function1")]
        static async Task Run([EventGridTrigger]EventGridEvent eventGridEvent, ILogger log)
        {
            await Authenticate(log);
            log.LogInformation(eventGridEvent.Data.ToString());
            if (client!=null)
            {
                // Add your code here
            }
        }

        public async static Task Authenticate(ILogger log)
        {
            var azureServiceTokenProvider = new AzureServiceTokenProvider();
            string accessToken = await azureServiceTokenProvider.GetAccessTokenAsync(AdtAppId);

            var wc = new System.Net.Http.HttpClient();
            wc.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", accessToken);

            try
            {
                TokenCredentials tk = new TokenCredentials(accessToken);
                client = new AzureDigitalTwinsAPIClient(tk)
                {
                    BaseUri = new Uri(AdtInstanceUrl)
                };
                log.LogInformation($"Azure Digital Twins client connection created.");
            }
            catch (Exception e)
            {
                log.LogError($"Azure Digital Twins client connection failed.");
            }
        }
    }
}
```

### Publish the function app

To publish the function app to Azure, right-select the function project (not the solution) in Solution Explorer and choose *Publish()*.

The following tab will appear:

[![Visual Studio: publish function](media/how-to-create-azure-function/vs-azfn-publish.png)](media/how-to-create-azure-function/vs-azfn-publish.png)

Select the desired Azure Functions plan (if in doubt, start out using the default consumption plan).

>[!IMPORTANT] 
>Publishing an Azure Function will incur additional charges on your subscription, independent of Azure Digital Twins.

[![Visual Studio: publish function 2](media/how-to-create-azure-function/vs-azfn-publish2.png)](media/how-to-create-azure-function/vs-azfn-publish2.png)

On the following page, enter the desired name for the new function app, a resource group, and other details.

## Set up security

The Azure function skeleton shown above requires a bearer token to be passed to it in order to be able to authenticate with Azure Digital Twins. To make sure that this bearer token is passed, you need to set up [Managed Service Identity (MSI)](../active-directory/managed-identities-azure-resources/overview.md) for the function app. This only needs to be done once for each function app.

To set this up, go to the portal and navigate to your function app.

[![Visual Studio: function MSI](media/how-to-create-azure-function/vs-azfn-msi1.png)](media/how-to-create-azure-function/vs-azfn-msi1.png)

In the *Platform features* tab, select *Identity*:

[![Visual Studio: function MSI 2](media/how-to-create-azure-function/vs-azfn-msi2.png)](media/how-to-create-azure-function/vs-azfn-msi2.png)

On the identity page, set the *Status* toggle to *On*. 

### Access roles

Because Azure Digital Twins uses role-based access control to manage access (see [Secure Azure Digital Twins solutions](concepts-security.md) for more information on this), you also need to add a role for each function that you want to allow to access Azure Digital Twins.

To assign a role, you need the resource ID of the Azure Digital Twins instance you have created. If you did not record it earlier when you created your instance, you can retrieve it using this command:
```bash
az dt show --name <your-instance-name> -g <your-resource-group-name>
```

The output will contain a long string named "id" that will begin with the letters "/subscriptions/â€¦". Use that string in the command below: 
```bash
az role assignment create --role "Azure Digital Twins Owner (Preview)" --assignee <ID-for-your-function> --scope <resource-instance-ID>
```

## Next steps

Read more about roles and security in Azure Digital Twins:
* [Secure Azure Digital Twins solutions](concepts-security.md)

See how to use an Azure Function to ingest IoT Hub data into Azure Digital Twins:
* [Ingest telemetry from IoT Hub](how-to-ingest-iot-hub-data.md)