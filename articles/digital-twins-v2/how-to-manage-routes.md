---
# Mandatory fields.
title: Manage endpoints and routes
titleSuffix: Azure Digital Twins
description: See how to set up and manage endpoints and event routes for Azure Digital Twins data.
author: cschormann
ms.author: cschorm # Microsoft employees only
ms.date: 3/17/2020
ms.topic: how-to
ms.service: digital-twins

# Optional fields. Don't forget to remove # if you need a field.
# ms.custom: can-be-multiple-comma-separated
# ms.reviewer: MSFT-alias-of-reviewer
# manager: MSFT-alias-of-manager-or-PM-counterpart
---

# Work with endpoints and routes in Azure Digital Twins

In Azure Digital Twins, you use **endpoints** to route data to downstream services, or to connect to compute resources. You can then define **event routes** to specify which events generated by Azure Digital Twins are delivered to which endpoints.

Supported endpoint types include:
* [Event Hub](../event-hubs/event-hubs-about.md)
* [Event Grid](../event-grid/overview.md)
* [Service Bus](../service-bus-messaging/service-bus-messaging-overview.md)

See [Choose between Azure messaging services](https://docs.microsoft.com/azure/event-grid/compare-messaging-services) for more information on the different endpoints.

## Link an endpoint to Azure Digital Twins

To link an endpoint to Azure Digital Twins, the Event Hub, Event Grid topic, or Service Bus that you're using for the endpoint needs to exist already. 

The following example shows how to create an Event Grid topic using the Azure CLI:

```Azure CLI
az eventgrid topic create -g <your-resource-group-name> --name <your-topic-name> -l "westcentralus"
```

Once you have created the topic, you can link it to Azure Digital Twins with the following command:

```Azure CLI
az dt endpoints add eventgrid --endpoint-name <Event-Grid-endpoint-name> --eventgrid-resource-group <Event-Grid-resource-group-name> --eventgrid-topic <your-Event-Grid-topic-name> -n <your-Azure-Digital-Twins-instance-name>
```

This makes the Event Grid topic available inside of Azure Digital Twins, under the name specified with the `--endpoint-name` argument. You will typically use that name as the target of an **event route**, which you'll create in the next section using the Azure Digital Twins service API.

Equivalent commands exist for Event Hub and Service Bus endpoints:

* Add Service Bus Topic endpoint (requires a pre-created Service Bus resource)
```Azure CLI 
az dt endpoints add servicebus --endpoint-name <Service-Bus-endpoint-name> --servicebus-resource-group <Service-Bus-resource-group-name> --servicebus-namespace <Service-Bus-namespace> --servicebus-topic <Service-Bus-topic-name> --servicebus-policy <Service-Bus-topic-policy> -n <your-Azure-Digital-Twins-instance-name>
```

* Add Event Hub endpoint (requires pre-created Event Hub resource)
```Azure CLI
az dt endpoints add eventhub --endpoint-name <Event-Hub-endpoint-name> --eventhub-resource-group <Event-Hub-resource-group> --eventhub-namespace <Event-Hub-namespace> --eventhub <Event-Hub-name> --eventhub-policy <Event-Hub-policy> -n <your-Azure-Digital-Twins-instance-name>
```

## Manage event routes with APIs

To actually send data from Azure Digital Twins to an endpoint, you need to define an event route. Azure Digital Twins **EventRoutes APIs** let developers wire up event flow, throughout the system and to downstream services. Read more about event routes in [Route Azure Digital Twins events to external services](concepts-route-events.md).

[!INCLUDE [digital-twins-generate-sdk.md](../../includes/digital-twins-generate-sdk.md)]

Event routes are defined using data plane APIs. A route definition can contain these elements:
* The route ID you want to use
* The ID of the endpoint you want to use
* A filter that defines which events are sent to the endpoint 

If there is no route ID, no messages are routed outside of Azure Digital Twins. 
If there is a route ID and the filter is `null`, all messages are routed to the endpoint. 
If there is a route ID and a filter is added, messages will be filtered based on the filter.

One route should allow multiple notifications and event types to be selected. 

Here is the call to the SDK that is used to add an event route:

```csharp
await client.EventRoutes.AddAsync("routeName", new EventRoute("endpointID"));
```

> [!TIP]
> All SDK functions come in synchronous and asynchronous versions.

### Event route sample code

The following code sample shows how to create, list and delete an event route:
```csharp
try
{
    Log("Create a route: testRoute1");
    EventRoute er = new EventRoute(<your-endpoint-name>,true);
    await client.EventRoutes.AddAsync(<your-route-name>, er);
    Log("Create route succeeded. Now listing routes:");
    List<EventRoute> routes = await ListRoutes();
    Log("Deleting routes:");
    foreach (EventRoute r in routes)
    {
        Log($"Deleting route {r.Id}:");
        await client.EventRoutes.DeleteAsync(r.Id);
        Log("Delete route succeeded."); 
    }
}
catch (ErrorResponseException e)
{
    Console.WriteLine($"*** Error in event route creation ({e.Request.RequestUri}):\n${e.Response.StatusCode}\n${e.Response.ReasonPhrase}");
}
```

The `ListRoutes` routine used by the code above is defined as follows:

```csharp
static async Task<List<EventRoute>> ListRoutes()
{
    List<EventRoute> evList = new List<EventRoute>();
    // Find the relationships for the twin
    try
    {
        
        // Enumerate the IPage object returned to get the results
        // ListAsync will throw if an error occurs
        IPage<EventRoute> evPage = await client.EventRoutes.ListAsync();
        evList.AddRange(evPage);
        // If there are more pages, the NextPageLink in the page is set
        while (evPage.NextPageLink != null)
        {
            // Get more pages...
            evPage = await client.EventRoutes.ListNextAsync(evPage.NextPageLink);
            evList.AddRange(evPage);
        }
        Console.WriteLine($"Found {evList.Count} event routes");
        // Let's delete the edges we found
        foreach (EventRoute r in evList)
        {
            Log($"Found route {r.Id} to {r.EndpointId}");
        }
    }
    catch (ErrorResponseException e)
    {
        Log($"*** Error retrieving event routes: {e.Response.StatusCode}", ConsoleColor.Red);
    }
    return evList;
}
``` 

### Filter events

Without filtering, endpoints receive a variety of events from Azure Digital Twins:
* Telemetry fired by twins using the Azure Digital Twins service API
* Twin property change notifications, fired on property changes for any twin in the Azure Digital Twins instance
* Life-cycle events, fired when twins or relationships are created or deleted
* Model change events, fired when models configured in an Azure Digital Twins instance are added or deleted

You can restrict these by adding a filter to an endpoint.

To add a filter, you can use a PUT request to *https://{YourHost}/ EventRoutes/myNewRoute?api-version=2020-03-01-preview* with the following body:

```json  
{
    "endpointId": "<endpoint-ID>",
    "filter": "<filter-text>"
}
``` 

Here are the types of filter that you can use:

| Filter name | Description | Filter text |
| --- | --- | --- |
| Type |  | "filter": "type = '…'" |
| Source |  | "filter": " source = '…'" |
| Subject |  | "filter": " subject = '…'" |
| ID |  | "filter": "id = '…'" |
| Schema |  | "filter": "dataschema = '…'" |
| Content type |  | "filter": "datacontenttype = '…'" |
| Spec version |  | "filter": "specversion = '…'" |
| Type/subject combination |  | "filter": "type = '…' AND subject != '…'" |
| Type/type combination |  | "filter": "type = '…' OR type = '…'" |
| Type/subject/source/id combination |  | "filter": "(type = '…' AND subject = '…') OR (source = '…' AND id = '…')" |
| True |  | "filter": "true" |
| False |  | "filter": "false |

> [!NOTE]
> During preview, only string equality is supported (=, !=).

When you implement or update a filter, the change may take a few minutes to be reflected in the data pipeline.

## Manage endpoints and routes with CLI

Endpoints and routes can also be managed using the Azure Digital Twins CLI. The commands for this can be found in [Use the Azure Digital Twins CLI](how-to-use-digital-twins-cli.md).

## Next steps

Read about the different types of event messages you can receive:
* [Understand event data](how-to-interpret-event-data.md)
